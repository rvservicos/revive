<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ReVive - Vendas e Cultura</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- ESTILOS GERAIS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%); min-height: 100vh; color: #333; overflow-x: hidden; }
        .main-container { max-width: 98%; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; background: white; padding: 30px; border-radius: 26px; box-shadow: 0 10px 42px rgba(147, 51, 234, 0.1); border: 1px solid rgba(147, 51, 234, 0.1); position: relative; overflow: hidden; }
        .header::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 7px; background: linear-gradient(90deg, #8b5cf6, #6b46c1, #a78bfa); }
        .header h1 { color: #6b46c1; font-size: 3rem; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 20px; }
        .header h1 i { background: linear-gradient(135deg, #8b5cf6, #6b46c1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header .subtitle { color: #8b5cf6; font-size: 1.3rem; opacity: 0.8; }

        /* --- DASHBOARD ESTATUS --- */
        .connection-status { margin: 20px auto; padding: 10px 20px; border-radius: 13px; font-size: 1.1rem; font-weight: 500; display: inline-flex; align-items: center; gap: 10px; }
        .status-connected { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .status-error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .status-loading { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }

        /* --- GRID DE 3 COLUNAS (SC, CE, MG) --- */
        .stats-grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 39px;
        }
        
        .stats-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stat-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(147, 51, 234, 0.05); transition: transform 0.3s ease; position: relative; overflow: hidden; }
        .stat-card h3 { color: #6b46c1; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .stat-value { font-size: 2rem; font-weight: 700; color: #8b5cf6; display: flex; align-items: center; gap: 15px; }
        .stat-label { color: #a78bfa; font-size: 0.9rem; }

        /* CORES ESPECÍFICAS POR ESTADO */
        /* Ceará (Verde) */
        .stat-card-ce h3 { color: #10b981 !important; }
        .stat-card-ce .stat-value { color: #10b981 !important; }
        .stat-card-ce .stat-label { color: #34d399 !important; }
        
        /* Minas Gerais (Laranja/Dourado) */
        .stat-card-mg h3 { color: #f59e0b !important; }
        .stat-card-mg .stat-value { color: #f59e0b !important; }
        .stat-card-mg .stat-label { color: #fbbf24 !important; }

        /* --- LAYOUTS DE CONTEÚDO --- */
        .rankings-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 26px; }
        .sales-lists-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 39px; }

        .panel { background: white; border-radius: 26px; padding: 25px; box-shadow: 0 10px 42px rgba(147, 51, 234, 0.1); display: flex; flex-direction: column; }
        .panel.full-width { grid-column: 1 / -1; }
        
        .panel-sc { border-top: 4px solid #8b5cf6; }
        .panel-ce { border-top: 4px solid #10b981; }
        .panel-mg { border-top: 4px solid #f59e0b; }

        .panel h2 { color: #6b46c1; font-size: 1.6rem; margin-bottom: 20px; font-weight: 600; padding-bottom: 10px; border-bottom: 2px solid #f3f4f6; display: flex; align-items: center; gap: 10px; }
        .panel-ce h2 { color: #10b981; }
        .panel-mg h2 { color: #f59e0b; }

        /* --- TABELAS E LISTAS --- */
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f3f4f6; }
        .consultant-info { display: flex; align-items: center; gap: 15px; }
        
        .rank-number { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.1rem; flex-shrink: 0; }
        .rank-number-ce { background: linear-gradient(135deg, #10b981, #34d399); }
        .rank-number-mg { background: linear-gradient(135deg, #f59e0b, #fbbf24); }

        .consultant-name { color: #374151; font-weight: 500; font-size: 1.1rem; }
        .sales-count { background: #e8ecff; color: #6b46c1; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 1.1rem; }
        
        /* Botão Expandir */
        .ranking-list-container { transition: max-height 0.7s ease-in-out; overflow: hidden; }
        .ranking-list-container.collapsed { max-height: 350px; }
        .expand-ranking-btn { display: block; width: 100%; margin-top: 15px; padding: 10px; border-radius: 10px; border: 2px solid #e8ecff; background-color: #f8f9ff; color: #6b46c1; font-weight: 600; cursor: pointer; text-align: center; }
        .expand-ranking-btn:hover { background-color: #e8ecff; }
        
        .expand-ranking-btn.btn-ce { color: #10b981; border-color: #d1fae5; background-color: #f0fdf4; }
        .expand-ranking-btn.btn-ce:hover { background-color: #d1fae5; }
        
        .expand-ranking-btn.btn-mg { color: #f59e0b; border-color: #fef3c7; background-color: #fffbeb; }
        .expand-ranking-btn.btn-mg:hover { background-color: #fef3c7; }

        /* Tabelas de Vendas */
        .sales-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 1.1rem; }
        .sales-table th { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; padding: 15px; text-align: left; font-weight: 700; }
        .sales-table th.th-ce { background: linear-gradient(135deg, #10b981, #34d399); }
        .sales-table th.th-mg { background: linear-gradient(135deg, #f59e0b, #fbbf24); }
        .sales-table td { padding: 15px; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .sales-table tr:nth-child(even) { background-color: #f9fafb; }

        /* Fotos */
        .consultant-photo-ranking { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #e8ecff; }
        .top-photo { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; margin-left: 15px; display: none; transition: transform 0.3s; }
        .stat-card:hover .top-photo { transform: scale(1.1); }
        #topConsultantPhoto { border: 4px solid #a78bfa; background: #f0f2ff; }
        #topConsultantPhotoCE { border: 4px solid #10b981; background: #d1fae5; }
        #topConsultantPhotoMG { border: 4px solid #f59e0b; background: #fef3c7; }

        /* Badges */
        .process-badge, .date-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; display: inline-block; }
        .process-badge { background: #e8ecff; color: #6b46c1; }
        .date-badge { background: #f3f4f6; color: #6b7280; }

        /* Filtros e Controles */
        .month-selector { background: white; padding: 15px; border-radius: 20px; margin-bottom: 26px; box-shadow: 0 5px 16px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .month-selector select { padding: 8px 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1.1rem; }
        
        .carousel-page { display: none; animation: fadeIn 0.5s ease-in-out forwards; }
        .carousel-page.active { display: block; }
        @keyframes fadeIn { to { opacity: 1; } }

        /* Responsividade */
        @media (max-width: 1200px) {
            .stats-grid-container, .rankings-grid, .sales-lists-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2rem; }
        }

        /* Notificação */
        #sale-notification-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(29, 13, 51, 0.85); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .notification-content { background: white; padding: 40px; border-radius: 30px; text-align: center; width: 90%; max-width: 600px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .notification-photo { width: 120px; height: 120px; border-radius: 50%; border: 5px solid #8b5cf6; margin-bottom: 20px; object-fit: cover; }
    </style>
</head>
<body>
    <div class="main-container">
        
        <!-- DASHBOARD PAGE -->
        <div id="dashboard-view" class="carousel-page active" data-name="Dashboard">
            <div class="header">
                <h1><i class="fas fa-chart-line"></i> Dashboard de Vendas - ReVive</h1>
                <p class="subtitle">Acompanhamento SC, Ceará e Minas Gerais</p>
            </div>
            
            <div class="connection-status" id="connectionStatus" style="margin: 0 auto 20px auto; display:flex; justify-content:center;">
                <i class="fas fa-sync fa-spin"></i><span>Carregando dados...</span>
            </div>

            <div class="month-selector">
                <div>
                    <label><i class="fas fa-calendar"></i> Mês:</label>
                    <select id="monthFilter" onchange="updateDashboard()"></select>
                </div>
                <div>
                    <button id="carousel-toggle" onclick="toggleCarousel()" style="padding:8px 15px; border-radius:8px; border:1px solid #ddd; background:white; cursor:pointer;">
                        <i class="fas fa-pause"></i> Pausar Rotação
                    </button>
                </div>
            </div>
            
            <!-- TOTAL GLOBAL -->
            <div class="stat-card" style="margin-bottom: 26px; text-align: center; border-top: 4px solid #333;">
                <h3 style="justify-content: center;"><i class="fas fa-globe"></i> Total Global (Mês)</h3>
                <div class="stat-value" id="totalMonthGlobal" style="justify-content: center;">-</div>
            </div>

            <!-- GRID DE ESTATÍSTICAS (3 COLUNAS) -->
            <div class="stats-grid-container">
                <!-- Coluna SC -->
                <div class="stats-column">
                    <div class="stat-card">
                        <h3><i class="fas fa-map-marker-alt"></i> Processos (SC)</h3>
                        <div class="stat-value" id="totalMonthSC">-</div>
                        <div class="stat-label">Santa Catarina</div>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-trophy"></i> Top Consultor SC</h3>
                        <div class="stat-value">
                            <span id="topConsultantSC">-</span>
                            <img id="topConsultantPhoto" class="top-photo" src="" alt="Foto">
                        </div>
                    </div>
                </div>
            
                <!-- Coluna CE -->
                <div class="stats-column">
                    <div class="stat-card stat-card-ce">
                        <h3><i class="fas fa-sun"></i> Processos (CE)</h3>
                        <div class="stat-value" id="totalMonthCE">-</div>
                        <div class="stat-label">Ceará</div>
                    </div>
                    <div class="stat-card stat-card-ce">
                        <h3><i class="fas fa-trophy"></i> Top Consultor CE</h3>
                        <div class="stat-value">
                            <span id="topConsultantCE">-</span>
                            <img id="topConsultantPhotoCE" class="top-photo" src="" alt="Foto">
                        </div>
                    </div>
                </div>

                <!-- Coluna MG (NOVA) -->
                <div class="stats-column">
                    <div class="stat-card stat-card-mg">
                        <h3><i class="fas fa-mountain"></i> Processos (MG)</h3>
                        <div class="stat-value" id="totalMonthMG">-</div>
                        <div class="stat-label">Minas Gerais</div>
                    </div>
                    <div class="stat-card stat-card-mg">
                        <h3><i class="fas fa-trophy"></i> Top Consultor MG</h3>
                        <div class="stat-value">
                            <span id="topConsultantMG">-</span>
                            <img id="topConsultantPhotoMG" class="top-photo" src="" alt="Foto">
                        </div>
                    </div>
                </div>
            </div>

            <!-- RANKINGS (3 COLUNAS) -->
            <div class="rankings-grid">
                <!-- Ranking SC -->
                <div class="panel panel-sc">
                    <h2><i class="fas fa-medal"></i> Ranking SC</h2>
                    <div id="rankingSC"></div>
                </div>
                <!-- Ranking CE -->
                <div class="panel panel-ce">
                    <h2><i class="fas fa-medal"></i> Ranking CE</h2>
                    <div id="rankingCE"></div>
                </div>
                <!-- Ranking MG -->
                <div class="panel panel-mg">
                    <h2><i class="fas fa-medal"></i> Ranking MG</h2>
                    <div id="rankingMG"></div>
                </div>
            </div>

            <!-- LISTAS DE VENDAS RECENTES (3 COLUNAS) -->
            <div class="sales-lists-grid">
                <!-- Lista SC -->
                <div class="panel panel-sc">
                    <h2><i class="fas fa-clock"></i> Recentes SC</h2>
                    <div style="overflow-x:auto;">
                        <table class="sales-table">
                            <thead><tr><th>Data</th><th>Cliente</th><th>Processo</th><th>Consultor</th></tr></thead>
                            <tbody id="tableSC"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Lista CE -->
                <div class="panel panel-ce">
                    <h2><i class="fas fa-clock"></i> Recentes CE</h2>
                    <div style="overflow-x:auto;">
                        <table class="sales-table">
                            <thead><tr><th class="th-ce">Data</th><th class="th-ce">Cliente</th><th class="th-ce">Processo</th><th class="th-ce">Consultor</th></tr></thead>
                            <tbody id="tableCE"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Lista MG -->
                <div class="panel panel-mg">
                    <h2><i class="fas fa-clock"></i> Recentes MG</h2>
                    <div style="overflow-x:auto;">
                        <table class="sales-table">
                            <thead><tr><th class="th-mg">Data</th><th class="th-mg">Cliente</th><th class="th-mg">Processo</th><th class="th-mg">Consultor</th></tr></thead>
                            <tbody id="tableMG"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PÁGINA GRÁFICOS (SIMPLIFICADA PARA EXEMPLO) -->
        <div id="chart-view" class="carousel-page" data-name="Gráficos">
            <div class="header"><h1><i class="fas fa-chart-area"></i> Evolução Anual</h1></div>
            <div class="panel"><div style="height:500px;"><canvas id="evolutionChart"></canvas></div></div>
        </div>

    </div>

    <!-- NOTIFICAÇÃO DE VENDA -->
    <div id="sale-notification-overlay">
        <div class="notification-content">
            <img id="notif-photo" src="" class="notification-photo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NkZGFmYiI+PHBhdGggZD0iTTEyIDJBNCA0IDAgMCAwIDggNkE0IDQgMCAwIDAgMTIgMTBBNCA0IDAgMCAwIDE2IDZBNCA0IDAgMCAwIDEyIDJ6bTAgMTBDOC4xMyAxMiA0IDEzLjc5IDQgMTd2M2g4di0zYzAtMS42NiAxLjM0LTMgMy0zaDEuNjlBMy4wMDIgMy4wMDIgMCAwIDEgMTYgMTRjMS42NiAwIDMgMS4zNCAzIDN2M2gydi0zYzAtMy4yMS00LjEzLTUtOC01eiIvPjwvc3ZnPg==';">
            <h2 id="notif-title" style="color:#6b46c1; margin-bottom:10px;">Nova Venda!</h2>
            <p id="notif-msg" style="font-size:1.4rem; color:#555;"></p>
            <div id="notif-extra" style="margin-top:20px; font-weight:bold; color:#8b5cf6; font-size:1.2rem;"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        // --- CONFIGURAÇÃO ---
        const SHEET_ID = "1fSTEyMmAEgfMnAFUTdYbJah5dr8OudsEsqjKHnHwFms";
        const SALES_GID = "1536647709"; // Aba Geral (SC + MG)
        const CEARA_GID = "1480007459"; // Aba Ceará
        
        let salesSC = [];
        let salesMG = [];
        let salesCE = [];
        let allSalesHistory = []; // Para notificações
        
        let chartInstance = null;
        let isCarouselPaused = false;
        let currentPage = 0;
        const pages = document.querySelectorAll('.carousel-page');
        const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NkZGFmYiI+PHBhdGggZD0iTTEyIDJBNCA0IDAgMCAwIDggNkE0IDQgMCAwIDAgMTIgMTBBNCA0IDAgMCAwIDE2IDZBNCA0IDAgMCAwIDEyIDJ6bTAgMTBDOC4xMyAxMiA0IDEzLjc5IDQgMTd2M2g4di0zYzAtMS42NiAxLjM0LTMgMy0zaDEuNjlBMy4wMDIgMy4wMDIgMCAwIDEgMTYgMTRjMS42NiAwIDMgMS4zNCAzIDN2M2gydi0zYzAtMy4yMS00LjEzLTUtOC01eiIvPjwvc3ZnPg==';

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            setInterval(fetchData, 30000); // Atualiza a cada 30s
            setInterval(rotateCarousel, 25000); // Roda página a cada 25s
        });

        // --- BUSCA DE DADOS ---
        async function fetchData() {
            document.getElementById('connectionStatus').className = 'connection-status status-loading';
            document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-sync fa-spin"></i> Atualizando...';

            try {
                // Busca paralela: Geral (SC+MG) e Ceará
                const [resGeral, resCeara] = await Promise.all([
                    fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SALES_GID}&t=${Date.now()}`),
                    fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${CEARA_GID}&t=${Date.now()}`)
                ]);

                if (!resGeral.ok || !resCeara.ok) throw new Error("Erro na conexão com planilhas");

                const txtGeral = await resGeral.text();
                const txtCeara = await resCeara.text();

                // Processa Geral e separa SC de MG pela Coluna F (Index 5)
                const dataGeral = parseCSV(txtGeral);
                
                // Filtra MG se a coluna Unidade (index 5) contiver "MINAS" ou "MG"
                // Importante: parseCSV retorna array de objetos com indices originais
                const tempSC = [];
                const tempMG = [];

                dataGeral.forEach(row => {
                    const unidade = row.unidade ? row.unidade.toUpperCase() : '';
                    if (unidade.includes('MINAS') || unidade.includes('MG')) {
                        tempMG.push(row);
                    } else {
                        // Assume SC se não for MG (ou outra regra se houver mais estados na mesma aba)
                        tempSC.push(row);
                    }
                });

                // Detecta novas vendas para notificação (Comparando comprimento por simplicidade neste exemplo)
                checkNewSales(tempSC, salesSC, 'Santa Catarina');
                checkNewSales(tempMG, salesMG, 'Minas Gerais');
                
                salesSC = tempSC;
                salesMG = tempMG;
                
                // Processa Ceará
                const tempCE = parseCSV(txtCeara);
                checkNewSales(tempCE, salesCE, 'Ceará');
                salesCE = tempCE;

                populateMonthFilter();
                updateDashboard();
                
                document.getElementById('connectionStatus').className = 'connection-status status-connected';
                document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-check"></i> Conectado';

            } catch (err) {
                console.error(err);
                document.getElementById('connectionStatus').className = 'connection-status status-error';
                document.getElementById('connectionStatus').innerHTML = '<i class="fas fa-exclamation-circle"></i> Erro de Conexão';
            }
        }

        // --- PARSER CSV CUSTOMIZADO ---
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(l => l.trim());
            const result = [];
            // Pula cabeçalho (i=1)
            for(let i=1; i<lines.length; i++) {
                // Regex para lidar com vírgulas dentro de aspas
                const cols = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                const cleanCols = lines[i].split(',').map(c => c.replace(/"/g, '').trim()); // Fallback simples
                
                // Mapeamento baseado na descrição do usuário:
                // 0:Processo, 1:Cliente, 3:Data, 4:Consultor, 5:Unidade
                if (cleanCols.length > 4) {
                    const processo = cleanCols[0];
                    if(processo.toUpperCase() === 'CANCELADO') continue;
                    
                    result.push({
                        processo: processo,
                        cliente: cleanCols[1],
                        data: cleanCols[3],
                        consultor: cleanCols[4],
                        unidade: cleanCols[5] || '', // Coluna F
                        originalLine: i
                    });
                }
            }
            return result;
        }

        // --- LÓGICA DO DASHBOARD ---
        function updateDashboard() {
            const selectedMonth = document.getElementById('monthFilter').value;
            if(!selectedMonth && salesSC.length > 0) return;

            // Filtra por mês
            const filterData = (data) => data.filter(d => {
                const dt = parseData(d.data);
                if(!dt) return false;
                const m = `${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`;
                return m === selectedMonth;
            });

            const currentSC = filterData(salesSC);
            const currentCE = filterData(salesCE);
            const currentMG = filterData(salesMG);

            // Atualiza Cards de Totais
            document.getElementById('totalMonthSC').textContent = currentSC.length;
            document.getElementById('totalMonthCE').textContent = currentCE.length;
            document.getElementById('totalMonthMG').textContent = currentMG.length;
            document.getElementById('totalMonthGlobal').textContent = currentSC.length + currentCE.length + currentMG.length;

            // Atualiza Rankings e Tops
            updateRankingAndTop(currentSC, 'rankingSC', 'topConsultantSC', 'topConsultantPhoto', '');
            updateRankingAndTop(currentCE, 'rankingCE', 'topConsultantCE', 'topConsultantPhotoCE', 'ce');
            updateRankingAndTop(currentMG, 'rankingMG', 'topConsultantMG', 'topConsultantPhotoMG', 'mg');

            // Atualiza Tabelas Recentes
            updateTable(currentSC, 'tableSC', '');
            updateTable(currentCE, 'tableCE', 'ce');
            updateTable(currentMG, 'tableMG', 'mg');

            // Atualiza Gráfico (usa dados do ano todo)
            updateChart([...salesSC, ...salesCE, ...salesMG]);
        }

        function updateRankingAndTop(data, listId, topNameId, topPhotoId, type) {
            // Agrupa por consultor
            const counts = {};
            data.forEach(d => {
                const name = d.consultor.split(' ')[0].toUpperCase(); // Primeiro nome
                if(name) counts[name] = (counts[name] || 0) + 1;
            });

            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
            
            // Top Consultor
            const topEl = document.getElementById(topNameId);
            const photoEl = document.getElementById(topPhotoId);
            if (sorted.length > 0) {
                const [name, count] = sorted[0];
                topEl.textContent = `${name} (${count})`;
                photoEl.src = getPhotoUrl(name);
                photoEl.style.display = 'inline-block';
            } else {
                topEl.textContent = '-';
                photoEl.style.display = 'none';
            }

            // Lista Ranking
            const listContainer = document.getElementById(listId);
            let html = `<div id="list-${listId}" class="ranking-list-container ${sorted.length > 5 ? 'collapsed' : ''}">`;
            
            let rankClass = 'rank-number';
            if(type === 'ce') rankClass += ' rank-number-ce';
            if(type === 'mg') rankClass += ' rank-number-mg';

            sorted.forEach(([name, count], index) => {
                html += `
                    <div class="ranking-item">
                        <div class="consultant-info">
                            <div class="${rankClass}">${index+1}</div>
                            <img src="${getPhotoUrl(name)}" class="consultant-photo-ranking" onerror="this.src='${DEFAULT_AVATAR}'">
                            <div class="consultant-name">${name}</div>
                        </div>
                        <div class="sales-count">${count}</div>
                    </div>`;
            });
            html += '</div>';
            
            if(sorted.length > 5) {
                let btnClass = 'expand-ranking-btn';
                if(type === 'ce') btnClass += ' btn-ce';
                if(type === 'mg') btnClass += ' btn-mg';
                
                html += `<button class="${btnClass}" onclick="toggleList('list-${listId}', this)">Ver Mais</button>`;
            }
            
            if(sorted.length === 0) html = '<p style="text-align:center; color:#999; padding:20px;">Sem vendas.</p>';
            
            listContainer.innerHTML = html;
        }

        function updateTable(data, tableId, type) {
            const tbody = document.getElementById(tableId);
            // Ordena por data (mais recente primeiro)
            const sorted = [...data].sort((a,b) => parseData(b.data) - parseData(a.data));
            
            let html = '';
            let badgeClass = 'process-badge';
            // Se quiser mudar a cor do badge por estado, pode usar o 'type' aqui

            sorted.forEach(row => {
                html += `
                    <tr>
                        <td><span class="date-badge">${row.data}</span></td>
                        <td>${row.cliente}</td>
                        <td><span class="${badgeClass}">${row.processo}</span></td>
                        <td>${row.consultor.split(' ')[0]}</td>
                    </tr>
                `;
            });
            if(sorted.length === 0) html = '<tr><td colspan="4" style="text-align:center; padding:15px;">Sem dados</td></tr>';
            tbody.innerHTML = html;
        }

        // --- UTILITÁRIOS ---
        function parseData(dateStr) {
            if(!dateStr) return null;
            const parts = dateStr.split('/');
            if(parts.length === 3) return new Date(parts[2], parts[1]-1, parts[0]);
            return null;
        }

        function getPhotoUrl(name) {
            // Normaliza nome para URL da foto (ex: JOAO -> joao.PNG)
            return name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") + ".PNG";
        }

        function populateMonthFilter() {
            const select = document.getElementById('monthFilter');
            const currentVal = select.value;
            const months = new Set();
            
            [...salesSC, ...salesCE, ...salesMG].forEach(d => {
                const dt = parseData(d.data);
                if(dt) months.add(`${String(dt.getMonth()+1).padStart(2,'0')}/${dt.getFullYear()}`);
            });

            // Ordena meses (Decrescente)
            const sortedMonths = Array.from(months).sort((a,b) => {
                const [ma, ya] = a.split('/');
                const [mb, yb] = b.split('/');
                return new Date(yb, mb) - new Date(ya, ma);
            });

            select.innerHTML = '';
            sortedMonths.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                select.appendChild(opt);
            });

            if(currentVal && sortedMonths.includes(currentVal)) select.value = currentVal;
            else if(sortedMonths.length > 0) select.value = sortedMonths[0]; // Seleciona o mais recente
        }

        function toggleList(id, btn) {
            const el = document.getElementById(id);
            el.classList.toggle('collapsed');
            btn.textContent = el.classList.contains('collapsed') ? 'Ver Mais' : 'Mostrar Menos';
        }

        function checkNewSales(newData, oldData, region) {
            if(oldData.length === 0) return; // Primeira carga ignora
            if(newData.length > oldData.length) {
                // Pega o último item adicionado (simplificação)
                const sale = newData[newData.length - 1];
                showNotification(sale, region);
            }
        }

        function showNotification(sale, region) {
            const overlay = document.getElementById('sale-notification-overlay');
            const title = document.getElementById('notif-title');
            const msg = document.getElementById('notif-msg');
            const extra = document.getElementById('notif-extra');
            const photo = document.getElementById('notif-photo');

            title.textContent = `Nova Venda - ${region}!`;
            msg.innerHTML = `O consultor <strong>${sale.consultor}</strong> fechou contrato com <strong>${sale.cliente}</strong>.`;
            extra.textContent = sale.processo;
            
            const name = sale.consultor.split(' ')[0];
            photo.src = getPhotoUrl(name);

            overlay.style.display = 'flex';
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            
            setTimeout(() => { overlay.style.display = 'none'; }, 8000);
        }

        // --- ROTAÇÃO DE PÁGINAS ---
        function rotateCarousel() {
            if(isCarouselPaused) return;
            pages[currentPage].classList.remove('active');
            currentPage = (currentPage + 1) % pages.length;
            pages[currentPage].classList.add('active');
        }

        function toggleCarousel() {
            isCarouselPaused = !isCarouselPaused;
            const btn = document.getElementById('carousel-toggle');
            btn.innerHTML = isCarouselPaused ? '<i class="fas fa-play"></i> Retomar' : '<i class="fas fa-pause"></i> Pausar';
        }

        function updateChart(allData) {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            const months = {};
            const year = new Date().getFullYear();

            // Inicializa meses
            for(let i=0; i<12; i++) months[i] = 0;

            allData.forEach(d => {
                const dt = parseData(d.data);
                if(dt && dt.getFullYear() === year) {
                    months[dt.getMonth()]++;
                }
            });

            const dataArr = Object.values(months);
            // Corta array até o mês atual
            const currentMonth = new Date().getMonth();
            const finalData = dataArr.slice(0, currentMonth + 1);

            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],
                    datasets: [{
                        label: 'Vendas 2025',
                        data: finalData,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    </script>
</body>
</html>
