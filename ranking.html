<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ReVive - Vendas e Cultura</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- ESTILOS GERAIS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%); min-height: 100vh; color: #333; overflow-x: hidden; }
        .main-container { max-width: 1820px; margin: 0 auto; padding: 26px; }
        .header { text-align: center; margin-bottom: 39px; background: white; padding: 33px; border-radius: 26px; box-shadow: 0 10px 42px rgba(147, 51, 234, 0.1); border: 1px solid rgba(147, 51, 234, 0.1); position: relative; overflow: hidden; }
        .header::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 7px; background: linear-gradient(90deg, #8b5cf6, #6b46c1, #a78bfa); }
        .header h1 { color: #6b46c1; font-size: 3.25rem; font-weight: 700; margin-bottom: 13px; display: flex; align-items: center; justify-content: center; gap: 20px; }
        .header h1 i { background: linear-gradient(135deg, #8b5cf6, #6b46c1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header .subtitle { color: #8b5cf6; font-size: 1.4rem; opacity: 0.8; }

        /* --- ESTILOS DO DASHBOARD --- */
        .connection-status { margin: 20px auto; padding: 13px 20px; border-radius: 13px; font-size: 1.2rem; font-weight: 500; display: inline-flex; align-items: center; gap: 13px; max-width: 390px; }
        .status-connected { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .status-error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .status-loading { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(325px, 1fr)); gap: 26px; margin-bottom: 39px; }
        .stat-card { background: white; padding: 33px; border-radius: 20px; box-shadow: 0 10px 42px rgba(147, 51, 234, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; overflow: hidden; }
        .stat-card h3 { color: #6b46c1; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1.3px; margin-bottom: 13px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .stat-card-ce h3 { 
            color: #10b981 !important; 
        }
        .stat-card-ce .stat-value { 
            color: #10b981 !important; 
        }
        .stat-card-ce .stat-label { 
            color: #34d399 !important; 
        }
        .stat-value { font-size: 3.3rem; font-weight: 700; color: #8b5cf6; display: flex; align-items: center; gap: 20px; }
        .stat-label { color: #a78bfa; font-size: 1.2rem; }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 39px; margin-bottom: 39px; }
        .rankings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 26px; margin-bottom: 26px; }
        .panel { background: white; border-radius: 26px; padding: 33px; box-shadow: 0 10px 42px rgba(147, 51, 234, 0.1); }
        .panel.full-width { grid-column: 1 / -1; }
        .panel-sc { border-top: 4px solid #8b5cf6; }
        .panel-ce { border-top: 4px solid #10b981; }
        .panel h2 { color: #6b46c1; font-size: 2rem; margin-bottom: 26px; font-weight: 600; padding-bottom: 13px; border-bottom: 3px solid #f3f4f6; display: flex; align-items: center; gap: 13px; }
        .panel-ce h2 { color: #10b981; }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #f3f4f6; }
        .ranking-item:last-child { border-bottom: none; }
        .consultant-info { display: flex; align-items: center; gap: 20px; }
        .rank-number { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; width: 39px; height: 39px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.2rem; flex-shrink: 0; }
        .rank-number-ce { background: linear-gradient(135deg, #10b981, #34d399); }
        .consultant-name { color: #374151; font-weight: 500; font-size: 1.2rem; }
        .sales-count { background: #e8ecff; color: #6b46c1; padding: 7px 16px; border-radius: 26px; font-weight: 600; font-size: 1.2rem; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .sales-count:hover { background-color: #6b46c1; color: white; }
        
        .consultant-photo-ranking { width: 52px; height: 52px; border-radius: 50%; object-fit: cover; border: 3px solid #e8ecff; }
        #topConsultantPhoto { width: 104px; height: 104px; border-radius: 50%; object-fit: cover; border: 5px solid #a78bfa; margin-left: 20px; box-shadow: 0 7px 20px rgba(147, 51, 234, 0.25); background-color: #f0f2ff; transition: transform 0.3s ease; }
        .stat-card:hover #topConsultantPhoto { transform: scale(1.05); }
        #topConsultantPhotoCE { 
            width: 104px; 
            height: 104px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 5px solid #10b981; 
            margin-left: 20px; 
            box-shadow: 0 7px 20px rgba(16, 185, 129, 0.25); 
            background-color: #10b981; 
            transition: transform 0.3s ease; 
        }
        .stat-card:hover #topConsultantPhotoCE { 
            transform: scale(1.05); 
        }
        .process-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; }
        .process-card { background: linear-gradient(135deg, #f8f9ff, #e8ecff); padding: 26px; border-radius: 20px; text-align: center; }
        .process-card h4 { color: #6b46c1; font-size: 1.2rem; margin-bottom: 13px; text-transform: uppercase; }
        .process-number { font-size: 2.6rem; font-weight: 700; color: #8b5cf6; }
        .process-meta { font-size: 1rem; color: #6b7280; margin-top: 7px; }
        .recent-sales { grid-column: 1 / -1; }


        
        .sales-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 1.2rem; }
        .sales-table th { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; padding: 20px; text-align: left; font-weight: 700; }
        .sales-table td { padding: 20px; border-bottom: 1px solid #f3f4f6; color: #374151; vertical-align: middle; }
        .sales-table tr:nth-child(even) { background-color: #f9fafb; }
        .process-badge, .date-badge, .status-badge { padding: 8px 16px; border-radius: 26px; font-size: 1rem; display: inline-block; font-weight: 500; }
        .process-badge { background: #e8ecff; color: #6b46c1; }
        .date-badge { background: #f3f4f6; color: #6b7280; }
        .status-badge { color: white; }
        
        .month-selector { background: white; padding: 15px; border-radius: 20px; margin-bottom: 26px; box-shadow: 0 5px 16px rgba(0, 0, 0, 0.05); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
        .month-selector-group { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .month-selector label { font-weight: 600; color: #6b46c1; font-size: 1.2rem; }
        .month-selector select { padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 1.2rem; background-color: white; cursor: pointer; }
        
        .carousel-controls-group { display: flex; align-items: center; gap: 10px; }
        #carousel-toggle-button, .carousel-nav-btn { padding: 10px 16px; border: 1px solid #d1d5db; border-radius: 10px; background-color: white; color: #6b46c1; cursor: pointer; font-size: 1.2rem; transition: background-color 0.2s, color 0.2s; line-height: 1; }
        #carousel-toggle-button:hover, .carousel-nav-btn:hover { background-color: #f3f4f6; }
        #carousel-nav-controls { display: flex; gap: 10px; }
        
        .carousel-page { display: none; opacity: 0; animation: fadeIn 0.8s ease-in-out forwards; }
        .carousel-page.active { display: block; }
        @keyframes fadeIn { to { opacity: 1; } }
        
        .culture-section { margin-top: 39px; display: flex; flex-direction: column; gap: 39px; }
        .mission-vision-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 39px; }
        .culture-card { background: white; padding: 45px; border-radius: 26px; box-shadow: 0 10px 42px rgba(147, 51, 234, 0.1); text-align: center; transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; justify-content: center; }
        .culture-card:hover { transform: translateY(-10px); box-shadow: 0 16px 52px rgba(147, 51, 234, 0.15); }

        .prominent-card { background: linear-gradient(135deg, #fdfcff, #f3f5ff); border-top: 7px solid #8b5cf6; }
        .prominent-card .icon { font-size: 4.5rem; margin-bottom: 33px; background: linear-gradient(135deg, #8b5cf6, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .prominent-card h2 { font-size: 2.8rem; color: #6b46c1; margin-bottom: 26px; }
        .prominent-card p { font-size: 1.8rem; font-weight: 500; color: #374151; line-height: 1.5; }

        #values-card { border-top: 7px solid #a78bfa; }
        #values-card .icon { font-size: 3.9rem; background: linear-gradient(135deg, #8b5cf6, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 26px; }
        #values-card h2 { font-size: 2.3rem; color: #6b46c1; margin-bottom: 20px; }
        .values-inline-list { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 20px; margin-top: 33px; }
        .value-tag { background: #f8f9ff; padding: 16px 26px; border-radius: 39px; border: 1px solid #e8ecff; color: #6b46c1; font-weight: 600; font-size: 1.6rem; display: inline-flex; align-items: center; gap: 13px; transition: all 0.3s ease; }
        .value-tag:hover { transform: translateY(-4px); box-shadow: 0 5px 20px rgba(147, 51, 234, 0.1); border-color: #dadaff; }
        .value-tag i { font-size: 1.8rem; opacity: 0.8; }

        .process-counter-container { margin-top: 26px; padding-top: 26px; border-top: 2px solid #e8ecff; }
        .process-counter-container h3 { color: #6b46c1; font-size: 1.8rem; font-weight: 600; margin-bottom: 13px; text-transform: uppercase; letter-spacing: 1px; }
        .process-counter { font-size: 3rem; font-weight: 700; color: #8b5cf6; }
        .process-counter span { background: linear-gradient(135deg, #8b5cf6, #6b46c1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .timeline { position: relative; max-width: 1040px; margin: 65px auto; padding: 26px 0; }
        .timeline::before { content: ''; position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: linear-gradient(to bottom, #a78bfa, #8b5cf6); border-radius: 4px; transform: translateX(-50%); }
        .timeline-item { padding: 13px 52px; position: relative; width: 50%; }
        .timeline-item:nth-child(odd) { left: 0; text-align: right; }
        .timeline-item:nth-child(even) { left: 50%; text-align: left; }
        .timeline-item .content { background: white; padding: 33px; border-radius: 20px; box-shadow: 0 10px 42px rgba(147, 51, 234, 0.1); position: relative; }
        .timeline-item .date { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; padding: 10px 20px; border-radius: 26px; font-weight: 600; display: inline-block; margin-bottom: 13px; font-size: 1.1rem; }
        .timeline-item h3 { font-size: 1.8rem; color: #6b46c1; margin-bottom: 10px; }
        .timeline-item p { font-size: 1.3rem; color: #555; }
        .timeline-item::after { content: ''; position: absolute; width: 26px; height: 26px; background: white; border: 5px solid #8b5cf6; border-radius: 50%; top: 33px; z-index: 1; }
        .timeline-item:nth-child(odd)::after { right: -13px; }
        .timeline-item:nth-child(even)::after { left: -13px; }
        
        #sale-notification-overlay { 
            position: fixed !important; 
            top: 0 !important; 
            left: 0 !important; 
            width: 100% !important; 
            height: 100% !important; 
            background: rgba(29, 13, 51, 0.7) !important; 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            z-index: 999999 !important; 
            display: none; 
            justify-content: center; 
            align-items: center; 
            opacity: 0; 
            transition: opacity 0.5s ease; 
            overflow: hidden; 
        }
        #sale-notification-overlay.show { 
            display: flex !important; 
            opacity: 1 !important; 
        }
        .notification-content { background: white; padding: 52px 65px; border-radius: 33px; text-align: center; box-shadow: 0 26px 65px rgba(0,0,0,0.3); position: relative; transform: scale(0.7); opacity: 0; animation: pop-in 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; max-width: 90%; width: 910px; border-top: 10px solid #a78bfa; }
        @keyframes pop-in { to { transform: scale(1); opacity: 1; } }
        
        .notification-photo { width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 5px solid #a78bfa; margin-bottom: 26px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .notification-content .main-icon { font-size: 5.2rem; color: #ffc107; text-shadow: 0 5px 13px rgba(255, 193, 7, 0.5); margin-bottom: 26px; }
        .notification-content h2 { font-size: 3.6rem; font-weight: 800; color: #6b46c1; margin-bottom: 20px; }
        .notification-content p { font-size: 1.7rem; color: #555; line-height: 1.6; }
        .notification-content p strong { color: #8b5cf6; font-weight: 700; }
        .notification-content .process-info { font-size: 1.3rem; color: #777; margin-top: 13px; background: #f8f9ff; padding: 10px 20px; border-radius: 13px; display: inline-block; border: 1px solid #e8ecff; }
        
        .animation-extras { position: absolute; bottom: -65px; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .rocket, .money-symbol, .clapping-hands { position: absolute; font-size: 2.6rem; opacity: 0; }
        .rocket { color: #8b5cf6; animation: launch 3s ease-in forwards; }
        @keyframes launch { 0% { transform: translateY(0) rotate(-45deg); opacity: 1; } 100% { transform: translateY(-120vh) rotate(-45deg); opacity: 0; } }
        .rocket:nth-child(1) { left: 15%; animation-delay: 0.1s; }
        .rocket:nth-child(2) { left: 80%; animation-delay: 0.5s; }
        .rocket:nth-child(3) { left: 50%; animation-delay: 0.2s; }
        
        .money-symbol { color: #22c55e; animation: float-up 4s ease-out forwards; }
        .clapping-hands { color: #ffc107; animation: float-up 4s ease-out forwards; }
        @keyframes float-up { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(-120vh) rotate(360deg); opacity: 0; } }
        .money-symbol:nth-child(1), .clapping-hands:nth-child(1) { left: 20%; font-size: 3rem; animation-delay: 0.1s; }
        .money-symbol:nth-child(2), .clapping-hands:nth-child(2) { left: 75%; font-size: 2.5rem; animation-delay: 0.8s; }
        .money-symbol:nth-child(3), .clapping-hands:nth-child(3) { left: 45%; font-size: 3.5rem; animation-delay: 0.4s; }

        #process-details-modal { position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; animation: fadeIn 0.3s; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 39px; border: 1px solid #888; width: 90%; max-width: 650px; border-radius: 20px; box-shadow: 0 7px 33px rgba(0,0,0,0.2); position: relative; animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal-content h2 { color: #6b46c1; margin-top: 0; margin-bottom: 26px; border-bottom: 3px solid #f3f4f6; padding-bottom: 20px; font-size: 2rem; }
        .close-button { color: #aaa; position: absolute; top: 20px; right: 33px; font-size: 36px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .details-list { list-style-type: none; padding: 0; max-height: 390px; overflow-y: auto; }
        .details-list li { padding: 13px 7px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 1.25rem; }
        .details-list li:last-child { border-bottom: none; }
        .details-list .process-name { color: #374151; }
        .details-list .process-count-badge { background: #8b5cf6; color: white; padding: 5px 13px; border-radius: 20px; font-weight: 600; font-size: 1.1rem; }
        
        .payment-filter-container { display: flex; gap: 10px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #f3f4f6; flex-wrap: wrap; }
        .payment-filter-btn { padding: 10px 20px; cursor: pointer; border: 1px solid #d1d5db; background-color: #f9fafb; font-size: 1.1rem; font-weight: 600; color: #6b7280; border-radius: 20px; transition: color 0.3s, background-color 0.3s, border-color 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .payment-filter-btn:hover { background-color: #e8ecff; color: #6b46c1; }
        .payment-filter-btn.active { background-color: #8b5cf6; color: white; border-color: #8b5cf6; }
        .payment-status-section { display: block; animation: fadeIn 0.5s; }
        .payment-status-section h2 { border-bottom: none; padding-bottom: 0; margin-bottom: 15px; margin-top: 25px; justify-content: flex-start; }
        .payment-status-section:first-of-type h2 { margin-top: 0; }

        @media (max-width: 1024px) {
            .main-content, .mission-vision-grid, .rankings-grid { grid-template-columns: 1fr; }
            .timeline::before { left: 20px; }
            .timeline-item { width: 100%; padding-left: 65px; padding-right: 13px; }
            .timeline-item:nth-child(odd), .timeline-item:nth-child(even) { left: 0; text-align: left; }
            .timeline-item:nth-child(odd)::after, .timeline-item:nth-child(even)::after { left: 7px; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- P√°ginas do Carrossel -->
        <div id="dashboard-view" class="carousel-page active" data-name="Dashboard">
            <div class="header"><h1><i class="fas fa-chart-line"></i> Dashboard de Vendas - ReVive</h1><p class="subtitle">Rumo aos cem mil processos at√© 2030!</p></div>
            <div class="connection-status" id="connectionStatus" style="margin: 0 auto 20px auto;"><i class="fas fa-sync fa-spin"></i><span id="statusText">Verificando conex√£o...</span></div>
            <div class="month-selector">
                <div class="month-selector-group">
                    <label for="monthFilter"><i class="fas fa-calendar"></i> M√™s:</label>
                    <select id="monthFilter" onchange="updateDashboard()"></select>
                </div>
                <div class="month-selector-group">
                    <label for="pageSelector"><i class="fas fa-map-signs"></i> Navegar para:</label>
                    <select id="pageSelector" onchange="jumpToPage(this.value)"></select>
                </div>
                <div class="carousel-controls-group">
                    <div id="carousel-nav-controls">
                        <button class="carousel-nav-btn" title="P√°gina Anterior" onclick="manualNavigate(-1)"><i class="fas fa-chevron-left"></i></button>
                        <button class="carousel-nav-btn" title="Pr√≥xima P√°gina" onclick="manualNavigate(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <button id="carousel-toggle-button" title="Pausar Carrossel"><i class="fas fa-pause"></i></button>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><h3><i class="fas fa-sun"></i> Total de Processos no M√™s</h3><div class="stat-value" id="totalMonth">-</div><div class="stat-label" id="monthLabel">-</div></div>
                <div class="stat-card"><h3><i class="fas fa-trophy"></i> Melhor Consultor SC</h3><div class="stat-value">üèÜ <span id="topConsultant">-</span><img id="topConsultantPhoto" src="" alt="Foto do Melhor Consultor SC" style="display: none;"></div><div class="stat-label">em processos este m√™s</div></div>
                <div class="stat-card stat-card-ce"><h3><i class="fas fa-trophy"></i> Melhor Consultor CE</h3><div class="stat-value">üèÜ <span id="topConsultantCE">-</span><img id="topConsultantPhotoCE" src="" alt="Foto do Melhor Consultor CE" style="display: none;"></div><div class="stat-label">em processos este m√™s</div></div>
                <div class="stat-card"><h3><i class="fas fa-chart-bar"></i> M√©dia Di√°ria</h3><div class="stat-value" id="dailyAverage">-</div><div class="stat-label">processos/dia</div></div>
            </div>
            <div class="rankings-grid">
                <div class="panel panel-sc"><h2><i class="fas fa-trophy"></i> Ranking Santa Catarina</h2><div id="consultantRanking"></div></div>
                <div class="panel panel-ce"><h2><i class="fas fa-trophy"></i> Ranking Cear√°</h2><div id="cearaRanking"></div></div>
            </div>
            <div class="main-content">
                <div class="panel full-width"><h2><i class="fas fa-chart-pie"></i> Tipos de Processo e Metas</h2><div class="process-stats"><div class="process-card"><h4>Previdenci√°rios</h4><div class="process-number" id="previdenciariosCount">-</div><div class="process-meta">Meta: <span id="previdenciariosGoal">-</span> (<span id="previdenciariosPercent">-</span>%)</div></div><div class="process-card"><h4>Seguro Terceiro</h4><div class="process-number" id="seguroTerceiroCount">-</div><div class="process-meta">Meta: <span id="seguroTerceiroGoal">-</span> (<span id="seguroTerceiroPercent">-</span>%)</div></div><div class="process-card"><h4>Seguro de Vida</h4><div class="process-number" id="seguroVidaCount">-</div><div class="process-meta">Meta: <span id="seguroVidaGoal">-</span> (<span id="seguroVidaPercent">-</span>%)</div></div><div class="process-card"><h4>Outros</h4><div class="process-number" id="outrosCount">-</div></div></div></div>
            </div>
            <div class="panel recent-sales">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 10px;">
                    <h2 style="margin-bottom: 0; border-bottom: none; padding-bottom: 0;"><i class="fas fa-clock"></i> Linhas da Planilha do M√™s</h2>
                    <div class="consultant-filter-container">
                        <label for="consultantFilter" style="font-weight: 600; color: #6b46c1; margin-right: 10px; font-size: 1.2rem;">Filtrar por Consultor:</label>
                        <select id="consultantFilter" onchange="filterSalesByConsultant()" style="padding: 10px 20px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 1.2rem; background-color: white; cursor: pointer;"></select>
                    </div>
                </div>
                <table class="sales-table" style="font-size: 1.2rem;">
                    <thead>
                        <tr><th>Data</th><th>Cliente</th><th>Processo</th><th>Consultor</th></tr>
                    </thead>
                    <tbody id="recentSalesTable"></tbody>
                </table>
            </div>
        </div>
        <div id="chart-view" class="carousel-page" data-name="Gr√°ficos"><div class="header"><h1><i class="fas fa-chart-area"></i> Evolu√ß√£o de Processos</h1><p class="subtitle" id="chart-subtitle">Acompanhamento mensal do ano corrente</p></div><div class="panel"><div style="position: relative; height: 585px;"><canvas id="processEvolutionChart"></canvas></div></div></div>
        
        <div id="mission-view" class="carousel-page" data-name="Cultura">
            <div class="header">
                <h1><i class="fas fa-gem"></i> Nossa Cultura - ReVive</h1>
                <p class="subtitle">Os pilares que nos guiam todos os dias.</p>
            </div>
            <div class="culture-section">
                <div class="mission-vision-grid">
                    <div class="culture-card prominent-card">
                        <div class="icon"><i class="fas fa-bullseye"></i></div>
                        <h2>Miss√£o</h2>
                        <p>Simplificar o acesso a direitos para quem enfrenta a dor.</p>
                    </div>
                    <div class="culture-card prominent-card">
                        <div class="icon"><i class="fas fa-eye"></i></div>
                        <h2>Vis√£o</h2>
                        <p>Conduzir ao √™xito mais de 100 mil processos at√© 2030.</p>
                    </div>
                </div>
                <div id="values-card" class="culture-card">
                    <div class="icon"><i class="fas fa-star"></i></div>
                    <h2>Nossos Valores</h2>
                    <div class="values-inline-list">
                        <span class="value-tag"><i class="fas fa-balance-scale"></i> √âtica Profissional</span>
                        <span class="value-tag"><i class="fas fa-trophy"></i> Meritocracia</span>
                        <span class="value-tag"><i class="fas fa-lightbulb"></i> Inova√ß√£o</span>
                        <span class="value-tag"><i class="fas fa-heart"></i> Empatia</span>
                        <span class="value-tag"><i class="fas fa-bolt"></i> Proatividade</span>
                        <span class="value-tag"><i class="fas fa-search"></i> Aten√ß√£o aos Detalhes</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="pagamentos-view" class="carousel-page" data-name="Aprovados">
            <div class="header">
                <h1><i class="fas fa-hand-holding-usd"></i> Painel de Aprovados</h1>
                <p class="subtitle">Acompanhamento de processos por status.</p>
                <div class="process-counter-container" style="border-top: none; padding-top: 15px; margin-top: 20px;">
                    <h3 style="font-size: 2.2rem; color: #8b5cf6;">Processos Finalizados Rumo √† Meta</h3>
                    <div class="process-counter" style="font-size: 4.5rem; margin-top: 10px;">
                        <span id="finishedProcesses">20.000</span> / 100.000
                    </div>
                </div>
            </div>
            <div class="panel">
                <div class="payment-filter-container">
                    <button class="payment-filter-btn active" onclick="filterPayments('all')"><i class="fas fa-list-ul"></i> Todos</button>
                    <button class="payment-filter-btn" onclick="filterPayments('aprovado')"><i class="fas fa-thumbs-up"></i> Aprovado</button>
                    <button class="payment-filter-btn" onclick="filterPayments('na_conta')"><i class="fas fa-wallet"></i> Na Conta</button>
                    <button class="payment-filter-btn" onclick="filterPayments('pago')"><i class="fas fa-check-double"></i> Pago</button>
                </div>
        
                <div id="section-aprovado" class="payment-status-section">
                    <h2><i class="fas fa-thumbs-up"></i> Processos com Status 'Aprovado'</h2>
                    <table class="sales-table">
                        <thead><tr><th>Data</th><th>Nome</th><th>Processo</th><th>Valor</th></tr></thead>
                        <tbody id="aprovadoTableBody"></tbody>
                    </table>
                </div>
        
                <div id="section-na_conta" class="payment-status-section">
                    <h2><i class="fas fa-wallet"></i> Processos com Status 'Na Conta'</h2>
                    <table class="sales-table">
                        <thead><tr><th>Data</th><th>Nome</th><th>Processo</th><th>Valor</th></tr></thead>
                        <tbody id="naContaTableBody"></tbody>
                    </table>
                </div>
        
                <div id="section-pago" class="payment-status-section">
                    <h2><i class="fas fa-check-double"></i> Processos com Status 'Pago'</h2>
                    <table class="sales-table">
                        <thead><tr><th>Data</th><th>Nome</th><th>Processo</th><th>Valor</th></tr></thead>
                        <tbody id="pagoTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="rtm-pagamentos-view" class="carousel-page" data-name="Pagamentos RTM">
            <div class="header">
                <h1><i class="fas fa-receipt"></i> Pagamentos de RTM</h1>
                <p class="subtitle">Acompanhamento de pagamentos recebidos via RTM.</p>
                <div class="process-counter-container" style="border-top: none; padding-top: 15px; margin-top: 20px;">
                    <h3 style="font-size: 2.2rem; color: #8b5cf6;">RTMs Cobrados Hoje</h3>
                    <div class="process-counter" style="font-size: 4.5rem; margin-top: 10px;">
                        <span id="rtmTodayCounter">0</span>
                    </div>
                </div>
            </div>
            <div class="panel">
                <h2 style="border-bottom: none; padding-bottom: 0;"><i class="fas fa-history"></i> Hist√≥rico de Recebimentos</h2>
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Valor</th>
                            <th>Cobrado por</th>
                        </tr>
                    </thead>
                    <tbody id="rtmPaymentsTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="acordos-view" class="carousel-page" data-name="Acordos">
            <div class="header">
                <h1><i class="fas fa-handshake"></i> Painel de Acordos</h1>
                <p class="subtitle">Acompanhamento de acordos e negocia√ß√µes.</p>
            </div>
            <div class="panel">
                <h2 style="border-bottom: none; padding-bottom: 0;"><i class="fas fa-tasks"></i> Status dos Acordos</h2>
                <table class="sales-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Processo</th>
                            <th>Valor</th>
                            <th>Honor√°rios</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="acordosTableBody"></tbody>
                </table>
            </div>
        </div>
    
        <div id="schedule-view" class="carousel-page" data-name="Cronograma">
            <div class="header">
                <h1><i class="fas fa-calendar-alt"></i> Cronograma ReVive</h1>
                <p class="subtitle">Fique por dentro dos nossos pr√≥ximos eventos!</p>
            </div>
            <div class="timeline">
                <div class="timeline-item">
                    <div class="content">
                        <span class="date">12 de Outubro de 2025</span>
                        <h3>Dias das Crian√ßas ReVive</h3>
                        <p>Evento planejado pelo grupo For√ßa de Marca, dos Novos Talentos 2025.</p>
                    </div>
                </div>
                <div class="timeline-item">
                    <div class="content">
                        <span class="date">Dezembro</span>
                        <h3>Fim de Ano ReVive</h3>
                        <p>Evento de final de ano.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="sale-notification-overlay">
        <div class="notification-content">
            <img id="notification-photo" src="" alt="Foto" class="notification-photo">
            <div id="notification-main-icon" class="main-icon"></div>
            <h2 id="notification-title"></h2>
            <p id="notification-text"></p>
            <div class="process-info" id="notification-secondary-text"></div>
            <div id="animation-extras-container" class="animation-extras"></div>
        </div>
    </div>

    <div id="process-details-modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeProcessDetails()">√ó</span>
            <h2 id="modal-title">Detalhes de Processos</h2>
            <div id="modal-details-content"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        let salesData = [];
        let cearaData = [];
        let paymentsData = [];
        let rtmPaymentsData = [];
        let acordosData = [];
        let firstLoad = true;
        let isAnimationPlaying = false;
        let carouselPaused = false;
        let notificationQueue = [];
        const FIXED_SHEET_ID = "1fSTEyMmAEgfMnAFUTdYbJah5dr8OudsEsqjKHnHwFms";
        const SALES_SHEET_GID = "1536647709";
        const CEARA_SHEET_GID = "1480007459";
        const PGTO_SHEET_GID = "1456804198"; 
        const NEW_RTM_SHEET_ID = "1KcEKtzGxSGEICRw14ctfCD4sDsQJuzl3OSwVZQcHSWE";
        const NEW_RTM_SHEET_GID = "485541894";
        const ACORDOS_SHEET_ID = "1kwsL_Gkw-LC-n_E_nLUCzE9CuFtQDhRe";
        const ACORDOS_SHEET_GID = "277487318";
        const DRA_RENATA_STRING = "DRA RENATA";
        let currentMonthCounts = {};
        let processEvolutionChartInstance = null;
        let consultantDetails = {};
        let carouselInterval;
        let carouselPages = [];
        let currentPageIndex = 0;
        const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI2NkZGFmYiI+PHBhdGggZD0iTTEyIDJBNCA0IDAgMCAwIDggNkE0IDQgMCAwIDAgMTIgMTBBNCA0IDAgMCAwIDE2IDZBNCA0IDAgMCAwIDEyIDJ6bTAgMTBDOC4xMyAxMiA0IDEzLjc5IDQgMTd2M2g4di0zYzAtMS42NiAxLjM0LTMgMy0zaDEuNjlBMy4wMDIgMy4wMDIgMCAwIDEgMTYgMTRjMS42NiAwIDMgMS4zNCAzIDN2M2gydi0zYzAtMy4yMS00LjEzLTUtOC01eiIvPjwvc3ZnPg==';

        const PREVIDENCIARIO_TYPES = ['CONCESS√ÉO MATERNIDADE', 'AUXILIO-ACIDENTE', 'APOSENTADORIA POR TEMPO DE SERVI√áO', 'LOAS', 'AUXILIO-DOEN√áA', 'APOSENTADORIA POR IDADE', 'APOSENTADORIA POR INVALIDEZ', 'PENS√ÉO POR MORTE'].map(type => type.toUpperCase().trim());
        const SEGURO_TERCEIRO_TYPES = ['TERCEIRO DANO CORPORAL', 'TERCEIRO DANO MATERIAL'].map(type => type.toUpperCase().trim());
        const SEGURO_VIDA_TYPES = ['VIDA', 'VIDA APLICATIVO'].map(type => type.toUpperCase().trim());
        
        function setupCarousel() {
            carouselPages = document.querySelectorAll('.carousel-page');
            if (carouselPages.length === 0) return;

            const pageSelector = document.getElementById('pageSelector');
            pageSelector.innerHTML = '';
            carouselPages.forEach((page, index) => {
                const pageName = page.dataset.name || `P√°gina ${index + 1}`;
                const option = document.createElement('option');
                option.value = index;
                option.textContent = pageName;
                pageSelector.appendChild(option);
            });

            startCarouselInterval();
            updatePageSelector();
        }

        function startCarouselInterval() {
            clearInterval(carouselInterval);
            carouselInterval = setInterval(() => {
                if (isAnimationPlaying || carouselPaused) return;
                navigateCarousel(1);
            }, 35000);
        }

        function navigateCarousel(direction) {
            if (carouselPages.length === 0) return;
            carouselPages[currentPageIndex].classList.remove('active');
            currentPageIndex = (currentPageIndex + direction + carouselPages.length) % carouselPages.length;
            carouselPages[currentPageIndex].classList.add('active');
            updatePageSelector();
        }

        function manualNavigate(direction) {
            clearInterval(carouselInterval);
            navigateCarousel(direction);
            if (!carouselPaused) {
                startCarouselInterval();
            }
        }
        
        function jumpToPage(index) {
            clearInterval(carouselInterval);
            carouselPages[currentPageIndex].classList.remove('active');
            currentPageIndex = parseInt(index, 10);
            carouselPages[currentPageIndex].classList.add('active');
            updatePageSelector();
            if (!carouselPaused) {
                startCarouselInterval();
            }
        }

        function updatePageSelector() {
            const pageSelector = document.getElementById('pageSelector');
            if (pageSelector) {
                pageSelector.value = currentPageIndex;
            }
        }

        function processNotificationQueue() {
            if (isAnimationPlaying || notificationQueue.length === 0) {
                return;
            }
            isAnimationPlaying = true;
            const notificationData = notificationQueue.shift(); 
            
            if (notificationData.type === 'sale') {
                triggerSaleAnimation(notificationData.data);
            } else if (notificationData.type === 'payment') {
                triggerPaymentAnimation(notificationData.data);
            } else if (notificationData.type === 'rtmPayment') {
                triggerRtmPaymentAnimation(notificationData.data);
            } else if (notificationData.type === 'acordoUpdate') {
                triggerAcordoNotification(notificationData.data);
            }
        }

        function onAnimationFinish() {
            const overlay = document.getElementById('sale-notification-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.classList.remove('show');
                overlay.style.display = 'none';
            }, 500);
            isAnimationPlaying = false;
            setTimeout(processNotificationQueue, 1000); 
        }

        function triggerAcordoNotification(acordo) {
            const statusSounds = {
                'TRATATIVA DE ACORDO': 'foguete.wav',
                'ACORDO FECHADO': 'palmas.mp3',
                'PAGAMENTO EFETUADO': 'dinheiro.mp3'
            };
            const soundFile = statusSounds[acordo.status.toUpperCase()];
            if (soundFile) {
                new Audio(soundFile).play().catch(e => console.error(`Erro ao tocar '${soundFile}':`, e));
            }

            const overlay = document.getElementById('sale-notification-overlay');
            const photoEl = document.getElementById('notification-photo');
            const iconEl = document.getElementById('notification-main-icon');
            const titleEl = document.getElementById('notification-title');
            const textEl = document.getElementById('notification-text');
            const secondaryTextEl = document.getElementById('notification-secondary-text');
            const extrasContainer = document.getElementById('animation-extras-container');
            
            photoEl.style.display = 'none';
            
            const statusIcons = {
                'TRATATIVA DE ACORDO': '<i class="fas fa-comments-dollar" style="color: #f59e0b;"></i>',
                'ACORDO FECHADO': '<i class="fas fa-handshake" style="color: #10b981;"></i>',
                'PAGAMENTO EFETUADO': '<i class="fas fa-dollar-sign" style="color: #22c55e;"></i>'
            };
            
            const animationHtml = {
                'TRATATIVA DE ACORDO': '<i class="fas fa-rocket rocket"></i><i class="fas fa-rocket rocket" style="left: 70%; animation-delay: 0.4s;"></i>',
                'ACORDO FECHADO': '<i class="fas fa-hand-sparkles clapping-hands"></i><i class="fas fa-hand-sparkles clapping-hands" style="left: 60%; animation-delay: 0.3s;"></i>',
                'PAGAMENTO EFETUADO': '<i class="fas fa-dollar-sign money-symbol"></i><i class="fas fa-euro-sign money-symbol" style="left: 80%; animation-delay: 0.2s;"></i>'
            };

            iconEl.innerHTML = statusIcons[acordo.status.toUpperCase()] || '<i class="fas fa-info-circle"></i>';
            titleEl.textContent = 'Status de Acordo Atualizado!';
            textEl.innerHTML = `O acordo do cliente <strong>${acordo.cliente || 'N/A'}</strong> mudou para <strong>${acordo.status}</strong>!`;
            secondaryTextEl.textContent = `Processo: ${acordo.processo || 'N/A'} | Honor√°rios: ${acordo.honorarios || 'N/A'}`;
            extrasContainer.innerHTML = animationHtml[acordo.status.toUpperCase()] || '';

            overlay.style.display = 'flex';
            overlay.classList.add('show');
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
        }

        function triggerSaleAnimation(sale) {
            new Audio('foguete.wav').play().catch(e => console.error("Erro ao tocar 'foguete.wav':", e));
            const overlay = document.getElementById('sale-notification-overlay');
            const photoEl = document.getElementById('notification-photo');
            const iconEl = document.getElementById('notification-main-icon');
            const titleEl = document.getElementById('notification-title');
            const textEl = document.getElementById('notification-text');
            const secondaryTextEl = document.getElementById('notification-secondary-text');
            const extrasContainer = document.getElementById('animation-extras-container');
            
            photoEl.style.display = 'block';
            photoEl.src = getConsultantPhotoUrl(sale.consultor);
            photoEl.onerror = () => { photoEl.src = DEFAULT_AVATAR; photoEl.onerror = null; };
            
            iconEl.innerHTML = '<i class="fas fa-trophy"></i>';
            const regionText = sale.region || 'Santa Catarina';
            titleEl.textContent = `Nova Venda - ${regionText}!`;
            textEl.innerHTML = `O consultor <strong>${sale.consultor || 'N/A'}</strong> fechou uma nova venda para o cliente <strong>${sale.cliente || 'N/A'}</strong>!`;
            secondaryTextEl.textContent = `Processos: ${sale.processo || 'N/A'}`;
            extrasContainer.innerHTML = '<i class="fas fa-rocket rocket"></i><i class="fas fa-rocket rocket"></i><i class="fas fa-rocket rocket"></i>';
            
            overlay.style.display = 'flex';
            overlay.classList.add('show');
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            
             confetti({ particleCount: 150, spread: 180, origin: { y: 0.6 } });
            
            setTimeout(onAnimationFinish, 8000);
        } // <-- CHAVE DE FECHAMENTO ADICIONADA AQUI

        function triggerPaymentAnimation(payment) {
            new Audio('dinheiro.mp3').play().catch(e => console.error("Erro ao tocar 'dinheiro.mp3':", e));
            const overlay = document.getElementById('sale-notification-overlay');
            const photoEl = document.getElementById('notification-photo');
            const iconEl = document.getElementById('notification-main-icon');
            const titleEl = document.getElementById('notification-title');
            const textEl = document.getElementById('notification-text');
            const secondaryTextEl = document.getElementById('notification-secondary-text');
            const extrasContainer = document.getElementById('animation-extras-container');

            photoEl.style.display = 'none';

            iconEl.innerHTML = '<i class="fas fa-dollar-sign" style="color:#22c55e;"></i>';
            titleEl.textContent = 'Pagamento Realizado!';
            textEl.innerHTML = `O status do processo <strong>${payment.processo || 'N/A'}</strong> de <strong>${payment.nome || 'N/A'}</strong> foi atualizado para PAGO!`;
            secondaryTextEl.textContent = `Valor: ${payment.valor || 'N/A'}`;
            extrasContainer.innerHTML = `<i class="fas fa-dollar-sign money-symbol"></i><i class="fas fa-euro-sign money-symbol"></i><i class="fas fa-pound-sign money-symbol"></i>`;

            overlay.style.display = 'flex';
            overlay.classList.add('show');
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);

            setTimeout(onAnimationFinish, 8000); // Adicionado para fechar a notifica√ß√£o
        } // <-- CHAVE DE FECHAMENTO ADICIONADA AQUI

        function triggerRtmPaymentAnimation(payment) {
            new Audio('dinheiro.mp3').play().catch(e => console.error("Erro ao tocar 'dinheiro.mp3':", e));

            const overlay = document.getElementById('sale-notification-overlay');
            const photoEl = document.getElementById('notification-photo');
            const iconEl = document.getElementById('notification-main-icon');
            const titleEl = document.getElementById('notification-title');
            const textEl = document.getElementById('notification-text');
            const secondaryTextEl = document.getElementById('notification-secondary-text');
            const extrasContainer = document.getElementById('animation-extras-container');

            let cobradorName = 'Equipe';
            let photoUrl = DEFAULT_AVATAR;
            
            if (payment.cobrador) {
                const cobrador = payment.cobrador.trim();
                if (cobrador.startsWith('@')) {
                    cobradorName = cobrador.substring(1).split(' ')[0];
                } else if (cobrador.toLowerCase() !== 'equipe') {
                    cobradorName = cobrador.split(' ')[0];
                }
                photoUrl = getConsultantPhotoUrl(cobradorName);
            }

            photoEl.style.display = 'block';
            photoEl.src = photoUrl;
            photoEl.onerror = () => { photoEl.src = DEFAULT_AVATAR; photoEl.onerror = null; };

            iconEl.innerHTML = '<i class="fas fa-dollar-sign" style="color:#22c55e;"></i>';
            titleEl.textContent = 'Pagamento RTM Recebido!';
            textEl.innerHTML = `Pagamento de <strong>${payment.cliente || 'N/A'}</strong> foi registrado por <strong>${cobradorName}</strong>!`;
            secondaryTextEl.textContent = `Valor: ${payment.valor || 'N/A'}`;
            extrasContainer.innerHTML = `<i class="fas fa-dollar-sign money-symbol"></i><i class="fas fa-euro-sign money-symbol"></i><i class="fas fa-pound-sign money-symbol"></i>`;

            overlay.style.display = 'flex';
            overlay.classList.add('show');
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            
            setTimeout(onAnimationFinish, 8000); // Adicionado para fechar a notifica√ß√£o
        } // <-- CHAVE DE FECHAMENTO ADICIONADA AQUI
        
        function checkForNewSales(newSales, oldSales, region = 'Santa Catarina') {
            if (firstLoad || newSales.length <= oldSales.length) return;
            const oldSaleIndices = new Set(oldSales.map(s => s.originalIndex));
            const newlyAddedSales = newSales.filter(s => !oldSaleIndices.has(s.originalIndex));

            if (newlyAddedSales.length > 0) {
                newlyAddedSales.forEach(sale => notificationQueue.push({ type: 'sale', data: { ...sale, region } }));
                processNotificationQueue();
            }
        }

        function checkForPaidStatusChange(newPayments, oldPayments) {
            if (firstLoad || oldPayments.length === 0) return;
            const oldPaymentsMap = new Map(oldPayments.map(p => [p.uniqueId, p]));
            
            for (const newPayment of newPayments) {
                const oldPayment = oldPaymentsMap.get(newPayment.uniqueId);
                if (oldPayment && oldPayment.status !== 'PAGO' && newPayment.status === 'PAGO') {
                    notificationQueue.push({ type: 'payment', data: newPayment });
                }
            }
            if(notificationQueue.some(n => n.type === 'payment')) processNotificationQueue();
        }

        function checkForNewRtmPayments(newRtmData, oldRtmData) {
            if (firstLoad || newRtmData.length <= oldRtmData.length) return;
            
            const oldIndices = new Set(oldRtmData.map(p => p.originalIndex));
            const newlyAdded = newRtmData.filter(p => !oldIndices.has(p.originalIndex));

            if (newlyAdded.length > 0) {
                newlyAdded.forEach(payment => notificationQueue.push({ type: 'rtmPayment', data: payment}));
                processNotificationQueue();
            }
        }

        function checkForAcordoStatusChange(newAcordos, oldAcordos) {
            if (firstLoad || oldAcordos.length === 0) return;

            const oldAcordosMap = new Map(oldAcordos.map(a => [a.uniqueId, a]));

            for (const newAcordo of newAcordos) {
                const oldAcordo = oldAcordosMap.get(newAcordo.uniqueId);
                if (oldAcordo && oldAcordo.status !== newAcordo.status) {
                    const relevantStatus = ['TRATATIVA DE ACORDO', 'ACORDO FECHADO', 'PAGAMENTO EFETUADO'];
                    if(relevantStatus.includes(newAcordo.status.toUpperCase())) {
                        notificationQueue.push({ type: 'acordoUpdate', data: newAcordo });
                    }
                }
            }
            if(notificationQueue.some(n => n.type === 'acordoUpdate')) {
                processNotificationQueue();
            }
        }
        
        async function fetchSalesData() {
            try {
                updateConnectionStatus('loading', 'Conectando √† Vendas...');
                const csvUrl = `https://docs.google.com/spreadsheets/d/${FIXED_SHEET_ID}/export?format=csv&gid=${SALES_SHEET_GID}&_=${new Date().getTime()}`;
                const response = await fetch(csvUrl, { mode: 'cors' });
                if (!response.ok) throw new Error(`Falha na conex√£o de Vendas: ${response.statusText}`);
                const csvData = await response.text();
                if (csvData && csvData.trim()) {
                    const newSalesData = await processCsvData(csvData);
                    checkForNewSales(newSalesData, salesData, 'Santa Catarina');
                    salesData = newSalesData;
                    if (document.getElementById('monthFilter').options.length === 0) {
                        populateMonthFilter(salesData);
                    }
                    updateDashboard();
                }
            } catch (error) {
                console.error("Erro ao buscar dados de vendas:", error);
                updateConnectionStatus('error', 'Falha na conex√£o de vendas');
            }
        }
        
        async function fetchCearaData() {
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${FIXED_SHEET_ID}/export?format=csv&gid=${CEARA_SHEET_GID}&_=${new Date().getTime()}`;
                const response = await fetch(csvUrl, { mode: 'cors' });
                if (!response.ok) throw new Error(`Falha na conex√£o Cear√°: ${response.statusText}`);
                const csvData = await response.text();
                if (csvData && csvData.trim()) {
                    const newCearaData = await processCsvData(csvData);
                    checkForNewSales(newCearaData, cearaData, 'Cear√°');
                    cearaData = newCearaData;
                    updateDashboard();
                }
            } catch (error) {
                console.error("Erro ao buscar dados do Cear√°:", error);
            }
        }
        
        async function fetchPaymentsData() {
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${FIXED_SHEET_ID}/export?format=csv&gid=${PGTO_SHEET_GID}&_=${new Date().getTime()}`;
                const response = await fetch(csvUrl, { mode: 'cors' });
                if (!response.ok) throw new Error(`Falha na conex√£o com pagamentos: ${response.statusText}`);
                const csvData = await response.text();
                
                if (csvData && csvData.trim()) {
                    const newPayments = await processPaymentsCsv(csvData);
                    checkForPaidStatusChange(newPayments, paymentsData);
                    paymentsData = newPayments;
                    updateApprovedProcessesView(paymentsData);
                }
            } catch (error) {
                console.error("Erro ao buscar dados de pagamentos:", error);
                 ['aprovadoTableBody', 'naContaTableBody', 'pagoTableBody'].forEach(id => {
                    const body = document.getElementById(id);
                    if(body) body.innerHTML = `<tr><td colspan="4" style="text-align:center;color:red;">Falha ao carregar dados.</td></tr>`;
                });
            }
        }
        
        async function fetchRtmPaymentsData() {
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${NEW_RTM_SHEET_ID}/export?format=csv&gid=${NEW_RTM_SHEET_GID}&_=${new Date().getTime()}`;
                const response = await fetch(csvUrl, { mode: 'cors' });
                if (!response.ok) throw new Error(`Falha na conex√£o com pagamentos RTM: ${response.statusText}`);
                const csvData = await response.text();
                
                if (csvData && csvData.trim()) {
                    const newRtmData = await processRtmCsv(csvData);
                    checkForNewRtmPayments(newRtmData, rtmPaymentsData);
                    rtmPaymentsData = newRtmData;
                    updateRtmPaymentsView(rtmPaymentsData);
                }
            } catch (error) {
                console.error("Erro ao buscar dados de pagamentos RTM:", error);
                const body = document.getElementById('rtmPaymentsTableBody');
                if(body) body.innerHTML = `<tr><td colspan="4" style="text-align:center;color:red;">Falha ao carregar dados de RTM.</td></tr>`;
            }
        }

        async function fetchAcordosData() {
            try {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${ACORDOS_SHEET_ID}/export?format=csv&gid=${ACORDOS_SHEET_GID}&_=${new Date().getTime()}`;
                const response = await fetch(csvUrl, { mode: 'cors' });
                if (!response.ok) throw new Error(`Falha na conex√£o com Acordos: ${response.statusText}`);
                const csvData = await response.text();

                if(csvData && csvData.trim()) {
                    const newAcordos = await processAcordosCsv(csvData);
                    checkForAcordoStatusChange(newAcordos, acordosData);
                    acordosData = newAcordos;
                    updateAcordosView(acordosData);
                }
            } catch (error) {
                console.error("Erro ao buscar dados de Acordos:", error);
                const body = document.getElementById('acordosTableBody');
                if(body) body.innerHTML = `<tr><td colspan="6" style="text-align:center;color:red;">Falha ao carregar dados de Acordos.</td></tr>`;
            }
        }

        function parseCSVLine(line) {
            const result = []; let current = ''; let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                let char = line[i];
                if (char === '"') {
                    if (inQuotes && i + 1 < line.length && line[i+1] === '"') { 
                        current += '"'; i++; 
                    } else { 
                        inQuotes = !inQuotes; 
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current); current = '';
                } else { 
                    current += char; 
                }
            }
            result.push(current);
            return result.map(item => item.trim());
        }
        
        function parsePtBrDate(dateString) {
            if (!dateString || typeof dateString !== 'string') return null;
            
            let date = new Date(dateString);
            if (!isNaN(date.getTime())) {
                const parts = dateString.split(' ')[0].split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10);
                    if (date.getMonth() + 1 !== month && date.getDate() === month) {
                         return new Date(parts[2], month - 1, day);
                    }
                }
                return date;
            }

            const parts = dateString.split(' ')[0].split('/');
            if (parts.length === 3) {
                const [day, month, year] = parts.map(p => parseInt(p, 10));
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    return new Date(year, month - 1, day);
                }
            }
            return null;
        }

        async function processCsvData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const tempData = [];
            for (let i = 1; i < lines.length; i++) {
                const columns = parseCSVLine(lines[i]);
                const processoValue = (columns[0] || '').trim().toUpperCase();
                if (processoValue === 'CANCELADO') { continue; }
                if (columns.length >= 5) {
                    tempData.push({
                        processo: (columns[0] || '').trim(),
                        cliente: (columns[1] || '').trim(),
                        data: (columns[3] || '').trim(),
                        consultor: (columns[4] || '').trim(),
                        originalIndex: i
                    });
                }
            }
            return tempData;
        }

        async function processPaymentsCsv(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) { 
                const columns = parseCSVLine(lines[i]);
                if (columns.length >= 5 && columns[0]) {
                    const nome = (columns[0] || '').trim();
                    const processo = (columns[1] || '').trim();
                    data.push({
                        nome: nome,
                        processo: processo,
                        valor: (columns[2] || '').trim(),
                        data: (columns[3] || '').trim(),
                        status: (columns[4] || 'APROVADO').trim().toUpperCase(),
                        originalIndex: i,
                        uniqueId: `${nome}-${processo}-${i}`
                    });
                }
            }
            return data;
        }

        async function processRtmCsv(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const columns = parseCSVLine(lines[i]);
                if (columns.length >= 4 && columns[0]) {
                    data.push({
                        cliente: (columns[0] || '').trim(),
                        valor: (columns[1] || '').trim(),
                        data: (columns[2] || '').trim(),
                        cobrador: (columns[3] || '').trim(),
                        originalIndex: i
                    });
                }
            }
            return data;
        }
        
        async function processAcordosCsv(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const columns = parseCSVLine(lines[i]);
                if (columns.length >= 6 && columns[0]) {
                    const cliente = (columns[0] || '').trim();
                    const processo = (columns[1] || '').trim();
                    data.push({
                        cliente: cliente,
                        processo: processo,
                        valor: (columns[2] || '').trim(),
                        honorarios: (columns[3] || '').trim(),
                        data: (columns[4] || '').trim(),
                        status: (columns[5] || '').trim(),
                        originalIndex: i,
                        uniqueId: `${cliente}-${processo}-${i}`
                    });
                }
            }
            return data;
        }
        
        function updateConnectionStatus(status, message) {
            const el = document.getElementById('connectionStatus');
            if (!el) return;
            el.className = 'connection-status';
            el.classList.add(`status-${status}`);
            const icons = { 'connected': 'fas fa-check-circle', 'error': 'fas fa-exclamation-circle', 'loading': 'fas fa-sync fa-spin' };
            el.innerHTML = `<i class="${icons[status]}"></i> <span id="statusText">${message}</span>`;
        }

        function updateApprovedProcessesView(allApprovedData) {
            const statusMap = { 'APROVADO': [], 'NA CONTA': [], 'PAGO': [] };
            allApprovedData.forEach(item => {
                const status = item.status;
                if (statusMap.hasOwnProperty(status)) {
                    statusMap[status].push(item);
                }
            });
            populatePaymentTable('aprovadoTableBody', statusMap['APROVADO']);
            populatePaymentTable('naContaTableBody', statusMap['NA CONTA']);
            populatePaymentTable('pagoTableBody', statusMap['PAGO']);
        }

        function updateRtmPaymentsView(data) {
            const tableBody = document.getElementById('rtmPaymentsTableBody');
            const todayCounterEl = document.getElementById('rtmTodayCounter');
            if (!tableBody || !todayCounterEl) return;

            let rtmTodayCount = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const sortedData = [...data].sort((a, b) => {
                const dateA = parsePtBrDate(a.data);
                const dateB = parsePtBrDate(b.data);
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateB - dateA;
            });
            
            let html = '';
            sortedData.forEach(payment => {
                const paymentDate = parsePtBrDate(payment.data);
                let formattedDate = '-';
                
                if (paymentDate) {
                    const paymentDay = new Date(paymentDate);
                    paymentDay.setHours(0, 0, 0, 0);
                    if (paymentDay.getTime() === today.getTime()) {
                        rtmTodayCount++;
                    }
                    
                    const datePart = paymentDate.toLocaleDateString('pt-BR');
                    const timePart = paymentDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                    formattedDate = (timePart === '00:00') ? datePart : `${datePart} ${timePart}`;
                }
                
                let cobradorDisplay = 'Equipe';
                if (payment.cobrador) {
                    const cobrador = payment.cobrador.trim();
                    if (cobrador.startsWith('@')) {
                        cobradorDisplay = cobrador.substring(1).split(' ')[0];
                    } else if (cobrador.toLowerCase() !== 'equipe') {
                        cobradorDisplay = cobrador.split(' ')[0];
                    }
                    cobradorDisplay = cobradorDisplay.charAt(0).toUpperCase() + cobradorDisplay.slice(1).toLowerCase();
                }

                html += `<tr>
                    <td><span class="date-badge">${formattedDate}</span></td>
                    <td>${payment.cliente || '-'}</td>
                    <td><span class="process-badge">${payment.valor || '-'}</span></td>
                    <td>${cobradorDisplay}</td>
                </tr>`;
            });
            
            tableBody.innerHTML = html || '<tr><td colspan="4" style="text-align:center; padding: 20px; color: #6b7280;">Nenhum pagamento RTM registrado.</td></tr>';
            todayCounterEl.textContent = rtmTodayCount;
        }
        
        function updateAcordosView(data) {
            const tableBody = document.getElementById('acordosTableBody');
            if (!tableBody) return;

            const statusColors = {
                'TRATATIVA DE ACORDO': '#f59e0b',
                'ACORDO FECHADO': '#10b981',
                'PAGAMENTO EFETUADO': '#8b5cf6',
                'NEGADO': '#ef4444',
            };

            const sortedData = [...data].sort((a, b) => {
                const dateA = parsePtBrDate(a.data);
                const dateB = parsePtBrDate(b.data);
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateB - dateA;
            });

            let html = '';
            sortedData.forEach(acordo => {
                const statusUpper = (acordo.status || '').toUpperCase();
                const bgColor = statusColors[statusUpper] || '#6b7280';

                html += `<tr>
                    <td><span class="date-badge">${acordo.data || '-'}</span></td>
                    <td>${acordo.cliente || '-'}</td>
                    <td>${acordo.processo || '-'}</td>
                    <td><span class="process-badge">${acordo.valor || '-'}</span></td>
                    <td><span class="process-badge" style="background-color: #a78bfa; color: white;">${acordo.honorarios || '-'}</span></td>
                    <td><span class="status-badge" style="background-color: ${bgColor};">${acordo.status || '-'}</span></td>
                </tr>`;
            });
            tableBody.innerHTML = html || '<tr><td colspan="6" style="text-align:center; padding: 20px; color: #6b7280;">Nenhum acordo registrado.</td></tr>';
        }

        function populatePaymentTable(tableBodyId, data) {
            const tableBody = document.getElementById(tableBodyId);
            if (!tableBody) return;

            const sortedData = [...data].sort((a, b) => {
                const dateA = parsePtBrDate(a.data);
                const dateB = parsePtBrDate(b.data);
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateB - dateA;
            });

            let html = '';
            sortedData.forEach(payment => {
                html += `<tr>
                    <td><span class="date-badge">${payment.data || '-'}</span></td>
                    <td>${payment.nome || '-'}</td>
                    <td><span class="process-badge">${payment.processo || '-'}</span></td>
                    <td>${payment.valor || '-'}</td>
                </tr>`;
            });
            tableBody.innerHTML = html || '<tr><td colspan="4" style="text-align:center; padding: 20px; color: #6b7280;">Nenhum processo nesta categoria.</td></tr>';
        }

        function updateProcessCounter(count) {
            const counterElement = document.getElementById('finishedProcesses');
            if (counterElement) {
                const baseCount = 20000;
                const total = baseCount + count;
                counterElement.textContent = total.toLocaleString('pt-BR');
            }
        }
        
        function updateTotalFinishedCounter() {
            const paidPaymentsCount = paymentsData.filter(p => p.status === 'PAGO').length;
            const paidAcordosCount = acordosData.filter(a => (a.status || '').toUpperCase() === 'PAGAMENTO EFETUADO').length;
            
            const totalPaid = paidPaymentsCount + paidAcordosCount;
            updateProcessCounter(totalPaid);
        }

        function populateMonthFilter(dataToScan) {
            const monthSet = new Set();
            const allData = [...dataToScan, ...cearaData];
            (allData || []).forEach(sale => {
                if (sale.data) {
                    const date = parsePtBrDate(sale.data);
                    if (date) {
                         const month = date.getMonth() + 1;
                         const year = date.getFullYear();
                         monthSet.add(`${String(month).padStart(2, '0')}/${year}`);
                    }
                }
            });
            const monthSelect = document.getElementById('monthFilter');
            const currentVal = monthSelect.value;
            const allMonths = Array.from(monthSet).sort((a, b) => {
                const [ma, ya] = a.split('/'); const [mb, yb] = b.split('/');
                return new Date(yb, mb - 1) - new Date(ya, ma - 1);
            });
            monthSelect.innerHTML = '';
            allMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month; option.textContent = month;
                monthSelect.appendChild(option);
            });
            if (allMonths.includes(currentVal)) {
                monthSelect.value = currentVal;
            } else if (allMonths.length > 0) {
                monthSelect.value = allMonths[0];
            }
        }
        
        function getMonthSales() {
            const selectedMonthYear = document.getElementById('monthFilter').value;
            if (!selectedMonthYear) return [];
            const [filterMonth, filterYear] = selectedMonthYear.split('/').map(Number);
            return salesData.filter(sale => {
                const date = parsePtBrDate(sale.data);
                return date && date.getMonth() + 1 === filterMonth && date.getFullYear() === filterYear;
            });
        }
        
        function getMonthCeara() {
            const selectedMonthYear = document.getElementById('monthFilter').value;
            if (!selectedMonthYear) return [];
            const [filterMonth, filterYear] = selectedMonthYear.split('/').map(Number);
            return cearaData.filter(sale => {
                const date = parsePtBrDate(sale.data);
                return date && date.getMonth() + 1 === filterMonth && date.getFullYear() === filterYear;
            });
        }
        
        function updateDashboard() {
            if (document.getElementById('monthFilter').options.length === 0) return;
            const monthSales = getMonthSales();
            const monthCeara = getMonthCeara();
            updateProcessStats(monthSales, monthCeara);
            updateMainStats(monthSales, monthCeara);
            updateConsultantRanking(monthSales, 'consultantRanking', 'topConsultant', 'topConsultantPhoto');
            updateConsultantRanking(monthCeara, 'cearaRanking', 'topConsultantCE', 'topConsultantPhotoCE');
            populateConsultantFilter(monthSales);
            updateMonthSales(monthSales);
            updateProcessEvolutionChart(salesData, cearaData);

        }

        function updateMainStats(monthSalesData, monthCearaData) {
            const totalProcessos = Object.values(currentMonthCounts).reduce((a, b) => a + b, 0);
            document.getElementById('totalMonth').textContent = totalProcessos;
            const selectedMonthYear = document.getElementById('monthFilter').value;
            if (!selectedMonthYear) return;
            const [monthStr, yearStr] = selectedMonthYear.split('/');
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            document.getElementById('monthLabel').textContent = `${monthNames[parseInt(monthStr, 10) - 1]} ${yearStr}`;
            
            const allSales = [...monthSalesData, ...monthCearaData];
            const maxDayInMonth = allSales.reduce((max, sale) => {
                const date = parsePtBrDate(sale.data);
                return date ? Math.max(max, date.getDate()) : max;
            }, 0);

            const dailyAvg = totalProcessos > 0 && maxDayInMonth > 0 ? (totalProcessos / maxDayInMonth) : 0;
            document.getElementById('dailyAverage').textContent = dailyAvg.toFixed(1);
        }

        function getNormalizedConsultantKey(fullName) {
            if (!fullName || typeof fullName !== 'string') return 'desconhecido';
            return fullName.trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().split(' ')[0];
        }

        function getConsultantPhotoUrl(consultantName) {
            if (!consultantName) return DEFAULT_AVATAR;
            const baseName = getNormalizedConsultantKey(consultantName);
            return `${baseName}.PNG`;
        }
        
        function updateConsultantRanking(monthSales, rankingElementId, topConsultantId = null, topPhotoId = null) {
            const stats = {};
            monthSales.forEach(sale => {
                if (!sale.consultor) return;
                const key = getNormalizedConsultantKey(sale.consultor);
                if (!stats[key]) {
                    const displayName = sale.consultor.trim().split(' ')[0];
                    stats[key] = {
                        name: displayName.charAt(0).toUpperCase() + displayName.slice(1).toLowerCase(),
                        sales: 0,
                        processDetails: {}
                    };
                }
                
                (sale.processo || '').split(',').forEach(procRaw => {
                    const proc = procRaw.trim().toUpperCase();
                    if (!proc || proc === DRA_RENATA_STRING) return;
                    stats[key].sales++;
                    stats[key].processDetails[proc] = (stats[key].processDetails[proc] || 0) + 1;
                });
            });

            consultantDetails = { ...consultantDetails, ...stats };
            const ranking = Object.values(stats).sort((a, b) => b.sales - a.sales);
            
            if (topConsultantId && topPhotoId) {
                const topConsultantNameEl = document.getElementById(topConsultantId);
                const topConsultantPhotoEl = document.getElementById(topPhotoId);

                if (ranking.length > 0 && ranking[0].sales > 0) {
                    const topConsultant = ranking[0];
                    const photoUrl = getConsultantPhotoUrl(topConsultant.name);
                    topConsultantNameEl.textContent = topConsultant.name;
                    topConsultantPhotoEl.src = photoUrl;
                    topConsultantPhotoEl.onerror = () => { topConsultantPhotoEl.src = DEFAULT_AVATAR; topConsultantPhotoEl.onerror = null; };
                    topConsultantPhotoEl.style.display = 'inline-block';
                } else {
                    topConsultantNameEl.textContent = '-';
                    topConsultantPhotoEl.style.display = 'none';
                    topConsultantPhotoEl.src = ''; 
                }
            }

            const rankNumberClass = rankingElementId === 'cearaRanking' ? 'rank-number rank-number-ce' : 'rank-number';
            
            let html = '';
            ranking.slice(0, 5).forEach((c, i) => {
                const photoUrl = getConsultantPhotoUrl(c.name);
                const consultantKey = getNormalizedConsultantKey(c.name);
                html += `<div class="ranking-item"><div class="consultant-info"><div class="${rankNumberClass}">${i + 1}</div><img src="${photoUrl}" class="consultant-photo-ranking" onerror="this.src='${DEFAULT_AVATAR}'; this.onerror=null;"><div class="consultant-name">${c.name}</div></div><div class="sales-count" onclick="showProcessDetails('${consultantKey}')">${c.sales}</div></div>`;
            });
            document.getElementById(rankingElementId).innerHTML = html || '<p style="text-align:center;color:#6b7280;padding:20px;">Nenhum processo para o m√™s.</p>';
        }

        function updateProcessStats(monthSales, monthCeara) {
            const metas = { 'PREVIDENCI√ÅRIOS': 600, 'SEGURO TERCEIRO': 35, 'SEGURO DE VIDA': 100 };
            let counts = { previdenciarios: 0, seguroVida: 0, outros: 0, seguroTerceiro: 0 };
            const clientesST = new Set();
            
            const allSales = [...monthSales, ...monthCeara];
            
            allSales.forEach(sale => {
                (sale.processo || '').split(',').forEach(procRaw => {
                    const proc = procRaw.trim().toUpperCase();
                    if (!proc || proc === DRA_RENATA_STRING) return;
                    if (PREVIDENCIARIO_TYPES.includes(proc)) counts.previdenciarios++;
                    else if (SEGURO_VIDA_TYPES.includes(proc)) counts.seguroVida++;
                    else if (SEGURO_TERCEIRO_TYPES.includes(proc)) clientesST.add(sale.cliente);
                    else counts.outros++;
                });
            });
            counts.seguroTerceiro = clientesST.size;
            currentMonthCounts = counts;
            const updateCard = (type, count, meta) => {
                document.getElementById(`${type}Count`).textContent = count;
                const percent = meta > 0 ? Math.min(100, Math.round((count / meta) * 100)) : 0;
                document.getElementById(`${type}Goal`).textContent = `${count}/${meta}`;
                document.getElementById(`${type}Percent`).textContent = percent;
            };
            updateCard('previdenciarios', counts.previdenciarios, metas['PREVIDENCI√ÅRIOS']);
            updateCard('seguroTerceiro', counts.seguroTerceiro, metas['SEGURO TERCEIRO']);
            updateCard('seguroVida', counts.seguroVida, metas['SEGURO DE VIDA']);
            document.getElementById('outrosCount').textContent = counts.outros;
        }
        
        function populateConsultantFilter(monthSales) {
            const consultantFilterSelect = document.getElementById('consultantFilter');
            if (!consultantFilterSelect) return;
            const currentSelection = consultantFilterSelect.value;
            const consultantsMap = new Map();
            monthSales.forEach(sale => {
                if (sale.consultor && sale.consultor.trim() !== "") {
                    const rawName = sale.consultor.trim();
                    const key = getNormalizedConsultantKey(rawName);
                    if (!consultantsMap.has(key)) {
                        const displayName = rawName.split(' ')[0];
                        const formattedName = displayName.charAt(0).toUpperCase() + displayName.slice(1).toLowerCase();
                        consultantsMap.set(key, formattedName);
                    }
                }
            });
            const sortedConsultants = Array.from(consultantsMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
            consultantFilterSelect.innerHTML = '<option value="all">Todos</option>';
            sortedConsultants.forEach(([key, displayName]) => {
                const option = document.createElement('option');
                option.value = key; option.textContent = displayName;
                consultantFilterSelect.appendChild(option);
            });
            if (Array.from(consultantFilterSelect.options).some(opt => opt.value === currentSelection)) {
                consultantFilterSelect.value = currentSelection;
            }
        }
        
        function filterSalesByConsultant() {
            const monthSales = getMonthSales();
            updateMonthSales(monthSales);
        }

        function updateMonthSales(monthSales) {
            const consultantFilterSelect = document.getElementById('consultantFilter');
            const selectedConsultantKey = consultantFilterSelect ? consultantFilterSelect.value : 'all';
            let filteredSales = monthSales;
            if (selectedConsultantKey !== 'all') {
                filteredSales = monthSales.filter(sale => sale.consultor && getNormalizedConsultantKey(sale.consultor) === selectedConsultantKey);
            }
            const sortedSales = [...filteredSales].sort((a, b) => {
                const dateA = parsePtBrDate(a.data);
                const dateB = parsePtBrDate(b.data);
                if (!dateA && !dateB) return b.originalIndex - a.originalIndex;
                if (!dateA) return 1;
                if (!dateB) return -1;
                if (dateB - dateA !== 0) return dateB - dateA;
                return b.originalIndex - a.originalIndex;
            });
let html = '';
            sortedSales.forEach(sale => {
                html += `<tr><td><span class="date-badge">${sale.data || '-'}</span></td><td>${sale.cliente || '-'}</td><td><span class="process-badge">${sale.processo || '-'}</span></td><td>${sale.consultor || '-'}</td></tr>`;
            });
            document.getElementById('recentSalesTable').innerHTML = html || '<tr><td colspan="4" style="text-align:center;padding:20px;color:#6b7280;">Nenhum processo encontrado.</td></tr>';
        }

        function updateProcessEvolutionChart(allSalesData, allCearaData = []) {
            const combinedData = [...allSalesData, ...(allCearaData || [])];
            if (!combinedData || combinedData.length === 0) return;
            const mostRecentYear = Math.max(...combinedData.map(sale => {
                const date = parsePtBrDate(sale.data);
                return date ? date.getFullYear() : 0;
            }).filter(year => year > 1900));
            if (!mostRecentYear) return;
            document.getElementById('chart-subtitle').textContent = `Acompanhamento mensal do ano de ${mostRecentYear}`;
            const monthlyCounts = { 5: 0, 6: 0, 7: 0, 8: 0, 9: 0, 10: 0, 11: 0, 12: 0 };
            combinedData.forEach(sale => {
                if (!sale.processo) return;
                const date = parsePtBrDate(sale.data);
                if (date && date.getFullYear() === mostRecentYear && date.getMonth() + 1 >= 5) {
                    const month = date.getMonth() + 1;
                    const numProcessos = (sale.processo || '').split(',').filter(p => p.trim() && p.trim().toUpperCase() !== DRA_RENATA_STRING).length;
                    if (monthlyCounts.hasOwnProperty(month)) { monthlyCounts[month] += numProcessos; }
                }
            });
            const dataPoints = Object.values(monthlyCounts);
            const lastDataIndex = dataPoints.findLastIndex(d => d > 0);
            const finalDataPoints = dataPoints.map((point, index) => (lastDataIndex === -1 || index <= lastDataIndex) ? point : null);
            const ctx = document.getElementById('processEvolutionChart').getContext('2d');
            const labels = ['Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            if (processEvolutionChartInstance) { processEvolutionChartInstance.destroy(); }
            processEvolutionChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'N√∫mero de Processos', data: finalDataPoints, backgroundColor: 'rgba(139, 92, 246, 0.2)', borderColor: '#8b5cf6', borderWidth: 3, pointBackgroundColor: '#6b46c1', pointRadius: 5, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#6b7280' }, grid: { color: '#f3f4f6' } }, x: { ticks: { color: '#6b7280' }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#6b46c1', titleFont: { size: 14 }, bodyFont: { size: 12 }, padding: 10 } } } });
        }

        function showProcessDetails(consultantKey) {
            const details = consultantDetails[consultantKey];
            if (!details) return;
            const modal = document.getElementById('process-details-modal');
            const titleEl = document.getElementById('modal-title');
            const contentEl = document.getElementById('modal-details-content');
            titleEl.textContent = `Detalhes de ${details.name}`;
            const sortedProcesses = Object.entries(details.processDetails).sort((a, b) => b[1] - a[1]);
            if (sortedProcesses.length === 0) {
                contentEl.innerHTML = '<p>Nenhum detalhe de processo encontrado.</p>';
            } else {
                let listHtml = '<ul class="details-list">';
                sortedProcesses.forEach(([processName, count]) => {
                    const formattedName = processName.charAt(0).toUpperCase() + processName.slice(1).toLowerCase();
                    listHtml += `<li><span class="process-name">${formattedName}</span> <span class="process-count-badge">${count}</span></li>`;
                });
                listHtml += '</ul>';
                contentEl.innerHTML = listHtml;
            }
            modal.style.display = 'flex';
        }

        function closeProcessDetails() {
            document.getElementById('process-details-modal').style.display = 'none';
        }
        
        function filterPayments(statusToShow) {
            document.querySelectorAll('.payment-filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.payment-filter-btn[onclick="filterPayments('${statusToShow}')"]`).classList.add('active');
            
            document.querySelectorAll('.payment-status-section').forEach(section => {
                if (statusToShow === 'all') {
                    section.style.display = 'block';
                } else {
                    section.style.display = section.id === `section-${statusToShow}` ? 'block' : 'none';
                }
            });
        }

        async function fetchAllData() {
            await Promise.allSettled([
                fetchSalesData(),
                fetchCearaData(),
                fetchPaymentsData(),
                fetchRtmPaymentsData(),
                fetchAcordosData() 
            ]);
            
            updateTotalFinishedCounter();
            
            if (salesData.length > 0 || cearaData.length > 0 || paymentsData.length > 0 || rtmPaymentsData.length > 0) {
                 updateConnectionStatus('connected', 'Conectado');
            }
            
            firstLoad = false;
        }

        document.addEventListener('DOMContentLoaded', function() {
            setupCarousel();
            fetchAllData(); 
            setInterval(fetchAllData, 30000);

            const modal = document.getElementById('process-details-modal');
            window.onclick = function(event) {
                if (event.target == modal) {
                    closeProcessDetails();
                }
            }

            const toggleBtn = document.getElementById('carousel-toggle-button');
            const icon = toggleBtn.querySelector('i');
            
            toggleBtn.addEventListener('click', () => {
                carouselPaused = !carouselPaused;
                if (carouselPaused) {
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                    toggleBtn.title = 'Retomar Carrossel';
                    clearInterval(carouselInterval);
                } else {
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                    toggleBtn.title = 'Pausar Carrossel';
                    startCarouselInterval();
                }
            });

            filterPayments('all');
        });
    </script>
</body>
</html>


