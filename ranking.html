Okay, I've modified the JavaScript part of your HTML file to fetch data directly from the Google Sheet using the provided ID and GID. The generateSampleData function is now used as a fallback if the connection to the Google Sheet fails after a few retries.

Here's how it works:

testConnection(): This function now attempts to fetch a small part of the Google Sheet (first row) to verify connectivity and permissions. If successful, it calls manualUpdate().

manualUpdate(): This function resets connection attempt counters and calls fetchSalesData().

fetchSalesData():

Constructs a URL to fetch the Google Sheet data as CSV using the gviz/tq endpoint.

Uses fetch to get the CSV data.

Calls parseCSV() to convert the CSV text into an array of data objects.

If fetching or parsing fails, it increments a retry counter. After maxRetries (3), it falls back to generateSampleData().

On success, it populates salesData with the fetched data and updates the dashboard.

parseCSV(): A new function to parse the CSV data. It handles fields enclosed in double quotes and escaped double quotes ("") within fields. It skips the header row from the CSV.

Error Handling: Enhanced logging and status updates provide feedback on connection attempts and errors.

The rest of your HTML and CSS, as well as the data processing logic (processSalesData, updateDashboard, etc.), remain the same as they correctly operate on the salesData array once it's populated.

Here's the complete HTML file with the updated JavaScript:

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas - Tempo Real</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.1);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #8b5cf6, #6b46c1, #a78bfa);
        }

        .header h1 {
            color: #6b46c1;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header h1 i {
            background: linear-gradient(135deg, #8b5cf6, #6b46c1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .subtitle {
            color: #8b5cf6;
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .connection-status {
            margin: 15px 0;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-connected {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .status-loading {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .config-panel {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 1px solid rgba(147, 51, 234, 0.1);
        }

        .config-panel h3 {
            color: #6b46c1;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
        }

        .config-item label {
            color: #6b46c1;
            font-size: 0.9rem;
            margin-bottom: 5px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-item input, .config-item select {
            padding: 10px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .config-item input:focus, .config-item select:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #8b5cf6;
            color: white;
        }

        .btn-primary:hover {
            background: #7c3aed;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #d1d5db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(156, 163, 175, 0.25);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(147, 51, 234, 0.15);
        }

        .stat-card h3 {
            color: #6b46c1;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #8b5cf6;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-label {
            color: #a78bfa;
            font-size: 0.9rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.1);
            position: relative;
            overflow: hidden;
        }

        .panel::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
        }

        .panel h2 {
            color: #6b46c1;
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
            padding-bottom: 10px;
            border-bottom: 2px solid #f3f4f6;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 15px 10px;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .consultant-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .rank-number {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .consultant-name {
            color: #374151;
            font-weight: 500;
        }

        .sales-count {
            background: #e8ecff;
            color: #6b46c1;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 40px;
            text-align: center;
        }

        .process-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .process-card {
            background: linear-gradient(135deg, #f8f9ff, #e8ecff);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(147, 51, 234, 0.1);
            transition: transform 0.3s ease;
        }

        .process-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(139, 92, 246, 0.1);
        }

        .process-card h4 {
            color: #6b46c1;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .process-number {
            font-size: 2rem;
            font-weight: 700;
            color: #8b5cf6;
        }

        .recent-sales {
            grid-column: 1 / -1;
        }

        .sales-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .sales-table th {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sales-table th:first-child {
            border-radius: 10px 0 0 0;
        }

        .sales-table th:last-child {
            border-radius: 0 10px 0 0;
        }

        .sales-table td {
            padding: 15px;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
        }

        .sales-table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .sales-table tr:hover {
            background: #f8f9ff;
        }

        .process-badge {
            background: #e8ecff;
            color: #6b46c1;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }

        .date-badge {
            background: #f3f4f6;
            color: #6b7280;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-block;
        }

        .update-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .logs {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #374151;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
            line-height: 1.4;
        }

        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-warning { color: #f59e0b; }
        .log-info { color: #3b82f6; }

        .instructions-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            margin: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-header {
            color: #6b46c1;
            font-size: 1.5rem;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-modal {
            font-size: 1.8rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #ef4444;
        }

        .modal-content h4 {
            color: #6b46c1;
            margin: 20px 0 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-content ol, .modal-content ul {
            padding-left: 20px;
            margin-bottom: 20px;
        }

        .modal-content li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .modal-content strong {
            color: #6b46c1;
        }

        .last-update {
            text-align: right;
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 15px;
        }

        .footer {
            text-align: center;
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 20px;
            padding: 20px;
        }

        .month-selector {
            background: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .month-selector label {
            font-weight: 600;
            color: #6b46c1;
        }

        .month-selector select {
            padding: 8px 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            color: #374151;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .update-indicator {
                top: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
                justify-content: center;
            }

            .month-selector {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        
        /* Novo estilo para badge de m√∫ltiplos processos */
        .multi-badge {
            background: #f3e8ff;
            border: 1px dashed #8b5cf6;
            border-radius: 6px;
            padding: 3px 8px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin: 2px;
        }
    </style>
</head>
<body>
    <div class="update-indicator" id="updateIndicator">
        <i class="fas fa-sync-alt fa-spin"></i> Carregando dados...
    </div>
    
    <div class="dashboard">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Dashboard de Vendas - ReVive</h1>
            <p class="subtitle">Rumo aos cem mil processos at√© 2030!</p>
            
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-sync fa-spin"></i>
                <span id="statusText">Verificando conex√£o...</span>
            </div>

            <div class="config-panel">
                <h3><i class="fas fa-cog"></i> Configura√ß√£o da Planilha</h3>
                <div class="config-grid">
                    <div class="config-item">
                        <label for="sheetId"><i class="fas fa-key"></i> ID da Planilha:</label>
                        <input type="text" id="sheetId" value="1fSTEyMmAEgfMnAFUTdYbJah5dr8OudsEsqjKHnHwFms" placeholder="ID da sua planilha do Google Sheets">
                    </div>
                    <div class="config-item">
                        <label for="sheetGid"><i class="fas fa-table"></i> GID da Aba (opcional):</label>
                        <input type="text" id="sheetGid" value="1536647709" placeholder="ID num√©rico da aba">
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="testConnection()">
                        <i class="fas fa-link"></i> Testar Conex√£o
                    </button>
                    <button class="btn btn-primary" onclick="manualUpdate()">
                        <i class="fas fa-sync"></i> Atualizar Dados
                    </button>
                    <button class="btn btn-secondary" onclick="toggleAutoUpdate()">
                        <i class="fas fa-pause"></i> <span id="autoUpdateText">Pausar Auto-Update</span>
                    </button>
                    <button class="btn btn-secondary" onclick="showInstructions()">
                        <i class="fas fa-info-circle"></i> Instru√ß√µes
                    </button>
                </div>

                <div class="logs" id="logContainer">
                    <div class="log-entry log-info">Sistema iniciado - Aguardando primeira conex√£o...</div>
                </div>
            </div>
        </div>

        <!-- Seletor de m√™s -->
        <div class="month-selector">
            <label for="monthFilter"><i class="fas fa-calendar"></i> Selecionar M√™s:</label>
            <select id="monthFilter" onchange="updateDashboard()">
                <!-- Os meses ser√£o preenchidos via JavaScript -->
            </select>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3><i class="fas fa-sun"></i> Clientes do M√™s</h3>
                <div class="stat-value" id="totalMonth">-</div>
                <div class="stat-label" id="monthLabel">-</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-trophy"></i> Melhor Consultor</h3>
                <div class="stat-value">üèÜ <span id="topConsultant">-</span></div>
                <div class="stat-label">em vendas este m√™s</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-chart-bar"></i> M√©dia Di√°ria</h3>
                <div class="stat-value" id="dailyAverage">-</div>
                <div class="stat-label">processos/dia</div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2><i class="fas fa-trophy"></i> Ranking de Consultores</h2>
                <div id="consultantRanking">
                    <div style="text-align: center; color: #6b7280; padding: 40px;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p style="margin-top: 15px;">Carregando dados...</p>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2><i class="fas fa-chart-pie"></i> Tipos de Processo</h2>
                <div class="process-stats">
                    <div class="process-card">
                        <h4>Previdenci√°rios</h4>
                        <div class="process-number" id="previdenciariosCount">-</div>
                    </div>
                    <div class="process-card">
                        <h4>Seguro Terceiro</h4>
                        <div class="process-number" id="seguroTerceiroCount">-</div>
                    </div>
                    <div class="process-card">
                        <h4>Seguro de Vida</h4>
                        <div class="process-number" id="seguroVidaCount">-</div>
                    </div>
                    <div class="process-card">
                        <h4>Outros</h4>
                        <div class="process-number" id="outrosCount">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel recent-sales">
            <h2><i class="fas fa-clock"></i> Vendas do M√™s</h2>
            <table class="sales-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Processo</th>
                        <th>Consultor</th>
                    </tr>
                </thead>
                <tbody id="recentSalesTable">
                    <tr>
                        <td colspan="4" style="text-align: center; color: #6b7280; padding: 40px;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando vendas...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            Dashboard de Vendas em Tempo Real ‚Ä¢ Atualizado em: <span id="lastUpdateTime">-</span>
        </div>
    </div>

    <!-- Modal de Instru√ß√µes -->
    <div class="instructions-modal" id="instructionsModal">
        <div class="modal-content">
            <div class="modal-header">
                <span>üìã Instru√ß√µes de Uso</span>
                <span class="close-modal" onclick="hideInstructions()">√ó</span>
            </div>
            <div>
                <h4><i class="fas fa-table"></i> Como configurar sua planilha do Google Sheets:</h4>
                <ol>
                    <li><strong>Torne a planilha p√∫blica:</strong> V√° em "Arquivo" > "Compartilhar" > "Publicar na Web". Certifique-se de que est√° publicada. Depois, em "Compartilhar" (bot√£o verde/azul), mude a op√ß√£o "Restrito" para "Qualquer pessoa com o link" e defina o papel como "Leitor". Isso √© crucial para a API de visualiza√ß√£o funcionar.</li>
                    <li><strong>Obtenha o ID da planilha:</strong> Copie da URL. Se a URL for `https://docs.google.com/spreadsheets/d/1fSTEyMmAEgfMnAFUTdYbJah5dr8OudsEsqjKHnHwFms/edit#gid=1536647709`, o ID √© `1fSTEyMmAEgfMnAFUTdYbJah5dr8OudsEsqjKHnHwFms`.</li>
                    <li><strong>GID da aba (opcional, mas recomendado):</strong> Para abas espec√≠ficas, use o n√∫mero ap√≥s `gid=` na URL. No exemplo acima, o GID √© `1536647709`. Se n√£o for fornecido, tentar√° carregar a primeira aba vis√≠vel.</li>
                </ol>
                
                <h4><i class="fas fa-columns"></i> Estrutura esperada da planilha (primeira linha √© cabe√ßalho, ignorado):</h4>
                <ul>
                    <li><strong>Coluna A:</strong> Tipo de Processo (pode conter m√∫ltiplos separados por v√≠rgula, ex: "VIDA, AUXILIO-ACIDENTE")</li>
                    <li><strong>Coluna B:</strong> Nome do Cliente</li>
                    <li><strong>Coluna C:</strong> Link (opcional, n√£o utilizado pelo dashboard)</li>
                    <li><strong>Coluna D:</strong> Data (formato: DD/MM/AAAA)</li>
                    <li><strong>Coluna E:</strong> Nome do Consultor</li>
                </ul>
                <p><em>Importante:</em> A primeira linha da sua aba deve ser o cabe√ßalho (ex: TIPO, CLIENTE, LINK, DATA, CONSULTOR). Os dados reais devem come√ßar da segunda linha.</p>
                
                <h4><i class="fas fa-star"></i> Recursos do Dashboard:</h4>
                <ul>
                    <li><strong>Conex√£o Real:</strong> Busca dados diretamente da sua Google Sheet.</li>
                    <li><strong>Contagem m√∫ltipla:</strong> Cada processo na mesma linha √© contabilizado individualmente.</li>
                    <li><strong>Filtro por m√™s:</strong> Selecione o m√™s para visualizar as vendas.</li>
                    <li><strong>Auto-update:</strong> Atualiza automaticamente a cada 30 segundos (pode ser pausado).</li>
                    <li><strong>Fallback:</strong> Caso n√£o consiga conectar ap√≥s v√°rias tentativas, mostra dados demonstrativos.</li>
                    <li><strong>Logs detalhados:</strong> Registra as opera√ß√µes de conex√£o e processamento.</li>
                </ul>
                
                <div class="last-update">
                    <i class="fas fa-info-circle"></i> √öltima atualiza√ß√£o do dashboard: <span id="modalLastUpdate">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let salesData = [];
        let lastUpdate = null;
        let autoUpdateInterval = null;
        let isAutoUpdateActive = true;
        let connectionAttempts = 0;
        const maxRetries = 3; // M√°ximo de tentativas de conex√£o antes de usar dados de exemplo
        let months = []; // N√£o parece ser usada globalmente, mas mantida por ora.
        
        // Fun√ß√£o para adicionar logs
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            // Insere no topo
            if (logContainer.firstChild) {
                logContainer.insertBefore(logEntry, logContainer.firstChild);
            } else {
                logContainer.appendChild(logEntry);
            }
            
            // Manter apenas os √∫ltimos N logs (ex: 20)
            const maxLogs = 20;
            const logs = logContainer.querySelectorAll('.log-entry');
            if (logs.length > maxLogs) {
                logContainer.removeChild(logs[logs.length - 1]);
            }
        }

        // Fun√ß√£o para atualizar status da conex√£o
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            const statusTextElement = document.getElementById('statusText'); // Re-get in case innerHTML changed it
            
            statusElement.className = 'connection-status'; // Reset classes
            statusElement.classList.add(`status-${status}`);
            
            const icons = {
                'connected': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'loading': 'fas fa-sync fa-spin'
            };
            
            statusElement.innerHTML = `<i class="${icons[status]}"></i> <span id="statusText">${message}</span>`;
        }

        // Fun√ß√£o para testar conex√£o com a planilha
        async function testConnection() {
            updateConnectionStatus('loading', 'Testando conex√£o...');
            addLog('Iniciando teste de conex√£o com a planilha', 'info');

            const sheetId = document.getElementById('sheetId').value.trim();
            const sheetGid = document.getElementById('sheetGid').value.trim();

            if (!sheetId) {
                updateConnectionStatus('error', 'ID da Planilha n√£o fornecido para teste.');
                addLog('Teste de conex√£o falhou: ID da Planilha n√£o fornecido.', 'error');
                return;
            }

            // Fetch a small part of the sheet (e.g., first 2 rows to include header and one data row)
            let testUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&range=A1:E2`;
            if (sheetGid) {
                testUrl += `&gid=${sheetGid}`;
            }
            testUrl += `&v=${new Date().getTime()}`; // Cache buster

            try {
                const response = await fetch(testUrl);
                if (!response.ok) {
                    let errorText = `Erro HTTP: ${response.status} ${response.statusText}.`;
                     // Try to parse Google's specific error message if HTML response
                    if (response.headers.get("content-type")?.includes("text/html")) {
                        const htmlError = await response.text();
                        const match = htmlError.match(/google\.visualization\.Query\.setResponse\s*\(\s*(\{[\s\S]*?\})\s*\)/);
                        if (match && match[1]) {
                            try {
                                const errorObj = JSON.parse(match[1]);
                                if (errorObj.errors && errorObj.errors.length > 0) {
                                   errorText += ` Detalhe: ${errorObj.errors[0].detailed_message || errorObj.errors[0].message}`;
                                }
                            } catch (e) { /* ignore parsing error */ }
                        }
                    }
                    throw new Error(`${errorText} Verifique se a planilha √© p√∫blica ("Qualquer pessoa com o link pode ver"), o ID da Planilha e o GID da Aba est√£o corretos.`);
                }
                // const csvSample = await response.text(); // Don't need to parse for test
                // addLog(`Resposta do teste (amostra): ${csvSample.substring(0, 100)}...`, 'info');

                updateConnectionStatus('connected', 'Conex√£o estabelecida com sucesso!');
                addLog('Teste de conex√£o bem-sucedido!', 'success');
                manualUpdate(); // Proceed to fetch all data
            } catch (error) {
                updateConnectionStatus('error', `Falha na conex√£o: ${error.message}`);
                addLog(`Teste de conex√£o falhou: ${error.message}`, 'error');
            }
        }

        // Fun√ß√£o para atualiza√ß√£o manual
        function manualUpdate() {
            updateConnectionStatus('loading', 'Atualizando dados...');
            addLog('Solicitada atualiza√ß√£o manual de dados', 'info');
            connectionAttempts = 0; // Reset attempts for a manual refresh
            fetchSalesData();
        }

        // Fun√ß√£o para alternar auto-update
        function toggleAutoUpdate() {
            isAutoUpdateActive = !isAutoUpdateActive;
            const buttonText = document.getElementById('autoUpdateText');
            const iconElement = buttonText.previousElementSibling; // Get the <i> element
            
            if (isAutoUpdateActive) {
                buttonText.textContent = 'Pausar Auto-Update';
                iconElement.className = 'fas fa-pause';
                addLog('Auto-atualiza√ß√£o ativada', 'success');
                if (salesData.length > 0) { // If data already loaded
                    updateConnectionStatus('connected', 'Auto-atualiza√ß√£o ativada.');
                } else { // If no data yet, it might be in error or loading
                     updateConnectionStatus('loading', 'Auto-atualiza√ß√£o ativada, aguardando dados...');
                }
                startAutoUpdate();
                fetchSalesData(); // Fetch immediately when re-enabled
            } else {
                buttonText.textContent = 'Retomar Auto-Update';
                iconElement.className = 'fas fa-play';
                addLog('Auto-atualiza√ß√£o pausada', 'warning');
                updateConnectionStatus('connected', 'Auto-atualiza√ß√£o pausada.');
                clearInterval(autoUpdateInterval);
                autoUpdateInterval = null;
            }
        }

        // Fun√ß√£o para iniciar auto-update
        function startAutoUpdate() {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
            }
            if(isAutoUpdateActive) {
                autoUpdateInterval = setInterval(() => {
                    addLog('Atualiza√ß√£o autom√°tica em andamento...', 'info');
                    fetchSalesData();
                }, 30000); // Atualiza a cada 30 segundos
            }
        }

        // Fun√ß√£o para mostrar instru√ß√µes
        function showInstructions() {
            document.getElementById('instructionsModal').style.display = 'flex';
            document.getElementById('modalLastUpdate').textContent = lastUpdate || 'N/A';
        }

        // Fun√ß√£o para esconder instru√ß√µes
        function hideInstructions() {
            document.getElementById('instructionsModal').style.display = 'none';
        }

        // Fun√ß√£o para parsear CSV
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/); // Handle Windows and Unix newlines
            const data = [];

            if (lines.length < 2) { // Expect at least a header and one data line
                addLog("CSV n√£o cont√©m dados suficientes (cabe√ßalho ausente ou sem linhas de dados).", "warning");
                return [];
            }

            // Skip header line (lines[0]) by starting loop at i = 1
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue; // Skip empty lines

                const rowValues = [];
                let currentVal = "";
                let inQuotes = false;

                for (let k = 0; k < line.length; k++) {
                    let char = line[k];
                    if (char === '"') {
                        if (inQuotes && k + 1 < line.length && line[k+1] === '"') { // Escaped double quote ("")
                            currentVal += '"';
                            k++; // Skip the second quote of the pair
                        } else {
                            inQuotes = !inQuotes; // Toggle quote state
                        }
                    } else if (char === ',' && !inQuotes) { // Comma delimiter, only if not inside quotes
                        rowValues.push(currentVal);
                        currentVal = "";
                    } else {
                        currentVal += char; // Character is part of the current field
                    }
                }
                rowValues.push(currentVal); // Add the last field value
                data.push(rowValues);
            }
            return data;
        }
        
        // Fun√ß√£o para buscar dados de vendas da planilha
        async function fetchSalesData() {
            addLog('Iniciando busca de dados da planilha...', 'info');
            updateConnectionStatus('loading', 'Buscando dados da planilha...');
            document.getElementById('updateIndicator').style.display = 'flex';
            document.getElementById('updateIndicator').innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Carregando dados...';


            const sheetId = document.getElementById('sheetId').value.trim();
            const sheetGid = document.getElementById('sheetGid').value.trim();

            if (!sheetId) {
                addLog('ID da Planilha n√£o fornecido. Usando dados de exemplo.', 'warning');
                updateConnectionStatus('error', 'ID da Planilha n√£o configurado.');
                generateSampleData(); // Fallback
                processSalesData();
                updateDashboardUI();
                document.getElementById('updateIndicator').innerHTML = '<i class="fas fa-exclamation-triangle"></i> ID n√£o configurado. Usando dados de exemplo.';
                setTimeout(() => { document.getElementById('updateIndicator').style.display = 'none'; }, 3000);
                return;
            }

            let sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;
            if (sheetGid) {
                sheetUrl += `&gid=${sheetGid}`;
            }
            sheetUrl += `&v=${new Date().getTime()}`; // Cache buster

            try {
                addLog(`Tentando buscar de: ${sheetId} (GID: ${sheetGid || 'padr√£o'})`, 'info');
                const response = await fetch(sheetUrl);

                if (!response.ok) {
                     let errorText = `Erro HTTP: ${response.status} ${response.statusText}.`;
                    if (response.headers.get("content-type")?.includes("text/html")) {
                        const htmlError = await response.text();
                        const match = htmlError.match(/google\.visualization\.Query\.setResponse\s*\(\s*(\{[\s\S]*?\})\s*\)/);
                        if (match && match[1]) {
                            try {
                                const errorObj = JSON.parse(match[1]);
                                if (errorObj.errors && errorObj.errors.length > 0) {
                                   errorText += ` Detalhe: ${errorObj.errors[0].detailed_message || errorObj.errors[0].message}`;
                                }
                            } catch (e) { /* ignore parsing error */ }
                        }
                    }
                    throw new Error(`${errorText} Verifique permiss√µes e IDs.`);
                }

                const csvText = await response.text();
                if (!csvText || csvText.trim() === "") {
                    throw new Error("Resposta CSV vazia. Planilha pode estar vazia ou inacess√≠vel.");
                }

                const parsedCsvRows = parseCSV(csvText);

                salesData = parsedCsvRows.map(row => {
                    // Colunas: A: Tipo, B: Cliente, C: Link (ignorar), D: Data, E: Consultor
                    if (row.length < 5) { // Expecting at least 5 columns as per structure
                        addLog(`Linha ignorada por ter ${row.length} colunas (esperado >= 5): ${row.join('|')}`, 'warning');
                        return null;
                    }
                    return {
                        tipo: row[0] || '',      // Coluna A (Tipo de Processo)
                        cliente: row[1] || '',   // Coluna B (Nome do Cliente)
                        // Link (row[2]) √© ignorado
                        data: row[3] || '',      // Coluna D (Data)
                        consultor: row[4] || ''  // Coluna E (Nome do Consultor)
                    };
                }).filter(item => {
                    // Basic validation: ensure essential fields are present
                    return item !== null && item.data && item.consultor && item.tipo;
                });

                if (salesData.length === 0 && parsedCsvRows.length > 0) {
                     addLog('Nenhum dado v√°lido encontrado ap√≥s parse. Verifique formato das colunas e conte√∫do da planilha. Todas as linhas foram filtradas.', 'warning');
                } else if (salesData.length === 0) {
                     addLog('Nenhum dado retornado ou planilha vazia (ap√≥s cabe√ßalho).', 'warning');
                }


                lastUpdate = new Date().toLocaleString('pt-BR');
                document.getElementById('lastUpdateTime').textContent = lastUpdate;
                
                processSalesData();
                updateDashboardUI(); // Changed from updateDashboard to avoid confusion
                
                updateConnectionStatus('connected', 'Dados atualizados com sucesso da planilha!');
                addLog(`Dados carregados da planilha: ${salesData.length} registros v√°lidos.`, 'success');
                document.getElementById('updateIndicator').innerHTML = '<i class="fas fa-check-circle"></i> Dados atualizados!';
                setTimeout(() => { document.getElementById('updateIndicator').style.display = 'none'; }, 2000);
                
                connectionAttempts = 0; // Reset retries on success

                if (isAutoUpdateActive && !autoUpdateInterval) {
                    startAutoUpdate();
                }

            } catch (error) {
                addLog(`Erro ao buscar/processar dados da planilha: ${error.message}`, 'error');
                connectionAttempts++;
                
                if (connectionAttempts >= maxRetries) {
                    updateConnectionStatus('error', `Falha ap√≥s ${maxRetries} tentativas. Usando dados de exemplo.`);
                    addLog(`M√°ximo de tentativas (${maxRetries}) atingido. Usando dados de exemplo. Verifique console para detalhes.`, 'error');
                    console.error("Detailed error leading to fallback:", error);
                    generateSampleData(); // Fallback to sample data
                    processSalesData();
                    updateDashboardUI();
                    document.getElementById('updateIndicator').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Falha. Usando dados de exemplo.';
                    setTimeout(() => { document.getElementById('updateIndicator').style.display = 'none'; }, 3000);
                    // connectionAttempts = 0; // Reset for next manual attempt cycle or keep it to prevent immediate retries
                } else {
                    updateConnectionStatus('error', `Erro (${connectionAttempts}/${maxRetries}): ${error.message.substring(0,100)}...`);
                     if (isAutoUpdateActive) {
                        addLog(`Pr√≥xima tentativa autom√°tica em 30 segundos.`, 'info');
                    }
                }
            }
        }


        // Fun√ß√£o para gerar dados de exemplo (FALLBACK)
        function generateSampleData() {
            addLog('Gerando dados de exemplo como fallback.', 'warning');
            const consultants = ['Ana Silva', 'Carlos Oliveira', 'Mariana Costa', 'Pedro Santos', 'Juliana Pereira'];
            const processTypes = ['VIDA', 'AUXILIO-ACIDENTE', 'PREVIDENCIARIO', 'SEGURO-TERCEIRO', 'OUTROS'];
            const clients = ['Cliente Exemplo A', 'Cliente Exemplo B', 'Cliente Exemplo C', 'Cliente Exemplo D', 'Cliente Exemplo E'];
            
            const tempData = [];
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            for (let i = 0; i < 30; i++) { // Reduced sample size
                const monthOffset = Math.floor(Math.random() * 3); // Sample for last 3 months
                const day = Math.floor(Math.random() * 28) + 1;
                const month = (currentMonth - monthOffset + 12) % 12;
                const year = month > currentMonth ? currentYear - 1 : currentYear;
                
                const processCount = Math.floor(Math.random() * 2) + 1; // 1-2 processes
                const processes = [];
                for (let j = 0; j < processCount; j++) {
                    processes.push(processTypes[Math.floor(Math.random() * processTypes.length)]);
                }
                
                tempData.push({
                    tipo: processes.join(', '),
                    cliente: clients[Math.floor(Math.random() * clients.length)],
                    data: `${day.toString().padStart(2, '0')}/${(month + 1).toString().padStart(2, '0')}/${year}`,
                    consultor: consultants[Math.floor(Math.random() * consultants.length)]
                });
            }
            salesData = tempData; // Assign to global salesData
            lastUpdate = new Date().toLocaleString('pt-BR') + " (Exemplo)";
            document.getElementById('lastUpdateTime').textContent = lastUpdate;
        }

        // Fun√ß√£o para processar dados de vendas (com contagem m√∫ltipla)
        function processSalesData() {
            // This function now primarily prepares data for UI updates.
            // Actual data filtering for month happens here.
            // UI elements are updated in updateDashboardUI() based on processed values.
            
            populateMonthSelector(); // Ensure month selector is up-to-date with available data
            
            const selectedMonthFilter = document.getElementById('monthFilter').value;
            
            const currentMonthData = selectedMonthFilter === 'all' 
                ? salesData 
                : salesData.filter(item => {
                    if (!item.data || typeof item.data !== 'string' || !item.data.includes('/')) return false;
                    const parts = item.data.split('/');
                    if (parts.length < 3) return false;
                    const [day, month, year] = parts;
                    return `${month}/${year}` === selectedMonthFilter;
                });

            // Counts for the *filtered* data
            const processCounts = { 'PREVIDENCIARIO': 0, 'SEGURO-TERCEIRO': 0, 'VIDA': 0, 'OUTROS': 0 };
            const consultantSales = {};
            
            currentMonthData.forEach(item => {
                const tipos = item.tipo.split(',').map(t => t.trim().toUpperCase());
                tipos.forEach(tipo => {
                    if (tipo.includes('PREVIDEN')) processCounts['PREVIDENCIARIO']++;
                    else if (tipo.includes('TERCEIRO') || tipo.includes('TERCEIROS')) processCounts['SEGURO-TERCEIRO']++;
                    else if (tipo.includes('VIDA')) processCounts['VIDA']++;
                    else if (tipo) processCounts['OUTROS']++; // Ensure 'tipo' is not empty
                });
                if (item.consultor) { // Ensure consultant is not empty
                   consultantSales[item.consultor] = (consultantSales[item.consultor] || 0) + tipos.filter(t=>t).length; // Count only non-empty tipos
                }
            });
            
            // Store processed data for UI update
            window.dashboardProcessedData = {
                processCounts,
                consultantSales,
                currentMonthData,
                totalProcesses: Object.values(processCounts).reduce((a, b) => a + b, 0)
            };
        }

        // Fun√ß√£o para preencher seletor de meses
        function populateMonthSelector() {
            const monthSelector = document.getElementById('monthFilter');
            const currentSelectedValue = monthSelector.value; // Preserve selection if possible
            monthSelector.innerHTML = ''; // Clear options
            
            const monthSet = new Set();
            salesData.forEach(item => {
                if (!item.data || typeof item.data !== 'string' || !item.data.includes('/')) return;
                const parts = item.data.split('/');
                if (parts.length < 3) return;
                const [day, month, year] = parts;
                monthSet.add(`${month}/${year}`);
            });
            
            const sortedMonths = Array.from(monthSet).sort((a, b) => {
                const [aMonth, aYear] = a.split('/');
                const [bMonth, bYear] = b.split('/');
                return new Date(bYear, bMonth - 1) - new Date(aYear, aMonth - 1);
            });
            
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'Todos os meses';
            monthSelector.appendChild(allOption);
            
            const monthNames = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            sortedMonths.forEach(monthYear => {
                const [month, year] = monthYear.split('/');
                const option = document.createElement('option');
                option.value = monthYear;
                option.textContent = `${monthNames[parseInt(month) - 1]} de ${year}`;
                monthSelector.appendChild(option);
            });

            if (currentSelectedValue && monthSelector.querySelector(`option[value="${currentSelectedValue}"]`)) {
                monthSelector.value = currentSelectedValue;
            } else if (sortedMonths.length > 0) {
                 // Default to the most recent month if "all" wasn't selected or doesn't exist as a prior selection
                 if (currentSelectedValue !== 'all') monthSelector.value = sortedMonths[0];
            }
        }
        
        // Fun√ß√£o para ATUALIZAR A INTERFACE DO DASHBOARD com os dados processados
        function updateDashboardUI() {
            const { processCounts, consultantSales, currentMonthData, totalProcesses } = window.dashboardProcessedData || { processCounts:{}, consultantSales:{}, currentMonthData:[], totalProcesses:0};

            document.getElementById('previdenciariosCount').textContent = processCounts['PREVIDENCIARIO'] || 0;
            document.getElementById('seguroTerceiroCount').textContent = processCounts['SEGURO-TERCEIRO'] || 0;
            document.getElementById('seguroVidaCount').textContent = processCounts['VIDA'] || 0;
            document.getElementById('outrosCount').textContent = processCounts['OUTROS'] || 0;
            
            document.getElementById('totalMonth').textContent = totalProcesses;
            
            let topConsultantName = '-';
            let topSalesCount = 0;
            Object.entries(consultantSales).forEach(([consultant, sales]) => {
                if (sales > topSalesCount) {
                    topSalesCount = sales;
                    topConsultantName = consultant;
                }
            });
            document.getElementById('topConsultant').textContent = topConsultantName || '-';
            
            if (currentMonthData.length > 0 && totalProcesses > 0) {
                const uniqueDates = [...new Set(currentMonthData.map(item => item.data))];
                const dailyAvg = uniqueDates.length > 0 ? (totalProcesses / uniqueDates.length).toFixed(1) : '0.0';
                document.getElementById('dailyAverage').textContent = dailyAvg;
            } else {
                document.getElementById('dailyAverage').textContent = '0.0';
            }
            
            updateConsultantRankingUI(consultantSales);
            updateRecentSalesTableUI(currentMonthData);

            // Update month label
            const monthSelector = document.getElementById('monthFilter');
            const selectedOption = monthSelector.options[monthSelector.selectedIndex];
            document.getElementById('monthLabel').textContent = selectedOption ? selectedOption.textContent : '-';
        }


        // Fun√ß√£o para atualizar ranking de consultores NA UI
        function updateConsultantRankingUI(consultantSales) {
            const rankingContainer = document.getElementById('consultantRanking');
            rankingContainer.innerHTML = ''; // Clear previous
            
            const sortedConsultants = Object.entries(consultantSales)
                .sort((a, b) => b[1] - a[1]); // Sort by sales descending
            
            if (sortedConsultants.length === 0) {
                rankingContainer.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">Nenhum dado de consultor dispon√≠vel para este per√≠odo.</div>';
                return;
            }
            
            sortedConsultants.forEach(([consultant, sales], index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'ranking-item';
                itemDiv.innerHTML = `
                    <div class="consultant-info">
                        <div class="rank-number">${index + 1}</div>
                        <div class="consultant-name">${consultant}</div>
                    </div>
                    <div class="sales-count">${sales}</div>
                `;
                rankingContainer.appendChild(itemDiv);
            });
        }

        // Fun√ß√£o para atualizar tabela de vendas recentes NA UI
        function updateRecentSalesTableUI(data) {
            const tableBody = document.getElementById('recentSalesTable');
            tableBody.innerHTML = ''; // Clear previous
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6b7280; padding: 20px;">Nenhuma venda encontrada para este per√≠odo.</td></tr>';
                return;
            }
            
            // Show most recent first, limit to e.g. 10 or 20.
            // Assuming data is already somewhat sorted or we sort it by date if necessary.
            // For now, just take the last N items from the filtered data (which might not be date sorted from GSheet)
            // To sort by date properly:
            const sortedData = [...data].sort((a,b) => {
                const dateA = new Date(a.data.split('/').reverse().join('-'));
                const dateB = new Date(b.data.split('/').reverse().join('-'));
                return dateB - dateA; //Descending
            });

            const recentDataToDisplay = sortedData.slice(0, 15); // Show top 15 recent
            
            recentDataToDisplay.forEach(item => {
                const tr = document.createElement('tr');
                const tipos = item.tipo.split(',').map(t => t.trim()).filter(t => t);
                const processBadges = tipos.map(tipo => `<span class="multi-badge">${tipo}</span>`).join(' ');
                
                tr.innerHTML = `
                    <td><span class="date-badge">${item.data}</span></td>
                    <td>${item.cliente}</td>
                    <td>${processBadges || '-'}</td>
                    <td>${item.consultor}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // Fun√ß√£o chamada na mudan√ßa do seletor de m√™s
        function updateDashboard() { // Renamed from original updateDashboard to avoid conflict
            addLog(`Filtro de m√™s alterado. Re-processando dados.`, 'info');
            processSalesData(); // Reprocess data based on new month selection
            updateDashboardUI();   // Update the UI elements
        }

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            addLog('Dashboard inicializado. Tentando conectar...', 'info');
            testConnection(); // This will attempt connection and then call manualUpdate -> fetchSalesData
            // Initial auto-update will be started by fetchSalesData if successful and active
        });
    </script>
</body>
</html>
