<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas - Tempo Real</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%); min-height: 100vh; padding: 20px; color: #333; }
        .dashboard { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 8px 32px rgba(147, 51, 234, 0.1); border: 1px solid rgba(147, 51, 234, 0.1); position: relative; overflow: hidden; }
        .header::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(90deg, #8b5cf6, #6b46c1, #a78bfa); }
        .header h1 { color: #6b46c1; font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .header h1 i { background: linear-gradient(135deg, #8b5cf6, #6b46c1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header .subtitle { color: #8b5cf6; font-size: 1.1rem; opacity: 0.8; }
        .connection-status { margin: 15px auto; padding: 10px 15px; border-radius: 10px; font-size: 0.9rem; font-weight: 500; display: inline-flex; align-items: center; gap: 10px; max-width: 300px; }
        .status-connected { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .status-error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .status-loading { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 32px rgba(147, 51, 234, 0.1); border: 1px solid rgba(147, 51, 234, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; overflow: hidden; }
        .stat-card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(147, 51, 234, 0.15); }
        .stat-card h3 { color: #6b46c1; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .stat-value { font-size: 2.5rem; font-weight: 700; color: #8b5cf6; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        .stat-label { color: #a78bfa; font-size: 0.9rem; }
        .carousel-container { position: relative; margin-bottom: 30px; }
        .carousel-nav-container { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }
        .carousel-nav { background: white; border: 1px solid #d1d5db; color: #6b46c1; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s ease; }
        .carousel-nav:hover { background: #8b5cf6; color: white; border-color: #8b5cf6; transform: scale(1.1); }
        #carousel-page-indicator { font-weight: 600; color: #6b46c1; font-size: 1rem; min-width: 80px; text-align: center; }
        .carousel-slides-wrapper { overflow: hidden; border-radius: 20px; }
        .carousel-slides { display: flex; transition: transform 0.7s ease-in-out; }
        .carousel-slide { flex: 0 0 100%; width: 100%; }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .panel { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 8px 32px rgba(147, 51, 234, 0.1); border: 1px solid rgba(147, 51, 234, 0.1); position: relative; overflow: hidden; display: flex; flex-direction: column; }
        #chart-container-panel, #mission-panel, #schedule-panel { min-height: 500px; }
        .panel::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .panel h2 { color: #6b46c1; font-size: 1.5rem; margin-bottom: 20px; font-weight: 600; padding-bottom: 10px; border-bottom: 2px solid #f3f4f6; display: flex; align-items: center; gap: 10px; }
        .mission-vision-container { display: flex; flex-direction: column; gap: 25px; flex-grow: 1; justify-content: space-around; }
        .mission-item { display: flex; align-items: flex-start; gap: 20px; }
        .mission-item .icon { font-size: 1.8rem; color: #8b5cf6; min-width: 40px; text-align: center; margin-top: 5px; }
        .mission-item h3 { font-size: 1.2rem; color: #6b46c1; margin-bottom: 5px; }
        .mission-item p { color: #4b5563; line-height: 1.6; }
        .schedule-list { list-style: none; padding: 0; }
        .schedule-item { display: flex; align-items: center; padding: 15px 10px; border-bottom: 1px solid #f3f4f6; transition: background-color 0.3s; }
        .schedule-item:last-child { border-bottom: none; }
        .schedule-item:hover { background-color: #f8f9ff; border-radius: 8px; }
        .schedule-date { background-color: #e8ecff; color: #6b46c1; font-weight: 600; padding: 8px 12px; border-radius: 8px; margin-right: 20px; text-align: center; min-width: 80px; }
        .schedule-title { color: #374151; font-weight: 500; }
        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f3f4f6; transition: all 0.3s ease; }
        .ranking-item:hover { background: #f8f9ff; border-radius: 10px; padding: 15px 10px; }
        .ranking-item:last-child { border-bottom: none; }
        .consultant-info { display: flex; align-items: center; gap: 15px; }
        .rank-number { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; flex-shrink: 0; }
        .consultant-name { color: #374151; font-weight: 500; }
        .sales-count { background: #e8ecff; color: #6b46c1; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; min-width: 40px; text-align: center; }
        .process-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .process-card { background: linear-gradient(135deg, #f8f9ff, #e8ecff); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid rgba(147, 51, 234, 0.1); transition: transform 0.3s ease; }
        .process-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(139, 92, 246, 0.1); }
        .process-card h4 { color: #6b46c1; font-size: 0.9rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .process-number { font-size: 2rem; font-weight: 700; color: #8b5cf6; }
        .process-meta { font-size: 0.8rem; color: #6b7280; margin-top: 5px; }
        .recent-sales { margin-top: 30px; }
        .sales-table { width: 100%; border-collapse: collapse; margin-top: 15px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .sales-table th { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; padding: 15px; text-align: left; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .sales-table th:first-child { border-radius: 10px 0 0 0; }
        .sales-table th:last-child { border-radius: 0 10px 0 0; }
        .sales-table td { padding: 15px; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .sales-table tr:nth-child(even) { background-color: #f9fafb; }
        .sales-table tr:hover { background: #f8f9ff; }
        .process-badge { background: #e8ecff; color: #6b46c1; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; display: inline-block; }
        .date-badge { background: #f3f4f6; color: #6b7280; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; display: inline-block; }
        .update-indicator { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 25px; border-radius: 25px; font-size: 0.9rem; font-weight: 500; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); animation: pulse 2s infinite; z-index: 100; display: flex; align-items: center; gap: 10px; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .footer { text-align: center; color: #6b7280; font-size: 0.9rem; margin-top: 20px; padding: 20px; }
        .month-selector { background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); display: flex; align-items: center; gap: 15px; }
        .month-selector label { font-weight: 600; color: #6b46c1; }
        .month-selector select { padding: 8px 15px; border: 1px solid #d1d5db; border-radius: 8px; background: white; color: #374151; font-size: 0.9rem; }
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } #chart-container-panel, #mission-panel, #schedule-panel { min-height: 450px; } }
        @media (max-width: 768px) { .header h1 { font-size: 2rem; } .stats-grid { grid-template-columns: 1fr; } .update-indicator { top: 10px; right: 10px; left: 10px; text-align: center; justify-content: center; } .month-selector { flex-direction: column; align-items: flex-start; } #chart-container-panel, #mission-panel, #schedule-panel { min-height: 400px; } }
    </style>
</head>
<body>
    <div class="update-indicator" id="updateIndicator"><i class="fas fa-sync-alt fa-spin"></i> Carregando dados...</div>
    
    <div class="dashboard">
        <header class="header">
            <h1><i class="fas fa-chart-line"></i> Dashboard de Vendas - ReVive</h1>
            <p class="subtitle">Rumo aos cem mil processos até 2030!</p>
            <div class="connection-status" id="connectionStatus"><i class="fas fa-sync fa-spin"></i><span id="statusText">Verificando conexão...</span></div>
        </header>

        <div class="month-selector">
            <label for="monthFilter"><i class="fas fa-calendar"></i> Visão Geral do Mês:</label>
            <select id="monthFilter" onchange="updateDashboard()"></select>
        </div>

        <div class="stats-grid">
            <div class="stat-card"><h3><i class="fas fa-sun"></i> Total de Processos no Mês</h3><div class="stat-value" id="totalMonth">-</div><div class="stat-label" id="monthLabel">-</div></div>
            <div class="stat-card"><h3><i class="fas fa-trophy"></i> Melhor Consultor (Processos)</h3><div class="stat-value">🏆 <span id="topConsultant">-</span></div><div class="stat-label">em processos este mês</div></div>
            <div class="stat-card"><h3><i class="fas fa-chart-bar"></i> Média Diária (Processos)</h3><div class="stat-value" id="dailyAverage">-</div><div class="stat-label">processos/dia</div></div>
        </div>

        <!-- INÍCIO DO CARROSSEL AUTOMÁTICO -->
        <div class="carousel-container">
            <div class="carousel-nav-container">
                <button class="carousel-nav" id="prev-slide" aria-label="Slide anterior"><i class="fas fa-chevron-left"></i></button>
                <span id="carousel-page-indicator">1 / 4</span>
                <button class="carousel-nav" id="next-slide" aria-label="Próximo slide"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="carousel-slides-wrapper">
                <div class="carousel-slides">
                    <!-- SLIDE 1: Visão Geral do Mês -->
                    <div class="carousel-slide" id="slide-1">
                        <div class="main-content">
                            <div class="panel"><h2><i class="fas fa-trophy"></i> Ranking de Consultores</h2><div id="consultantRanking"></div></div>
                            <div class="panel">
                                <h2><i class="fas fa-chart-pie"></i> Tipos de Processo</h2>
                                <div class="process-stats">
                                    <div class="process-card"><h4>Previdenciários</h4><div class="process-number" id="previdenciariosCount">-</div><div class="process-meta">Meta: <span id="previdenciariosGoal">-</span> (<span id="previdenciariosPercent">-</span>%)</div></div>
                                    <div class="process-card"><h4>Seguro Terceiro</h4><div class="process-number" id="seguroTerceiroCount">-</div><div class="process-meta">Meta: <span id="seguroTerceiroGoal">-</span> (<span id="seguroTerceiroPercent">-</span>%)</div></div>
                                    <div class="process-card"><h4>Seguro de Vida</h4><div class="process-number" id="seguroVidaCount">-</div><div class="process-meta">Meta: <span id="seguroVidaGoal">-</span> (<span id="seguroVidaPercent">-</span>%)</div></div>
                                    <div class="process-card"><h4>Outros</h4><div class="process-number" id="outrosCount">-</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SLIDE 2: Gráfico de Processos por Dia -->
                    <div class="carousel-slide" id="slide-2">
                        <div class="panel" id="chart-container-panel"><h2><i class="fas fa-chart-line"></i> Processos por Período (desde Maio)</h2><canvas id="dailyProcessChart"></canvas></div>
                    </div>
                    
                    <!-- SLIDE 3: Cronograma de Eventos -->
                    <div class="carousel-slide" id="slide-3">
                        <div class="panel" id="schedule-panel">
                            <h2><i class="fas fa-calendar-alt"></i> Cronograma de Eventos</h2>
                            <ul class="schedule-list">
                                <li class="schedule-item"><div class="schedule-date">AGO 15</div><div class="schedule-title">Treinamento de Novas Estratégias Previdenciárias</div></li>
                                <li class="schedule-item"><div class="schedule-date">SET 01</div><div class="schedule-title">Abertura da Competição Mensal de Vendas</div></li>
                                <li class="schedule-item"><div class="schedule-date">SET 22</div><div class="schedule-title">Workshop sobre DPVAT e Seguro de Vida</div></li>
                                <li class="schedule-item"><div class="schedule-date">OUT 10</div><div class="schedule-title">Reunião Geral de Alinhamento do Q4</div></li>
                                <li class="schedule-item"><div class="schedule-date">DEZ 20</div><div class="schedule-title">Confraternização de Fim de Ano e Premiação Anual</div></li>
                            </ul>
                        </div>
                    </div>

                    <!-- SLIDE 4: Missão, Visão e Valores -->
                    <div class="carousel-slide" id="slide-4">
                        <div class="panel" id="mission-panel">
                            <h2><i class="fas fa-flag-checkered"></i> Nossa Cultura</h2>
                            <div class="mission-vision-container">
                                <div class="mission-item"><div class="icon"><i class="fas fa-rocket"></i></div><div><h3>Missão</h3><p>Lutar incansavelmente pelos direitos de nossos clientes, transformando desafios em vitórias e garantindo que cada pessoa receba a justiça e a compensação que merece.</p></div></div>
                                <div class="mission-item"><div class="icon"><i class="fas fa-eye"></i></div><div><h3>Visão</h3><p>Ser a maior e mais respeitada assessoria do Brasil, reconhecida pela excelência, inovação e por alcançar a marca histórica de 100.000 processos concluídos com sucesso até 2030.</p></div></div>
                                <div class="mission-item"><div class="icon"><i class="fas fa-handshake-angle"></i></div><div><h3>Valores</h3><p><strong>Compromisso, Ética, Empatia, Resiliência e Inovação.</strong></p></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- FIM DO CARROSSEL -->
        
        <div class="panel recent-sales">
            <h2><i class="fas fa-clock"></i> Linhas da Planilha do Mês</h2>
            <table class="sales-table"><thead><tr><th>Data</th><th>Cliente</th><th>Processo (Original da Planilha)</th><th>Consultor</th></tr></thead><tbody id="recentSalesTable"></tbody></table>
        </div>
        
        <footer class="footer">Dashboard de Vendas em Tempo Real • Atualizado em: <span id="lastUpdateTime">-</span></footer>
    </div>

    <script>
        // --- VARIÁVEIS GLOBAIS ---
        let salesData=[],lastUpdate=null,autoUpdateInterval=null,connectionAttempts=0,dailyChartInstance=null;
        const isAutoUpdateActive=!0,maxRetries=3,FIXED_SHEET_ID="1fSTEyMmAEgfMnAFUTdYbJah5dr8OudsEsqjKHnHwFms",FIXED_SHEET_GID="1536647709",DRA_RENATA_STRING="DRA RENATA";
        let currentMonthCounts={previdenciarios:0,seguroTerceiro:0,seguroVida:0,outros:0};
        const PREVIDENCIARIO_TYPES=["CONCESSÃO MATERNIDADE","AUXILIO-ACIDENTE","APOSENTADORIA POR TEMPO DE SERVIÇO","LOAS","AUXILIO-DOENÇA","APOSENTADORIA POR IDADE","APOSENTADORIA POR INVALIDEZ","PENSÃO POR MORTE"].map(e=>e.toUpperCase().trim());
        const SEGURO_TERCEIRO_TYPES=["TERCEIRO DANO CORPORAL","TERCEIRO DANO MATERIAL"].map(e=>e.toUpperCase().trim()),SEGURO_VIDA_TYPES=["VIDA","VIDA APLICATIVO"].map(e=>e.toUpperCase().trim());

        // --- LÓGICA DO CARROSSEL AUTOMÁTICO ---
        let currentSlide=0,carouselInterval=null;
        const slides=document.querySelector(".carousel-slides"),totalSlides=document.querySelectorAll(".carousel-slide").length,pageIndicator=document.getElementById("carousel-page-indicator"),slideDuration=1e4;
        function showSlide(e){currentSlide=(e+totalSlides)%totalSlides;const t=-currentSlide*100;slides.style.transform=`translateX(${t}%)`,pageIndicator.textContent=`${currentSlide+1} / ${totalSlides}`}
        function startCarouselTimer(){clearInterval(carouselInterval),carouselInterval=setInterval(()=>{showSlide(currentSlide+1)},slideDuration)}
        document.getElementById("next-slide").addEventListener("click",()=>{showSlide(currentSlide+1),startCarouselTimer()}),document.getElementById("prev-slide").addEventListener("click",()=>{showSlide(currentSlide-1),startCarouselTimer()});

        // --- FUNÇÕES DE CONEXÃO E PROCESSAMENTO DE DADOS (Minimizadas) ---
        function updateConnectionStatus(e,t){const s=document.getElementById("connectionStatus");s&&(s.className="connection-status",s.classList.add(`status-${e}`),s.innerHTML=`<i class="${{connected:"fas fa-check-circle",error:"fas fa-exclamation-circle",loading:"fas fa-sync fa-spin"}[e]}"></i> <span id="statusText">${t}</span>`)}async function fetchViaCsvDirect(){const e=`https://docs.google.com/spreadsheets/d/1fSTEyMmAEgfMnAFUTdYbJah5dr8OudsEsqjKHnHwFms/export?format=csv&gid=1536647709`,t=await fetch(e,{method:"GET",mode:"cors"});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return await t.text()}async function fetchViaProxy(){const e="https://docs.google.com/spreadsheets/d/1fSTEyMmAEgfMnAFUTdYbJah5dr8OudsEsqjKHnHwFms/export?format=csv&gid=1536647709",t=`https://api.allorigins.win/get?url=${encodeURIComponent(e)}`,s=await fetch(t),o=await s.json();if(!o.contents)throw new Error("Dados vazios retornados pelo proxy allorigins.win");return o.contents}async function fetchSheetData(){updateConnectionStatus("loading","Conectando...");for(let e of[{name:"CSV Direto",func:fetchViaCsvDirect},{name:"CORS Proxy (allorigins.win)",func:fetchViaProxy}])try{const t=await e.func();if(t&&t.trim()){return await processCsvData(t),populateMonthFilter(salesData),updateDashboard(),updateConnectionStatus("connected",`Conectado via ${e.name}`),connectionAttempts=0,!0}}catch(t){console.error(`Erro no método ${e.name}:`,t)}connectionAttempts++,connectionAttempts>=3?(updateConnectionStatus("error","Falha - Usando dados de exemplo"),loadSampleData()):(updateConnectionStatus("error",`Tentativa ${connectionAttempts}/3 falhou`),setTimeout(fetchSheetData,1e4));return!1}async function processCsvData(e){const t=e.split("\n").filter(e=>e.trim());if(t.length<=1)return void(salesData=[]);const s=[];for(let e=1;e<t.length;e++){const o=parseCSVLine(t[e]);o.length>=5&&s.push({processo:(o[0]||"").trim(),cliente:(o[1]||"").trim(),link:(o[2]||"").trim(),data:(o[3]||"").trim(),consultor:(o[4]||"").trim(),originalIndex:e})}salesData=s,lastUpdate=new Date,updateLastUpdateTime()}
        function parseCSVLine(e){const t=[];let s="",o=!1;for(let n=0;n<e.length;n++){let r=e[n];'"'===r?n+1<e.length&&'"'===e[n+1]?o&&(s+='"'):o=!o:'"'===r?o=!o:","===r&&!o?(t.push(s),s=""):s+=r}return t.push(s),t.map(e=>e.trim())}

        // --- LÓGICA DO DASHBOARD ---
        function populateMonthFilter(e){const t=new Set;(e||[]).forEach(e=>{if(e.data){const s=e.data.split("/");3===s.length&&!isNaN(parseInt(s[0],10))&&!isNaN(parseInt(s[1],10))&&!isNaN(parseInt(s[2],10))&&parseInt(s[1],10)>=1&&parseInt(s[1],10)<=12&&parseInt(s[2],10)>1900&&parseInt(s[2],10)<2100&&t.add(`${String(parseInt(s[1],10)).padStart(2,"0")}/${s[2]}`)}});const s=Array.from(t).sort((e,t)=>{const[s,o]=e.split("/"),[n,r]=t.split("/");return new Date(r,n-1)-new Date(o,s-1)}),o=document.getElementById("monthFilter"),n=o.value;o.innerHTML="",s.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)}),s.includes(n)?o.value=n:s.length>0&&(o.value=s[0])}
        function loadSampleData(){salesData=[{processo:"VIDA,  AUXILIO-DOENÇA,  LOAS",cliente:"Mario kopelkke",data:"02/06/2025",consultor:"Augusto Teply"},{processo:"AUXILIO-ACIDENTE",cliente:"Diego armando mantelli",data:"02/06/2025",consultor:"Thiago Pereira Gomes"},{processo:"VIDA",cliente:"Cliente Maio SV",data:"15/05/2025",consultor:"Consultor Maio"},{processo:"AUXILIO-DOENÇA",cliente:"Cliente Maio Prev",data:"10/05/2025",consultor:"Consultor Maio 2"},{processo:"TERCEIRO DANO MATERIAL",cliente:"Cliente Maio ST",data:"12/05/2025",consultor:"Consultor Maio ST"},{processo:"Dra Renata",cliente:"Cliente Dra Renata Teste",data:"01/06/2025",consultor:"Consultor Teste"}],populateMonthFilter(salesData);const e=document.getElementById("monthFilter");Array.from(e.options).some(e=>"06/2025"===e.value)?e.value="06/2025":e.options.length>0&&(e.value=e.options[0].value),updateDashboard(),lastUpdate=new Date,updateLastUpdateTime()}
        function getMonthSales(){const e=document.getElementById("monthFilter").value;if(!e)return[];const[t,s]=e.split("/");return salesData.filter(e=>{if(!e.data)return!1;const[o,n,r]=e.data.split("/");return n===t&&r===s})}
        function countValidProcessesInRow(e){return(e.processo||"").toUpperCase().split(",").map(e=>e.trim()).filter(e=>e&&"DRA RENATA"!==e).length}
        function updateDashboard(){if(0===salesData.length&&0===document.getElementById("monthFilter").options.length)return document.getElementById("consultantRanking").innerHTML='<div style="text-align: center; color: #6b7280; padding: 40px;"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top: 15px;">Carregando dados...</p></div>',void(document.getElementById("recentSalesTable").innerHTML='<tr><td colspan="4" style="text-align: center; color: #6b7280; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>');const e=getMonthSales();updateProcessStats(e),updateConsultantRanking(e),updateMainStats(e),updateMonthSales(e),updateDailyProcessChart();const t=document.getElementById("updateIndicator");t&&(t.innerHTML='<i class="fas fa-check-circle"></i> Dados atualizados!',setTimeout(()=>{t.style.opacity="0",setTimeout(()=>{t.style.display="none"},500)},2e3))}
        function updateMainStats(e){const t=document.getElementById("monthFilter").value;if(!t)return document.getElementById("totalMonth").textContent="-",document.getElementById("monthLabel").textContent="Nenhum mês",void(document.getElementById("dailyAverage").textContent="-");const[s,o]=t.split("/"),n=parseInt(s),r=parseInt(o),a=currentMonthCounts.previdenciarios+currentMonthCounts.seguroTerceiro+currentMonthCounts.seguroVida+currentMonthCounts.outros;document.getElementById("totalMonth").textContent=a;const i=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];document.getElementById("monthLabel").textContent=`${i[n-1]} ${r}`;let l=0;e.length>0&&e.forEach(e=>{if(e.data){const t=e.data.split("/");if(3===t.length){const e=parseInt(t[0],10),s=parseInt(t[1],10),o=parseInt(t[2],10);s===n&&o===r&&e>l&&(l=e)}}});const c=l>0?l:1;let d=0;a>0&&l>0&&(d=a/c),document.getElementById("dailyAverage").textContent=d.toFixed(1)}
        function getNormalizedConsultantKey(e){return e&&"string"==typeof e?e.trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().split(" ")[0]:"desconhecido"}
        function updateConsultantRanking(e){const t={};e.forEach(e=>{const s=e.consultor;if(s&&s.trim()){const o=getNormalizedConsultantKey(s);if(!t[o]){const e=s.trim().split(" ")[0];t[o]={name:e.charAt(0).toUpperCase()+e.slice(1).toLowerCase(),sales:0}}t[o].sales+=countValidProcessesInRow(e)}});const s=Object.values(t).sort((e,t)=>t.sales-e.sales);let o="-";s.length>0&&s[0].sales>0&&(o=s[0].name),document.getElementById("topConsultant").textContent=o;let n="";s.length>0&&s.some(e=>e.sales>0)?s.slice(0,10).forEach((e,t)=>{e.sales>0&&(n+=`<div class="ranking-item"><div class="consultant-info"><div class="rank-number">${t+1}</div><div class="consultant-name">${e.name}</div></div><div class="sales-count">${e.sales}</div></div>`)}):n='<div style="text-align: center; color: #6b7280; padding: 20px;">Nenhum processo para o mês.</div>',document.getElementById("consultantRanking").innerHTML=n}
        function updateProcessStats(e){const t={PREVIDENCIÁRIOS:400,"SEGURO TERCEIRO":30,"SEGURO DE VIDA":90};let s=0,o=0,n=0;const r=new Set;e.forEach(e=>{const t=e.cliente,a=(e.processo||"").toUpperCase().split(",").map(e=>e.trim()).filter(e=>e);a.forEach(e=>{if("DRA RENATA"!==e){let a=!1;PREVIDENCIARIO_TYPES.includes(e)&&(s++,a=!0),SEGURO_VIDA_TYPES.includes(e)&&(o++,a=!0),SEGURO_TERCEIRO_TYPES.includes(e)&&(t&&r.add(t),a=!0),a||!e||n++}})});const a=r.size;currentMonthCounts={previdenciarios:s,seguroTerceiro:a,seguroVida:o,outros:n};const i=t.PREVIDENCIÁRIOS,l=i>0?Math.min(100,Math.round(s/i*100)):0;document.getElementById("previdenciariosCount").textContent=s,document.getElementById("previdenciariosGoal").textContent=`${s}/${i}`,document.getElementById("previdenciariosPercent").textContent=l;const c=t["SEGURO TERCEIRO"],d=c>0?Math.min(100,Math.round(a/c*100)):0;document.getElementById("seguroTerceiroCount").textContent=a,document.getElementById("seguroTerceiroGoal").textContent=`${a}/${c}`,document.getElementById("seguroTerceiroPercent").textContent=d;const u=t["SEGURO DE VIDA"],m=u>0?Math.min(100,Math.round(o/u*100)):0;document.getElementById("seguroVidaCount").textContent=o,document.getElementById("seguroVidaGoal").textContent=`${o}/${u}`,document.getElementById("seguroVidaPercent").textContent=m,document.getElementById("outrosCount").textContent=n}
        function updateMonthSales(e){const t=[...e].sort((e,t)=>{if(!e.data||!t.data)return 0;const s=e=>{const t=e.split("/");return 3===t.length?new Date(parseInt(t[2]),parseInt(t[1])-1,parseInt(t[0])):null},o=s(e.data),n=s(t.data);return!o||!n||isNaN(o.getTime())||isNaN(n.getTime())?0:n.getTime()!==o.getTime()?n.getTime()-o.getTime():(t.originalIndex||0)-(e.originalIndex||0)});let s="";t.length>0?t.forEach(e=>{s+=`<tr><td><span class="date-badge">${e.data||"-"}</span></td><td>${e.cliente||"-"}</td><td><span class="process-badge">${e.processo||"-"}</span></td><td>${e.consultor||"-"}</td></tr>`}):s='<tr><td colspan="4" style="text-align: center; color: #6b7280; padding: 40px;">Nenhuma venda para o mês.</td></tr>',document.getElementById("recentSalesTable").innerHTML=s}
        function updateLastUpdateTime(){lastUpdate&&document.getElementById("lastUpdateTime").textContent=lastUpdate.toLocaleTimeString("pt-BR")}
        
        // --- FUNÇÃO DO GRÁFICO CORRIGIDA E OTIMIZADA ---
        function updateDailyProcessChart(){const today=new Date,currentYear=today.getFullYear(),startDate=new Date(currentYear,4,1),filteredData=salesData.filter(e=>{if(!e.data)return!1;const t=e.data.split("/");if(3!==t.length)return!1;const s=new Date(parseInt(t[2]),parseInt(t[1])-1,parseInt(t[0]));return!isNaN(s.getTime())&&s>=startDate&&s<=today});const dailyCounts=new Map;filteredData.forEach(e=>{const t=e.data,s=countValidProcessesInRow(e);s>0&&dailyCounts.set(t,(dailyCounts.get(t)||0)+s)});const labels=[],dataPoints=[],aggregationPeriod=5;let currentDate=new Date(startDate);for(;currentDate<=today;){let e=0;const t=new Date(currentDate),s=new Date(currentDate);s.setDate(s.getDate()+aggregationPeriod-1);const o=s>today?today:s;for(let n=new Date(t);n<=o;n.setDate(n.getDate()+1)){const t=n.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric"});dailyCounts.has(t)&&(e+=dailyCounts.get(t))}const n=o.getDate()===t.getDate()?t.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"}):`${t.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"})} - ${o.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"})}`;labels.push(n),dataPoints.push(e),currentDate.setDate(currentDate.getDate()+aggregationPeriod)}const ctx=document.getElementById("dailyProcessChart").getContext("2d");dailyChartInstance&&dailyChartInstance.destroy(),dailyChartInstance=new Chart(ctx,{type:"line",data:{labels:labels,datasets:[{label:"Processos no Período",data:dataPoints,backgroundColor:"rgba(139, 92, 246, 0.2)",borderColor:"#8b5cf6",borderWidth:3,pointBackgroundColor:"#8b5cf6",pointRadius:4,pointHoverRadius:6,tension:.3,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{color:"#6b7280",stepSize:1},grid:{color:"#f3f4f6"}},x:{ticks:{color:"#6b7280"},grid:{display:!1}}},plugins:{legend:{display:!1},tooltip:{backgroundColor:"#6b46c1",titleFont:{size:14,weight:"bold"},bodyFont:{size:12},padding:12,cornerRadius:8,callbacks:{label:function(e){return` Processos: ${e.raw}`}}}}}})}

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', function() {
            const updateIndicator = document.getElementById('updateIndicator');
            if (updateIndicator) updateIndicator.style.display = 'flex';
            
            fetchSheetData(); 
            // loadSampleData();
            
            showSlide(currentSlide);
            startCarouselTimer();

            autoUpdateInterval = setInterval(() => {
                if (isAutoUpdateActive) { 
                    if (updateIndicator) {
                        updateIndicator.style.display = 'flex';
                        updateIndicator.style.opacity = '1';
                        updateIndicator.innerHTML = `<i class="fas fa-sync-alt fa-spin"></i> Atualizando automaticamente...`;
                    }
                    fetchSheetData();
                }
            }, 30000); 
        });
    </script>
</body>
</html>
