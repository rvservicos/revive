<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas - Tempo Real</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.1);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, #8b5cf6, #6b46c1, #a78bfa);
        }

        .header h1 {
            color: #6b46c1;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header h1 i {
            background: linear-gradient(135deg, #8b5cf6, #6b46c1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header .subtitle {
            color: #8b5cf6;
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .connection-status { 
            margin: 15px auto; 
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-flex; 
            align-items: center;
            gap: 10px;
            max-width: 300px; 
        }

        .status-connected { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .status-error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .status-loading { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(147, 51, 234, 0.1);
            border: 1px solid rgba(147, 51, 234, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(147, 51, 234, 0.15); }

        .stat-card h3 { color: #6b46c1; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .stat-value { font-size: 2.5rem; font-weight: 700; color: #8b5cf6; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        .stat-label { color: #a78bfa; font-size: 0.9rem; }

        /* --- ESTILOS DO CARROSSEL --- */
        .carousel-container { position: relative; margin-bottom: 30px; }
        .carousel-nav-container { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px; }
        .carousel-nav { background: white; border: 1px solid #d1d5db; color: #6b46c1; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s ease; }
        .carousel-nav:hover { background: #8b5cf6; color: white; border-color: #8b5cf6; transform: scale(1.1); }
        #carousel-page-indicator { font-weight: 600; color: #6b46c1; font-size: 1rem; min-width: 80px; text-align: center; }
        .carousel-slides-wrapper { overflow: hidden; border-radius: 20px; }
        .carousel-slides { display: flex; transition: transform 0.7s ease-in-out; }
        .carousel-slide { flex: 0 0 100%; width: 100%; }

        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }

        .panel { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 8px 32px rgba(147, 51, 234, 0.1); border: 1px solid rgba(147, 51, 234, 0.1); position: relative; overflow: hidden; display: flex; flex-direction: column; }
        #chart-container-panel, #mission-panel, #schedule-panel { min-height: 500px; }
        .panel::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .panel h2 { color: #6b46c1; font-size: 1.5rem; margin-bottom: 20px; font-weight: 600; padding-bottom: 10px; border-bottom: 2px solid #f3f4f6; display: flex; align-items: center; gap: 10px; }

        /* Estilos para Missão, Visão e Valores */
        .mission-vision-container { display: flex; flex-direction: column; gap: 25px; flex-grow: 1; justify-content: space-around; }
        .mission-item { display: flex; align-items: flex-start; gap: 20px; }
        .mission-item .icon { font-size: 1.8rem; color: #8b5cf6; min-width: 40px; text-align: center; margin-top: 5px; }
        .mission-item h3 { font-size: 1.2rem; color: #6b46c1; margin-bottom: 5px; }
        .mission-item p { color: #4b5563; line-height: 1.6; }

        /* Estilos para Cronograma */
        .schedule-list { list-style: none; padding: 0; }
        .schedule-item { display: flex; align-items: center; padding: 15px 10px; border-bottom: 1px solid #f3f4f6; transition: background-color 0.3s; }
        .schedule-item:last-child { border-bottom: none; }
        .schedule-item:hover { background-color: #f8f9ff; border-radius: 8px; }
        .schedule-date { background-color: #e8ecff; color: #6b46c1; font-weight: 600; padding: 8px 12px; border-radius: 8px; margin-right: 20px; text-align: center; min-width: 80px; }
        .schedule-title { color: #374151; font-weight: 500; }

        .ranking-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f3f4f6; transition: all 0.3s ease; }
        .ranking-item:hover { background: #f8f9ff; border-radius: 10px; padding: 15px 10px; }
        .ranking-item:last-child { border-bottom: none; }
        .consultant-info { display: flex; align-items: center; gap: 15px; }
        .rank-number { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; flex-shrink: 0; }
        .consultant-name { color: #374151; font-weight: 500; }
        .sales-count { background: #e8ecff; color: #6b46c1; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; min-width: 40px; text-align: center; }

        .process-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .process-card { background: linear-gradient(135deg, #f8f9ff, #e8ecff); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid rgba(147, 51, 234, 0.1); transition: transform 0.3s ease; }
        .process-card:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(139, 92, 246, 0.1); }
        .process-card h4 { color: #6b46c1; font-size: 0.9rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .process-number { font-size: 2rem; font-weight: 700; color: #8b5cf6; }
        .process-meta { font-size: 0.8rem; color: #6b7280; margin-top: 5px; }

        .recent-sales { grid-column: 1 / -1; margin-top: 30px; }
        .sales-table { width: 100%; border-collapse: collapse; margin-top: 15px; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .sales-table th { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; padding: 15px; text-align: left; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .sales-table th:first-child { border-radius: 10px 0 0 0; }
        .sales-table th:last-child { border-radius: 0 10px 0 0; }
        .sales-table td { padding: 15px; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .sales-table tr:nth-child(even) { background-color: #f9fafb; }
        .sales-table tr:hover { background: #f8f9ff; }
        .process-badge { background: #e8ecff; color: #6b46c1; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; display: inline-block; }
        .date-badge { background: #f3f4f6; color: #6b7280; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; display: inline-block; }

        .update-indicator { position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 25px; border-radius: 25px; font-size: 0.9rem; font-weight: 500; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); animation: pulse 2s infinite; z-index: 100; display: flex; align-items: center; gap: 10px; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
      
        .footer { text-align: center; color: #6b7280; font-size: 0.9rem; margin-top: 20px; padding: 20px; }

        .month-selector { background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); display: flex; align-items: center; gap: 15px; }
        .month-selector label { font-weight: 600; color: #6b46c1; }
        .month-selector select { padding: 8px 15px; border: 1px solid #d1d5db; border-radius: 8px; background: white; color: #374151; font-size: 0.9rem; }

        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; }
            #chart-container-panel, #mission-panel, #schedule-panel { min-height: 450px; }
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .stats-grid { grid-template-columns: 1fr; }
            .update-indicator { top: 10px; right: 10px; left: 10px; text-align: center; justify-content: center; }
            .month-selector { flex-direction: column; align-items: flex-start; }
            #chart-container-panel, #mission-panel, #schedule-panel { min-height: 400px; }
        }
    </style>
</head>
<body>
    <div class="update-indicator" id="updateIndicator">
        <i class="fas fa-sync-alt fa-spin"></i> Carregando dados...
    </div>
    
    <div class="dashboard">
        <header class="header">
            <h1><i class="fas fa-chart-line"></i> Dashboard de Vendas - ReVive</h1>
            <p class="subtitle">Rumo aos cem mil processos até 2030!</p>
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-sync fa-spin"></i>
                <span id="statusText">Verificando conexão...</span>
            </div>
        </header>

        <div class="month-selector">
            <label for="monthFilter"><i class="fas fa-calendar"></i> Visão Geral do Mês:</label>
            <select id="monthFilter" onchange="updateDashboard()"></select>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3><i class="fas fa-sun"></i> Total de Processos no Mês</h3>
                <div class="stat-value" id="totalMonth">-</div>
                <div class="stat-label" id="monthLabel">-</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-trophy"></i> Melhor Consultor (Processos)</h3>
                <div class="stat-value">🏆 <span id="topConsultant">-</span></div>
                <div class="stat-label">em processos este mês</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-chart-bar"></i> Média Diária (Processos)</h3>
                <div class="stat-value" id="dailyAverage">-</div>
                <div class="stat-label">processos/dia</div>
            </div>
        </div>

        <!-- INÍCIO DO CARROSSEL AUTOMÁTICO -->
        <div class="carousel-container">
            <div class="carousel-nav-container">
                <button class="carousel-nav" id="prev-slide" aria-label="Slide anterior"><i class="fas fa-chevron-left"></i></button>
                <span id="carousel-page-indicator">1 / 4</span>
                <button class="carousel-nav" id="next-slide" aria-label="Próximo slide"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="carousel-slides-wrapper">
                <div class="carousel-slides">
                    <!-- SLIDE 1: Visão Geral do Mês -->
                    <div class="carousel-slide" id="slide-1">
                        <div class="main-content">
                            <div class="panel">
                                <h2><i class="fas fa-trophy"></i> Ranking de Consultores</h2>
                                <div id="consultantRanking"></div>
                            </div>
                            <div class="panel">
                                <h2><i class="fas fa-chart-pie"></i> Tipos de Processo</h2>
                                <div class="process-stats">
                                    <div class="process-card"><h4>Previdenciários</h4><div class="process-number" id="previdenciariosCount">-</div><div class="process-meta">Meta: <span id="previdenciariosGoal">-</span> (<span id="previdenciariosPercent">-</span>%)</div></div>
                                    <div class="process-card"><h4>Seguro Terceiro</h4><div class="process-number" id="seguroTerceiroCount">-</div><div class="process-meta">Meta: <span id="seguroTerceiroGoal">-</span> (<span id="seguroTerceiroPercent">-</span>%)</div></div>
                                    <div class="process-card"><h4>Seguro de Vida</h4><div class="process-number" id="seguroVidaCount">-</div><div class="process-meta">Meta: <span id="seguroVidaGoal">-</span> (<span id="seguroVidaPercent">-</span>%)</div></div>
                                    <div class="process-card"><h4>Outros</h4><div class="process-number" id="outrosCount">-</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SLIDE 2: Gráfico de Processos por Dia -->
                    <div class="carousel-slide" id="slide-2">
                        <div class="panel" id="chart-container-panel">
                             <h2><i class="fas fa-calendar-day"></i> Gráfico de Processos por Dia (desde Maio)</h2>
                             <canvas id="dailyProcessChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- SLIDE 3: Missão, Visão e Valores -->
                    <div class="carousel-slide" id="slide-3">
                        <div class="panel" id="mission-panel">
                            <h2><i class="fas fa-flag-checkered"></i> Nossa Cultura</h2>
                            <div class="mission-vision-container">
                                <div class="mission-item">
                                    <div class="icon"><i class="fas fa-rocket"></i></div>
                                    <div>
                                        <h3>Missão</h3>
                                        <p>Lutar incansavelmente pelos direitos de nossos clientes, transformando desafios em vitórias e garantindo que cada pessoa receba a justiça e a compensação que merece, com agilidade e transparência.</p>
                                    </div>
                                </div>
                                <div class="mission-item">
                                    <div class="icon"><i class="fas fa-eye"></i></div>
                                    <div>
                                        <h3>Visão</h3>
                                        <p>Ser a maior e mais respeitada assessoria do Brasil, reconhecida pela excelência, inovação e por alcançar a marca histórica de 100.000 processos concluídos com sucesso até 2030.</p>
                                    </div>
                                </div>
                                <div class="mission-item">
                                    <div class="icon"><i class="fas fa-handshake-angle"></i></div>
                                    <div>
                                        <h3>Valores</h3>
                                        <p><strong>Compromisso:</strong> Dedicação total a cada caso. <strong>Ética:</strong> Integridade em todas as ações. <strong>Empatia:</strong> Colocar-se no lugar do cliente. <strong>Resiliência:</strong> Nunca desistir. <strong>Inovação:</strong> Buscar sempre a melhor solução.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SLIDE 4: Cronograma de Eventos -->
                    <div class="carousel-slide" id="slide-4">
                        <div class="panel" id="schedule-panel">
                            <h2><i class="fas fa-calendar-alt"></i> Cronograma de Eventos</h2>
                            <ul class="schedule-list">
                                <li class="schedule-item">
                                    <div class="schedule-date">AGO 15</div>
                                    <div class="schedule-title">Treinamento de Novas Estratégias Previdenciárias</div>
                                </li>
                                <li class="schedule-item">
                                    <div class="schedule-date">SET 01</div>
                                    <div class="schedule-title">Abertura da Competição Mensal de Vendas</div>
                                </li>
                                <li class="schedule-item">
                                    <div class="schedule-date">SET 22</div>
                                    <div class="schedule-title">Workshop sobre DPVAT e Seguro de Vida</div>
                                </li>
                                <li class="schedule-item">
                                    <div class="schedule-date">OUT 10</div>
                                    <div class="schedule-title">Reunião Geral de Alinhamento do Q4</div>
                                </li>
                                <li class="schedule-item">
                                    <div class="schedule-date">DEZ 20</div>
                                    <div class="schedule-title">Confraternização de Fim de Ano e Premiação Anual</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- FIM DO CARROSSEL -->
        
        <!-- Tabela de Vendas (agora fora do carrossel) -->
        <div class="panel recent-sales">
            <h2><i class="fas fa-clock"></i> Linhas da Planilha do Mês</h2>
            <table class="sales-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Processo (Original da Planilha)</th>
                        <th>Consultor</th>
                    </tr>
                </thead>
                <tbody id="recentSalesTable"></tbody>
            </table>
        </div>
        
        <footer class="footer">
            Dashboard de Vendas em Tempo Real • Atualizado em: <span id="lastUpdateTime">-</span>
        </footer>
    </div>

    <script>
        // --- VARIÁVEIS GLOBAIS ---
        let salesData = []; 
        let lastUpdate = null;
        let autoUpdateInterval = null;
        const isAutoUpdateActive = true; 
        let connectionAttempts = 0;
        const maxRetries = 3;
        
        const FIXED_SHEET_ID = "1fSTEyMmAEgfMnAFUTdYbJah5dr8OudsEsqjKHnHwFms";
        const FIXED_SHEET_GID = "1536647709"; 
        const DRA_RENATA_STRING = "DRA RENATA"; 

        let currentMonthCounts = { previdenciarios: 0, seguroTerceiro: 0, seguroVida: 0, outros: 0 };
        const PREVIDENCIARIO_TYPES = ['CONCESSÃO MATERNIDADE', 'AUXILIO-ACIDENTE', 'APOSENTADORIA POR TEMPO DE SERVIÇO', 'LOAS', 'AUXILIO-DOENÇA', 'APOSENTADORIA POR IDADE', 'APOSENTADORIA POR INVALIDEZ', 'PENSÃO POR MORTE'].map(t => t.toUpperCase().trim());
        const SEGURO_TERCEIRO_TYPES = ['TERCEIRO DANO CORPORAL', 'TERCEIRO DANO MATERIAL'].map(t => t.toUpperCase().trim());
        const SEGURO_VIDA_TYPES = ['VIDA', 'VIDA APLICATIVO'].map(t => t.toUpperCase().trim());

        // Variável para o gráfico
        let dailyChartInstance = null;

        // --- LÓGICA DO CARROSSEL AUTOMÁTICO ---
        let currentSlide = 0;
        let carouselInterval = null;
        const slides = document.querySelector('.carousel-slides');
        const totalSlides = document.querySelectorAll('.carousel-slide').length;
        const pageIndicator = document.getElementById('carousel-page-indicator');
        const slideDuration = 8000; // 8 segundos

        function showSlide(index) {
            currentSlide = (index + totalSlides) % totalSlides; // Garante que o índice seja cíclico (0, 1, 2, 3, 0, ...)
            const offset = -currentSlide * 100;
            slides.style.transform = `translateX(${offset}%)`;
            pageIndicator.textContent = `${currentSlide + 1} / ${totalSlides}`;
        }
        
        function startCarouselTimer() {
            clearInterval(carouselInterval); // Limpa o timer anterior
            carouselInterval = setInterval(() => {
                showSlide(currentSlide + 1);
            }, slideDuration);
        }

        document.getElementById('next-slide').addEventListener('click', () => {
            showSlide(currentSlide + 1);
            startCarouselTimer(); // Reseta o timer ao navegar manualmente
        });

        document.getElementById('prev-slide').addEventListener('click', () => {
            showSlide(currentSlide - 1);
            startCarouselTimer(); // Reseta o timer ao navegar manualmente
        });

        // --- FUNÇÕES DE CONEXÃO E PROCESSAMENTO DE DADOS (Inalteradas) ---
        // (As funções fetchSheetData, processCsvData, parseCSVLine, etc., permanecem as mesmas)
        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            if (!statusElement) return;
            statusElement.className = 'connection-status';
            statusElement.classList.add(`status-${status}`);
            const icons = { 'connected': 'fas fa-check-circle', 'error': 'fas fa-exclamation-circle', 'loading': 'fas fa-sync fa-spin' };
            statusElement.innerHTML = `<i class="${icons[status]}"></i> <span id="statusText">${message}</span>`;
        }
        async function fetchViaCsvDirect() { const csvUrl = `https://docs.google.com/spreadsheets/d/${FIXED_SHEET_ID}/export?format=csv${FIXED_SHEET_GID ? `&gid=${FIXED_SHEET_GID}` : ''}`; const response = await fetch(csvUrl, { method: 'GET', mode: 'cors' }); if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`); return await response.text(); }
        async function fetchViaProxy() { const csvUrl = `https://docs.google.com/spreadsheets/d/${FIXED_SHEET_ID}/export?format=csv${FIXED_SHEET_GID ? `&gid=${FIXED_SHEET_GID}` : ''}`; const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(csvUrl)}`; const response = await fetch(proxyUrl); const data = await response.json(); if (!data.contents) throw new Error('Dados vazios retornados pelo proxy allorigins.win'); return data.contents; }
        async function fetchSheetData() { updateConnectionStatus('loading', 'Conectando...'); const methods = [{ name: 'CSV Direto', func: fetchViaCsvDirect }, { name: 'CORS Proxy (allorigins.win)', func: fetchViaProxy },]; for (let method of methods) { try { const csvData = await method.func(); if (csvData && csvData.trim()) { await processCsvData(csvData); populateMonthFilter(salesData); updateDashboard(); updateConnectionStatus('connected', `Conectado via ${method.name}`); connectionAttempts = 0; return true; } } catch (error) { console.error(`Erro no método ${method.name}:`, error); } } connectionAttempts++; if (connectionAttempts >= maxRetries) { updateConnectionStatus('error', 'Falha - Usando dados de exemplo'); loadSampleData(); } else { updateConnectionStatus('error', `Tentativa ${connectionAttempts}/${maxRetries} falhou`); setTimeout(fetchSheetData, 10000); } return false; }
        async function processCsvData(csvText) { const lines = csvText.split('\n').filter(line => line.trim()); if (lines.length <= 1) { salesData = []; return; } const tempData = []; for (let i = 1; i < lines.length; i++) { const columns = parseCSVLine(lines[i]); if (columns.length >= 5) { const record = { processo: (columns[0] || '').trim(), cliente: (columns[1] || '').trim(), link: (columns[2] || '').trim(), data: (columns[3] || '').trim(), consultor: (columns[4] || '').trim(), originalIndex: i }; if (record.processo || record.cliente || record.data || record.consultor) { tempData.push(record); } } } salesData = tempData; lastUpdate = new Date(); updateLastUpdateTime(); }
        function parseCSVLine(line) { const result = []; let current = ''; let inQuotes = false; for (let i = 0; i < line.length; i++) { let char = line[i]; if (char === '"') { if (i + 1 < line.length && line[i+1] === '"') { if (inQuotes) current += '"'; i++; } else { inQuotes = !inQuotes; } } else if (char === ',' && !inQuotes) { result.push(current); current = ''; } else { current += char; } } result.push(current); return result.map(item => item.trim()); }

        // --- LÓGICA DO DASHBOARD ---
        function populateMonthFilter(dataToScan) { const monthSet = new Set(); (dataToScan || []).forEach(sale => { if (sale.data) { const parts = sale.data.split('/'); if (parts.length === 3) { const day = parseInt(parts[0], 10); const month = parseInt(parts[1], 10); const year = parseInt(parts[2], 10); if (!isNaN(day) && !isNaN(month) && !isNaN(year) && month >= 1 && month <= 12 && year > 1900 && year < 2100) { monthSet.add(`${String(month).padStart(2, '0')}/${year}`); } } } }); const allAvailableMonths = Array.from(monthSet).sort((a, b) => { const [aMonth, aYear] = a.split('/'); const [bMonth, bYear] = b.split('/'); return new Date(bYear, bMonth - 1) - new Date(aYear, aMonth - 1); }); const monthSelect = document.getElementById('monthFilter'); const currentSelectedMonth = monthSelect.value; monthSelect.innerHTML = ''; allAvailableMonths.forEach(month => { const option = document.createElement('option'); option.value = month; option.textContent = month; monthSelect.appendChild(option); }); if (allAvailableMonths.includes(currentSelectedMonth)) { monthSelect.value = currentSelectedMonth; } else if (allAvailableMonths.length > 0) { monthSelect.value = allAvailableMonths[0]; } }
        function loadSampleData() { /* Sua função de dados de exemplo permanece a mesma */ salesData = [ { processo: 'VIDA,  AUXILIO-DOENÇA,  LOAS', cliente: 'Mario kopelkke', data: '02/06/2025', consultor: 'Augusto Teply', originalIndex: 1 }, { processo: 'AUXILIO-ACIDENTE', cliente: 'Diego armando mantelli', data: '02/06/2025', consultor: 'Thiago Pereira Gomes', originalIndex: 2 }, { processo: 'VIDA,  AÇÃO DE ACIDENTE DE TRÂNSITO', cliente: 'Valber Cardoso dos Santos', data: '02/06/2025', consultor: 'Kristin', originalIndex: 3 }, { processo: 'VIDA,  AUXILIO-ACIDENTE', cliente: 'Abnorlan daglison Costa dias', data: '02/06/2025', consultor: 'Jackeline Lima da Silva', originalIndex: 4 }, { processo: 'AUXILIO-DOENÇA', cliente: 'Willian Andrade Silva', data: '02/06/2025', consultor: 'Debora', originalIndex: 5 }, { processo: 'VIDA', cliente: 'Cliente Maio SV', data: '15/05/2025', consultor: 'Consultor Maio', originalIndex: 46 }, { processo: 'AUXILIO-DOENÇA', cliente: 'Cliente Maio Prev', data: '10/05/2025', consultor: 'Consultor Maio 2', originalIndex: 47 }, { processo: 'TERCEIRO DANO MATERIAL', cliente: 'Cliente Maio ST', data: '12/05/2025', consultor: 'Consultor Maio ST', originalIndex: 48 }, { processo: 'Dra Renata', cliente: 'Cliente Dra Renata Teste', data: '01/06/2025', consultor: 'Consultor Teste', originalIndex: 49 }, ]; populateMonthFilter(salesData); const monthSelect = document.getElementById('monthFilter'); const junExists = Array.from(monthSelect.options).some(opt => opt.value === '06/2025'); if (junExists) { monthSelect.value = '06/2025'; } else if (monthSelect.options.length > 0) { monthSelect.value = monthSelect.options[0].value; } updateDashboard(); lastUpdate = new Date(); updateLastUpdateTime(); }
        function getMonthSales() { const selectedMonthYear = document.getElementById('monthFilter').value; if (!selectedMonthYear) return []; const [filterMonth, filterYear] = selectedMonthYear.split('/'); return salesData.filter(sale => { if (!sale.data) return false; const [saleDay, saleMonth, saleYear] = sale.data.split('/'); return saleMonth === filterMonth && saleYear === filterYear; }); }
        function countValidProcessesInRow(sale) { const processosString = (sale.processo || '').toUpperCase(); return processosString.split(',').map(p => p.trim()).filter(p => p && p !== DRA_RENATA_STRING).length; }

        function updateDashboard() {
            if (salesData.length === 0 && document.getElementById('monthFilter').options.length === 0) {
                // Estado de carregamento inicial ou falha total
                document.getElementById('consultantRanking').innerHTML = `<div style="text-align: center; color: #6b7280; padding: 40px;"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top: 15px;">Carregando dados...</p></div>`;
                document.getElementById('recentSalesTable').innerHTML = `<tr><td colspan="4" style="text-align: center; color: #6b7280; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>`;
                return;
            }
            
            const monthSales = getMonthSales(); 
            
            updateProcessStats(monthSales); 
            updateConsultantRanking(monthSales); 
            updateMainStats(monthSales);  
            updateMonthSales(monthSales); 
            updateDailyProcessChart();
            
            const updateIndicator = document.getElementById('updateIndicator');
            if(updateIndicator) {
                updateIndicator.innerHTML = `<i class="fas fa-check-circle"></i> Dados atualizados!`;
                setTimeout(() => { updateIndicator.style.opacity = '0'; setTimeout(() => { updateIndicator.style.display = 'none'; }, 500); }, 2000);
            }
        }
        
        // --- FUNÇÕES DE ATUALIZAÇÃO DA UI (sem alterações significativas na lógica interna) ---
        function updateMainStats(monthSalesData) { const selectedMonthYear = document.getElementById('monthFilter').value; if (!selectedMonthYear) { document.getElementById('totalMonth').textContent = '-'; document.getElementById('monthLabel').textContent = 'Nenhum mês'; document.getElementById('dailyAverage').textContent = '-'; return; } const [monthStr, yearStr] = selectedMonthYear.split('/'); const selectedMonth = parseInt(monthStr); const selectedYear = parseInt(yearStr); const totalProcessosNoMes = currentMonthCounts.previdenciarios + currentMonthCounts.seguroTerceiro + currentMonthCounts.seguroVida + currentMonthCounts.outros; document.getElementById('totalMonth').textContent = totalProcessosNoMes; const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro']; document.getElementById('monthLabel').textContent = `${monthNames[selectedMonth - 1]} ${selectedYear}`; let maxDayInMonthWithData = 0; if (monthSalesData.length > 0) { monthSalesData.forEach(sale => { if (sale.data) { const parts = sale.data.split('/'); if (parts.length === 3) { const saleDay = parseInt(parts[0], 10); const saleMonth = parseInt(parts[1], 10); const saleYear = parseInt(parts[2], 10); if (saleMonth === selectedMonth && saleYear === selectedYear) { if (saleDay > maxDayInMonthWithData) { maxDayInMonthWithData = saleDay; } } } } }); } const daysToConsider = maxDayInMonthWithData > 0 ? maxDayInMonthWithData : 1; let averageProcessos = 0; if (totalProcessosNoMes > 0 && maxDayInMonthWithData > 0) { averageProcessos = totalProcessosNoMes / daysToConsider; } document.getElementById('dailyAverage').textContent = averageProcessos.toFixed(1); }
        function getNormalizedConsultantKey(fullName) { if (!fullName || typeof fullName !== 'string') return 'desconhecido'; return fullName.trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().split(' ')[0]; }
        function updateConsultantRanking(monthSales) { const consultantStats = {}; monthSales.forEach(sale => { const rawConsultantName = sale.consultor; if (!rawConsultantName || !rawConsultantName.trim()) { return; } const normalizedKey = getNormalizedConsultantKey(rawConsultantName); if (!consultantStats[normalizedKey]) { const displayName = rawConsultantName.trim().split(' ')[0]; const capitalizedDisplayName = displayName.charAt(0).toUpperCase() + displayName.slice(1).toLowerCase(); consultantStats[normalizedKey] = { name: capitalizedDisplayName, sales: 0 }; } consultantStats[normalizedKey].sales += countValidProcessesInRow(sale); }); const ranking = Object.values(consultantStats).sort((a, b) => b.sales - a.sales); let topConsultantName = '-'; if (ranking.length > 0 && ranking[0].sales > 0) { topConsultantName = ranking[0].name; } document.getElementById('topConsultant').textContent = topConsultantName; let html = ''; if (ranking.length > 0 && ranking.some(c => c.sales > 0)) { ranking.slice(0, 10).forEach((consultant, index) => { if(consultant.sales > 0) html += `<div class="ranking-item"><div class="consultant-info"><div class="rank-number">${index + 1}</div><div class="consultant-name">${consultant.name}</div></div><div class="sales-count">${consultant.sales}</div></div>`; }); } else { html = `<div style="text-align: center; color: #6b7280; padding: 20px;">Nenhum processo para o mês.</div>`; } document.getElementById('consultantRanking').innerHTML = html; }
        function updateProcessStats(monthSales) { const metas = { 'PREVIDENCIÁRIOS': 400, 'SEGURO TERCEIRO': 30, 'SEGURO DE VIDA': 90 }; let prevCount = 0; let svCount = 0; let outrosIndividuais = 0; const clientesST = new Set(); monthSales.forEach(sale => { const cliente = sale.cliente; const processosString = (sale.processo || '').toUpperCase(); const listaProcessos = processosString.split(',').map(p => p.trim()).filter(p => p); listaProcessos.forEach(proc => { if (proc === DRA_RENATA_STRING) { return; } let classificadoPrincipal = false; if (PREVIDENCIARIO_TYPES.includes(proc)) { prevCount++; classificadoPrincipal = true; } if (SEGURO_VIDA_TYPES.includes(proc)) { svCount++; classificadoPrincipal = true; } if (SEGURO_TERCEIRO_TYPES.includes(proc)) { if (cliente) clientesST.add(cliente); classificadoPrincipal = true; } if (!classificadoPrincipal && proc) { outrosIndividuais++; } }); }); const stCount = clientesST.size; currentMonthCounts = { previdenciarios: prevCount, seguroTerceiro: stCount, seguroVida: svCount, outros: outrosIndividuais }; const prevMeta = metas['PREVIDENCIÁRIOS']; const prevPercent = prevMeta > 0 ? Math.min(100, Math.round((prevCount / prevMeta) * 100)) : 0; document.getElementById('previdenciariosCount').textContent = prevCount; document.getElementById('previdenciariosGoal').textContent = `${prevCount}/${prevMeta}`; document.getElementById('previdenciariosPercent').textContent = prevPercent; const terMeta = metas['SEGURO TERCEIRO']; const terPercent = terMeta > 0 ? Math.min(100, Math.round((stCount / terMeta) * 100)) : 0; document.getElementById('seguroTerceiroCount').textContent = stCount; document.getElementById('seguroTerceiroGoal').textContent = `${stCount}/${terMeta}`; document.getElementById('seguroTerceiroPercent').textContent = terPercent; const vidaMeta = metas['SEGURO DE VIDA']; const vidaPercent = vidaMeta > 0 ? Math.min(100, Math.round((svCount / vidaMeta) * 100)) : 0; document.getElementById('seguroVidaCount').textContent = svCount; document.getElementById('seguroVidaGoal').textContent = `${svCount}/${vidaMeta}`; document.getElementById('seguroVidaPercent').textContent = vidaPercent; document.getElementById('outrosCount').textContent = outrosIndividuais; }
        function updateMonthSales(monthSales) { const sortedSales = [...monthSales].sort((a, b) => { if (!a.data || !b.data) return 0; const parseDate = (dateStr) => { const parts = dateStr.split('/'); if (parts.length === 3) { return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])); } return null; }; const dateAVal = parseDate(a.data); const dateBVal = parseDate(b.data); if (!dateAVal || !dateBVal || isNaN(dateAVal.getTime()) || isNaN(dateBVal.getTime())) { return 0; } if (dateBVal.getTime() !== dateAVal.getTime()) { return dateBVal.getTime() - dateAVal.getTime(); } else { return (b.originalIndex || 0) - (a.originalIndex || 0); } }); let html = ''; if (sortedSales.length > 0) { sortedSales.forEach(sale => { html += `<tr><td><span class="date-badge">${sale.data || '-'}</span></td><td>${sale.cliente || '-'}</td><td><span class="process-badge">${sale.processo || '-'}</span></td><td>${sale.consultor || '-'}</td></tr>`; }); } else { html = `<tr><td colspan="4" style="text-align: center; color: #6b7280; padding: 40px;">Nenhuma venda para o mês.</td></tr>`; } document.getElementById('recentSalesTable').innerHTML = html; }
        function updateLastUpdateTime() { if (lastUpdate) { document.getElementById('lastUpdateTime').textContent = lastUpdate.toLocaleTimeString('pt-BR'); } }
        
        // --- FUNÇÃO DO GRÁFICO ---
        function updateDailyProcessChart() { const today = new Date(); const currentYear = today.getFullYear(); const startDate = new Date(currentYear, 4, 1); const filteredData = salesData.filter(sale => { if (!sale.data) return false; const parts = sale.data.split('/'); if (parts.length !== 3) return false; const saleDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])); return !isNaN(saleDate.getTime()) && saleDate >= startDate && saleDate <= today; }); const dailyCounts = new Map(); filteredData.forEach(sale => { const dateKey = sale.data; const processCount = countValidProcessesInRow(sale); if (processCount > 0) { dailyCounts.set(dateKey, (dailyCounts.get(dateKey) || 0) + processCount); } }); const labels = []; const dataPoints = []; let currentDate = new Date(startDate); while(currentDate <= today) { const dateString = currentDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }); labels.push(dateString); const fullDateKey = currentDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }); dataPoints.push(dailyCounts.get(fullDateKey) || 0); currentDate.setDate(currentDate.getDate() + 1); } const ctx = document.getElementById('dailyProcessChart').getContext('2d'); if (dailyChartInstance) { dailyChartInstance.destroy(); } dailyChartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Número de Processos por Dia', data: dataPoints, backgroundColor: 'rgba(139, 92, 246, 0.2)', borderColor: '#8b5cf6', borderWidth: 3, pointBackgroundColor: '#8b5cf6', pointRadius: 4, pointHoverRadius: 6, tension: 0.3, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#6b7280', stepSize: 1 }, grid: { color: '#f3f4f6' } }, x: { ticks: { color: '#6b7280', maxRotation: 45, minRotation: 45 }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#6b46c1', titleFont: { size: 14, weight: 'bold' }, bodyFont: { size: 12 }, padding: 12, cornerRadius: 8, callbacks: { label: function(context) { return ` Processos: ${context.raw}`; } } } } } }); }

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', function() {
            const updateIndicator = document.getElementById('updateIndicator');
            if (updateIndicator) updateIndicator.style.display = 'flex';
            
            fetchSheetData(); 
            // loadSampleData();
            
            showSlide(currentSlide);
            startCarouselTimer(); // Inicia o carrossel automático

            autoUpdateInterval = setInterval(() => {
                if (isAutoUpdateActive) { 
                    if (updateIndicator) {
                        updateIndicator.style.display = 'flex';
                        updateIndicator.style.opacity = '1';
                        updateIndicator.innerHTML = `<i class="fas fa-sync-alt fa-spin"></i> Atualizando automaticamente...`;
                    }
                    fetchSheetData();
                }
            }, 30000); 
        });
    </script>
</body>
</html>
