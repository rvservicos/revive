<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fluxo Seguro de Vida ADM (Planilha Google)</title>
<style>
  :root{
    --bg:#0b1020; --panel:#121a35; --muted:#a9b1c6; --text:#e7ecff; --ok:#6ee7b7; --warn:#fde68a; --bad:#fca5a5; --info:#93c5fd; 
    --grad-1: linear-gradient(135deg,#22c1c3,#5d5fee);
    --grad-2: linear-gradient(135deg,#6a11cb,#2575fc);
    --grad-3: linear-gradient(135deg,#00c6ff,#0072ff);
    --grad-4: linear-gradient(135deg,#f093fb,#f5576c);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{padding:20px 24px;border-bottom:1px solid #243056;background:linear-gradient(90deg,#1d2546,transparent 60%)}
  h1{margin:0;font-weight:800;letter-spacing:.2px}
  .wrap{padding:24px;display:grid;gap:24px}
  .legend{display:flex;gap:12px;flex-wrap:wrap;align-items:center;color:var(--muted);font-size:14px}
  .chip{padding:.25rem .6rem;border-radius:999px;background:#1a2446;border:1px solid #2a366a}
  .panels{display:grid;grid-template-columns:1fr;gap:24px}
  @media (min-width:1100px){ .panels{grid-template-columns:1.2fr .8fr} }

  /* Card */
  .card{background:var(--panel);border:1px solid #1f2a52;border-radius:18px;padding:18px 18px 22px;box-shadow:0 10px 40px rgba(0,0,0,.25)}
  .card h2{margin:0 0 12px 0;font-size:18px;font-weight:800;letter-spacing:.3px}
  .total{font-size:13px;color:var(--muted)}

  /* Flow canvas (CSS Grid) */
  .flow{
    position:relative;
    display:grid;
    gap:18px;
    grid-template-columns: repeat(12, minmax(60px,1fr));
    grid-auto-rows: 92px;
    padding:8px;
    overflow:auto;
    min-height:560px;
  }

  /* Node styles */
  .node{
    position:relative;
    border-radius:16px;
    background:#0f1633;
    border:1px solid #253163;
    padding:10px 12px 12px;
    box-shadow:0 6px 20px rgba(0,0,0,.25);
    display:flex;align-items:center;justify-content:space-between;gap:8px;
  }
  .node.badge-left{justify-content:flex-start;gap:10px}
  .title{font-weight:800;font-size:14px;letter-spacing:.2px}
  .subtitle{font-size:12px;color:var(--muted);margin-top:2px}
  .count{
    font-weight:900;min-width:34px;height:34px;border-radius:50%;
    display:grid;place-items:center;background:#1b244b;border:1px solid #2d3b77
  }
  .gradient{background:var(--grad-1);border:0}
  .gradient.alt{background:var(--grad-2)}
  .gradient.ind{background:var(--grad-3)}
  .gradient.warn{background:var(--grad-4)}
  .count.pill{border-radius:999px;padding:0 12px;min-width:52px;height:36px}

  /* Arrow connectors */
  .arrow{
    position:absolute;pointer-events:none;border-top:2px dashed #3a478a;opacity:.9
  }
  /* Helper to draw from one grid cell to another by data-attrs */
  .arrow[data-from][data-to]{}

  /* Status color hints */
  .node.ok{box-shadow:0 8px 20px rgba(110,231,183,.15)}
  .node.warn{box-shadow:0 8px 20px rgba(253,230,138,.15)}
  .node.bad{box-shadow:0 8px 20px rgba(252,165,165,.15)}
  .node.info{box-shadow:0 8px 20px rgba(147,197,253,.15)}

  /* Tiny list on the right card */
  .list{display:grid;gap:10px;margin-top:8px}
  .row{display:flex;justify-content:space-between;align-items:center;background:#0e1530;border:1px solid #253163;padding:10px 12px;border-radius:12px}
  .row .k{font-weight:700}
  .muted{color:var(--muted)}
  a, a:visited{color:#a5b4fc}
  .foot{margin-top:12px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <header>
    <h1>Fluxo Seguro de Vida ADM (dados ao vivo da Planilha)</h1>
  </header>

  <div class="wrap">
    <div class="legend">
      <span class="chip">Atualiza automaticamente da planilha</span>
      <span class="chip">Arraste horizontalmente se necessário</span>
      <span class="chip">Clique para recarregar: <a id="reload" href="#">Recarregar</a></span>
    </div>

    <div class="panels">
      <!-- Painel principal (Fluxo Despachado) -->
      <section class="card">
        <h2 id="titulo-desp">Fluxo – DESPACHADOS</h2>
        <div class="total muted" id="total-desp">Carregando...</div>

        <!-- Canvas de fluxo -->
        <div class="flow" id="flow">
          <!-- os nós são preenchidos pelo JS -->
        </div>
      </section>

      <!-- Painel à direita (Não Despachado + resumo) -->
      <aside class="card">
        <h2>Não Despachado</h2>
        <div class="total muted" id="total-nd">Carregando...</div>
        <div class="list" id="lista-nd"></div>
        <div class="foot">
          Fonte: <span id="sheet-url"></span>
        </div>
      </aside>
    </div>
  </div>

<script>
/* ===================== CONFIGURAÇÃO ===================== */
const SHEET_ID = "1z6ypJ_f1vIT4Z_jQjOp9qO5q1g0ygJfOhAh7Nr50eek";
const GID = "178602434";
const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json`;
document.getElementById('sheet-url').textContent = `docs.google.com/spreadsheets/d/${SHEET_ID}`;

/* Nomes de linhas esperados (pode ajustar aqui se mudar na planilha) */
const LABELS = {
  despachadoBlock: "DESPACHADO",
  naoDespachadoBlock: "NÃO DESPACHADO",
  statuses: [
    "AGUARDANDO APROVAÇÃO",
    "AGUARDANDO PAGAMENTO",
    "ARQUIVADO",
    "NEGADO",
    "COMPLETO",
    "EM TRATAMENTO",
    "EXTERNO",
    "INDENIZADO",
    "JUNTA",
    "PENDÊNCIA EXTERNA",
    "PERÍCIA",
    "REANÁLISE"
  ]
};

// Layout: posição dos nós (coluna/linha) no grid 12xN
const LAYOUT = [
  {key:"COMPLETO",          area:[1,2, 3,3],  class:"gradient",         title:"COMPLETO"},
  {key:"EXTERNO",           area:[4,2, 6,3],  class:"",                 title:"EXTERNO"},
  {key:"AGUARDANDO APROVAÇÃO", area:[7,2, 9,3], class:"",               title:"AGUARDANDO APROVAÇÃO"},
  {key:"PERÍCIA",           area:[10,1, 12,2], class:"warn",            title:"PERÍCIA"},
  {key:"EM TRATAMENTO",     area:[10,2, 12,3], class:"warn",            title:"EM TRATAMENTO"},
  {key:"NEGADO",            area:[10,3, 12,4], class:"bad",             title:"NEGADO"},
  {key:"AGUARDANDO PAGAMENTO", area:[10,4, 12,5], class:"ok",           title:"AGUARDANDO PAGAMENTO"},
  {key:"REANÁLISE",         area:[13,3, 15,4], class:"gradient alt",    title:"REANÁLISE"},
  {key:"INDENIZADO",        area:[13,4, 15,5], class:"gradient ind",    title:"INDENIZADO"},
  {key:"JUNTA",             area:[16,3, 18,4], class:"gradient",        title:"JUNTA MÉDICA"},
  {key:"PENDÊNCIA EXTERNA", area:[7,4, 9,5],   class:"warn",            title:"PENDÊNCIA EXTERNA"},
  {key:"ARQUIVADO",         area:[4,6, 6,7],   class:"gradient warn",   title:"ARQUIVADO"},
  {key:"DESPACHADO_TOTAL",  area:[2,1, 4,2],   class:"gradient alt",    title:"DESPACHADO"}
];

// Conexões (do -> para) apenas para desenhar o fluxo
const EDGES = [
  ["COMPLETO","EXTERNO"],
  ["EXTERNO","AGUARDANDO APROVAÇÃO"],
  ["AGUARDANDO APROVAÇÃO","PERÍCIA"],
  ["AGUARDANDO APROVAÇÃO","EM TRATAMENTO"],
  ["AGUARDANDO APROVAÇÃO","NEGADO"],
  ["AGUARDANDO APROVAÇÃO","AGUARDANDO PAGAMENTO"],
  ["EM TRATAMENTO","REANÁLISE"],
  ["NEGADO","REANÁLISE"],
  ["AGUARDANDO PAGAMENTO","INDENIZADO"],
  ["REANÁLISE","JUNTA"],
  ["INDENIZADO","JUNTA"]
];

/* ===================== FUNÇÕES ===================== */
function parseGViz(jsonText){
  // gviz retorna algo como: google.visualization.Query.setResponse({...});
  const match = jsonText.match(/setResponse\(([\s\S]*?)\);?$/);
  if(!match) throw new Error("Não foi possível interpretar a resposta da planilha.");
  const data = JSON.parse(match[1]);
  const rows = data.table.rows.map(r => (r.c||[]).map(c => (c? c.v : "")));
  return rows;
}

function isNumberLike(v){
  return typeof v === "number" || (typeof v === "string" && v.trim().match(/^-?\d+(\.\d+)?$/));
}

function buildMaps(rows){
  let section = null;
  const maps = {
    DESPACHADO: {total:0, counts:{}},
    "NÃO DESPACHADO": {total:0, counts:{}}
  };
  for(const row of rows){
    const cells = row.map(x => (x||"").toString().trim());
    if(!cells.length) continue;

    // Detecta troca de seção
    if (cells.some(t => t.toUpperCase() === LABELS.despachadoBlock)) section = "DESPACHADO";
    if (cells.some(t => t.toUpperCase() === LABELS.naoDespachadoBlock)) section = "NÃO DESPACHADO";

    // total da linha "DESPACHADO" / "NÃO DESPACHADO"
    if(section && cells.some(t => t.toUpperCase() === LABELS.despachadoBlock)){
      const num = cells.filter(isNumberLike).pop();
      if(num!=null) maps["DESPACHADO"].total = Number(num);
    }
    if(section && cells.some(t => t.toUpperCase() === LABELS.naoDespachadoBlock)){
      const num = cells.filter(isNumberLike).pop();
      if(num!=null) maps["NÃO DESPACHADO"].total = Number(num);
    }

    // captura de cada status
    for(const status of LABELS.statuses){
      if (cells.some(t => t.toUpperCase() === status)){
        const num = cells.filter(isNumberLike).pop();
        if(num!=null){
          const bucket = section || "DESPACHADO"; // por segurança
          maps[bucket].counts[status] = Number(num);
        }
      }
    }
  }
  return maps;
}

function gridStyle(area){
  // [colStart,rowStart, colEnd,rowEnd] em grid de 12 colunas
  const [cs,rs, ce,re] = area;
  return `grid-column:${cs} / ${ce}; grid-row:${rs} / ${re};`;
}

function renderFlow(maps){
  const flow = document.getElementById("flow");
  flow.innerHTML = "";

  // monta objetos de valores (default 0)
  const v = (k)=> (maps.DESPACHADO.counts[k]??0);

  // Nó "DESPACHADO TOTAL"
  const totalDes = maps.DESPACHADO.total || Object.values(maps.DESPACHADO.counts).reduce((a,b)=>a+b,0);

  const nodes = {};
  for(const item of LAYOUT){
    const key = item.key;
    const count = (key==="DESPACHADO_TOTAL") ? totalDes : v(key);
    const el = document.createElement("div");
    el.className = `node ${item.class||""} ${["EM TRATAMENTO","NEGADO"].includes(key)?"warn":""}`;
    el.style = gridStyle(item.area);
    el.innerHTML = `
      <div>
        <div class="title">${item.title}</div>
      </div>
      <div class="count ${key==="DESPACHADO_TOTAL" ? "pill": ""}">${count}</div>
    `;
    flow.appendChild(el);
    nodes[key] = el;
  }

  // desenha setas (simples linhas horizontais/verticais)
  EDGES.forEach(([from,to])=>{
    const a = nodes[from].getBoundingClientRect();
    const b = nodes[to].getBoundingClientRect();
    const parent = flow.getBoundingClientRect();

    const y = Math.round((a.top + a.bottom)/2 - parent.top);
    const x1 = Math.round(a.right - parent.left);
    const x2 = Math.round(b.left - parent.left);

    const line = document.createElement("div");
    line.className = "arrow";
    line.style = `left:${x1}px; top:${y}px; width:${Math.max(12, x2-x1-6)}px;`;
    flow.appendChild(line);
  });

  document.getElementById("total-desp").textContent = `Total despachados: ${totalDes}`;
}

function renderNaoDespachado(maps){
  const box = document.getElementById("lista-nd");
  const counts = maps["NÃO DESPACHADO"].counts;
  const total = maps["NÃO DESPACHADO"].total || Object.values(counts).reduce((a,b)=>a+b,0);
  document.getElementById("total-nd").textContent = `Total não despachado: ${total}`;

  const order = [
    "COMPLETO","EXTERNO","AGUARDANDO APROVAÇÃO","AGUARDANDO PAGAMENTO",
    "ARQUIVADO","NEGADO","EM TRATAMENTO","INDENIZADO","JUNTA","PENDÊNCIA EXTERNA","PERÍCIA","REANÁLISE"
  ];
  box.innerHTML = "";
  order.forEach(k=>{
    const val = counts[k] ?? 0;
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `<span class="k">${k}</span><span class="count">${val}</span>`;
    box.appendChild(row);
  });
}

/* ===================== CARREGAMENTO ===================== */
async function load(){
  try{
    const res = await fetch(GVIZ_URL, {cache:"no-store"});
    const txt = await res.text();
    const rows = parseGViz(txt);
    const maps = buildMaps(rows);

    renderFlow(maps);
    renderNaoDespachado(maps);
  }catch(err){
    console.error(err);
    alert("Não foi possível carregar os dados da planilha. Verifique se o acesso público está habilitado.");
  }
}

document.getElementById("reload").addEventListener("click",(e)=>{e.preventDefault();load();});
window.addEventListener("load", load);
window.addEventListener("resize", ()=>{ /* redesenha setas após resize */ load(); });
</script>
</body>
</html>
